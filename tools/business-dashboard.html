<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üì¶ KharchaSaathi ‚Äî Business Manager</title>
  <meta name="theme-color" content="#0f172a" />
  <link rel="icon" href="/favicon.png" />
  <link rel="apple-touch-icon" href="/favicon.png" />
  <link rel="stylesheet" href="/css/base.css" />
  <link rel="stylesheet" href="/css/layout.css" />
  <link rel="stylesheet" href="/css/components.css" />
  <style>
    :root{
      --ks-bg-dark:#020617;
      --ks-bg-card:#020617;
      --ks-bg-soft:#0b1120;
      --ks-accent:#38bdf8;
      --ks-accent-soft:#0ea5e9;
      --ks-border:#1e293b;
      --ks-text:#e5e7eb;
      --ks-text-soft:#9ca3af;
    }
    body{
      margin:0;
      padding:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:radial-gradient(circle at top,#0f172a 0,#020617 55%,#000 100%);
      color:var(--ks-text);
      min-height:100vh;
    }
    .topbar{
      position:sticky;
      top:0;
      z-index:50;
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:10px 16px;
      background:linear-gradient(to right,#020617cc,#020617f0,#020617cc);
      backdrop-filter:blur(18px);
      border-bottom:1px solid #1f2937;
    }
    .topbar h1{
      margin:0;
      font-size:20px;
      letter-spacing:.08em;
      text-transform:uppercase;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .topbar-logo{
      width:30px;
      height:30px;
      border-radius:999px;
      background:radial-gradient(circle at 30% 20%,#22d3ee,#0369a1 45%,#0f172a 70%);
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 0 18px rgba(56,189,248,.7);
      flex-shrink:0;
    }
    .topbar-logo span{
      font-size:18px;
      color:#f9fafb;
    }
    .topbar span#emailTag{
      padding:3px 10px;
      border-radius:999px;
      font-size:12px;
      background:rgba(15,23,42,.7);
      border:1px solid rgba(148,163,184,.5);
      color:#e5e7eb;
    }
    .simple-clock{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      font-size:11px;
      line-height:1.1;
      color:#9ca3af;
    }
    .clock-line{font-variant-numeric:tabular-nums;}
    .clock-line.small{font-size:11px;}
    .theme-btn, .small-btn{
      border:none;
      cursor:pointer;
      border-radius:999px;
      padding:6px 12px;
      font-size:12px;
      font-weight:500;
      background:#0f172a;
      color:#e5e7eb;
      border:1px solid #1e293b;
      box-shadow:0 4px 10px rgba(15,23,42,.7);
      transition:.2s;
    }
    .theme-btn:hover,.small-btn:hover{
      background:#111827;
      transform:translateY(-1px);
    }
    .topbar-right{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    #logoutBtn{
      background:#ef4444;
      border-color:#b91c1c;
      box-shadow:0 6px 16px rgba(239,68,68,.5);
    }
    #logoutBtn:hover{
      background:#dc2626;
    }
    #universalBar{
      padding:10px 12px 4px;
      border-bottom:1px solid #111827;
      background:radial-gradient(circle at top,#0b1120,#020617 55%);
    }
    .uni-row{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(210px,1fr));
      gap:10px;
    }
    .uni-card{
      position:relative;
      padding:10px 12px;
      border-radius:14px;
      background:linear-gradient(135deg,rgba(15,23,42,.95),rgba(15,23,42,.65));
      border:1px solid rgba(30,64,175,.4);
      box-shadow:0 12px 32px rgba(15,23,42,.9);
      overflow:hidden;
    }
    .uni-card.main{
      grid-column:span 2;
      min-width:240px;
    }
    .uni-title{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.18em;
      color:#9ca3af;
      margin-bottom:4px;
    }
    .uni-value{
      font-size:22px;
      font-weight:700;
      color:#e5e7eb;
    }
    .uni-value.small{font-size:18px;}
    .uni-sub{
      margin-top:4px;
      display:grid;
      grid-template-columns:auto 1fr auto 1fr;
      gap:4px 6px;
      font-size:11px;
      align-items:center;
      color:#9ca3af;
    }
    .uni-exp-label{opacity:.8;}
    .uni-exp-value{color:#f97316;font-weight:600;}
    .uni-chip{
      display:inline-flex;
      align-items:center;
      padding:3px 7px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.4);
      font-size:10px;
      color:#9ca3af;
    }
    .collect-btn{
      position:absolute;
      right:10px;
      top:10px;
      padding:4px 8px;
      font-size:11px;
      border-radius:999px;
      border:none;
      cursor:pointer;
      background:#22c55e;
      color:#022c22;
      font-weight:600;
      box-shadow:0 10px 18px rgba(22,163,74,.65);
      transition:.18s;
    }
    .collect-btn:hover{
      transform:translateY(-1px) scale(1.02);
      background:#16a34a;
    }
    .tabs{
      display:flex;
      gap:6px;
      padding:10px 10px 6px;
      overflow-x:auto;
      border-bottom:1px solid #0f172a;
      background:linear-gradient(to right,#020617,#020617bb,#020617);
    }
    .tab{
      padding:6px 12px;
      border-radius:999px;
      font-size:12px;
      cursor:pointer;
      white-space:nowrap;
      color:#9ca3af;
      border:1px solid transparent;
      transition:.18s;
      display:flex;
      align-items:center;
      gap:4px;
    }
    .tab.active{
      background:radial-gradient(circle at top,#0ea5e9,#0369a1);
      color:#f9fafb;
      border-color:#0ea5e9;
      box-shadow:0 8px 18px rgba(56,189,248,.45);
    }
    .section{
      display:none;
      padding:14px 12px 24px;
      max-width:1100px;
      margin:0 auto;
    }
    .section.active{display:block;}
    table{
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      font-size:12px;
      border-radius:12px;
      overflow:hidden;
      background:rgba(15,23,42,.9);
      box-shadow:0 10px 30px rgba(15,23,42,.85);
    }
    thead{
      background:linear-gradient(to right,#0f172a,#020617);
      color:#9ca3af;
    }
    th,td{
      padding:7px 8px;
      border-bottom:1px solid rgba(31,41,55,.8);
      text-align:left;
    }
    tbody tr:nth-child(even){
      background:rgba(15,23,42,.92);
    }
    tbody tr:nth-child(odd){
      background:rgba(15,23,42,.8);
    }
    tfoot td{
      background:#020617;
      font-weight:600;
    }
    .status-credit{
      display:inline-block;
      padding:3px 8px;
      border-radius:999px;
      background:#f97316;
      color:#111827;
      font-size:11px;
      font-weight:600;
    }
    .status-paid{
      display:inline-block;
      padding:3px 8px;
      border-radius:999px;
      background:#22c55e;
      color:#022c22;
      font-size:11px;
      font-weight:600;
    }
    #tabSummaryBar{
      margin:10px auto 0;
      max-width:1100px;
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      text-align:center;
      background:#022c22;
      color:#bbf7d0;
      box-shadow:0 8px 22px rgba(6,95,70,.7);
    }
    @media(max-width:768px){
      .topbar{flex-direction:column;align-items:flex-start;gap:6px;}
      .topbar-right{width:100%;justify-content:space-between;}
      .uni-card.main{grid-column:span 1;}
    }
  </style>
</head>

<body>
<script>
  const qs = s => document.querySelector(s);
  const qsa = s => Array.from(document.querySelectorAll(s));
</script>

<div class="topbar">
  <h1>
    <div class="topbar-logo"><span>‚Çπ</span></div>
    KHARCHASAATHI
  </h1>
  <div class="topbar-right">
    <span id="emailTag">Checking login‚Ä¶</span>
    <div class="simple-clock">
      <span id="clockTime" class="clock-line">--:--:--</span>
      <span id="clockDate" class="clock-line small">--</span>
    </div>
    <button id="themeBtn" class="theme-btn">üåô</button>
    <a class="small-btn" href="/index.html">üè† Home</a>
    <button id="logoutBtn" class="small-btn">üîì Logout</button>
  </div>
</div>

<div id="universalBar">
  <div class="uni-row">
    <div class="uni-card main">
      <button class="collect-btn" data-collect="net">‚Çπ Collect</button>
      <div class="uni-title">Net Profit (Sale + Service ‚àí Expenses)</div>
      <div class="uni-value" id="unNetProfit">‚Çπ0</div>
      <div class="uni-sub">
        <span>Sale:</span><span id="unSaleProfit">‚Çπ0</span>
        <span>Service:</span><span id="unServiceProfit">‚Çπ0</span>
        <span class="uni-exp-label">Exp:</span>
        <span id="unExpenses" class="uni-exp-value">‚Çπ0</span>
      </div>
    </div>

    <div class="uni-card">
      <button class="collect-btn" data-collect="stock">‚Çπ Collect</button>
      <div class="uni-title">Stock Investment (Sold Items)</div>
      <div class="uni-value small" id="unStockInv">‚Çπ0</div>
      <div class="uni-sub">
        <span class="uni-chip">Sold stock</span>
      </div>
    </div>

    <div class="uni-card">
      <button class="collect-btn" data-collect="service">‚Çπ Collect</button>
      <div class="uni-title">Service Investment (Completed)</div>
      <div class="uni-value small" id="unServiceInv">‚Çπ0</div>
      <div class="uni-sub">
        <span class="uni-chip">Closed jobs</span>
      </div>
    </div>

    <div class="uni-card">
      <div class="uni-title">Pending Credit Sales</div>
      <div class="uni-value small" id="unCreditSales">‚Çπ0</div>
      <div class="uni-sub">
        <span class="uni-chip">To be collected</span>
      </div>
    </div>
  </div>
</div>

<div id="tabSummaryBar">Profit: +‚Çπ0</div>

<!-- FIXED TAB ORDER (Credit History after Expenses) -->
<div class="tabs" role="tablist">
  <div class="tab active" data-tab="types">üìÅ Types</div>
  <div class="tab" data-tab="stock">üì¶ Stock</div>
  <div class="tab" data-tab="sales">üìà Sales</div>
  <div class="tab" data-tab="wanting">üõí Wanting</div>
  <div class="tab" data-tab="service">üõ† Service</div>
  <div class="tab" data-tab="expenses">üí∏ Expenses</div>
  <div class="tab" data-tab="creditHistory">üßæ Credit History</div>
  <div class="tab" data-tab="dashboard">üìä Dashboard</div>
  <div class="tab" data-tab="collection">ü™ô Collection</div>
</div>
<!-- =============== TYPES =============== -->
<section id="types" class="section active">
  <h3>üóÇ Manage Item Types</h3>
  <div class="row-inline" style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;">
    <input id="typeName" type="text" placeholder="Add new type"
      style="flex:1;min-width:160px;padding:8px 10px;border-radius:12px;border:1px solid #1e293b;background:#020617;color:#e5e7eb;">
    <button id="addTypeBtn" class="small-btn">Add</button>
    <button id="clearTypesBtn" class="small-btn">Clear All</button>
  </div>
  <ul id="typeList" style="margin-top:10px;padding-left:18px;font-size:13px;"></ul>
</section>

<!-- =============== STOCK =============== -->
<section id="stock" class="section">
  <h3>üì¶ Current Stock</h3>

  <div class="row-inline" style="margin-top:6px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
    <label>Low Stock:</label>
    <input id="globalLimit" type="number" placeholder="2"
      style="width:90px;padding:6px 8px;border-radius:10px;border:1px solid #1e293b;background:#020617;color:#e5e7eb;">
    <button id="setLimitBtn" class="small-btn">Set</button>
    <button id="clearStockBtn" class="small-btn" style="background:#ef4444;border-color:#b91c1c;">Clear All</button>
  </div>

  <div class="row-inline" style="margin-top:12px;display:flex;flex-wrap:wrap;gap:8px;">
    <input id="pdate" type="date"
      style="padding:6px 8px;border-radius:10px;border:1px solid #1e293b;background:#020617;color:#e5e7eb;">
    <select id="ptype"
      style="padding:6px 8px;border-radius:10px;border:1px solid #1e293b;background:#020617;color:#e5e7eb;"></select>
    <input id="pname" type="text" placeholder="Product"
      style="padding:6px 8px;border-radius:10px;border:1px solid #1e293b;background:#020617;color:#e5e7eb;min-width:140px;">
    <input id="pqty" type="number" placeholder="Qty"
      style="width:80px;padding:6px 8px;border-radius:10px;border:1px solid #1e293b;background:#020617;color:#e5e7eb;">
    <input id="pcost" type="number" placeholder="Cost ‚Çπ"
      style="width:100px;padding:6px 8px;border-radius:10px;border:1px solid #1e293b;background:#020617;color:#e5e7eb;">
    <button id="addStockBtn" class="small-btn">Add</button>
  </div>

  <div style="margin-top:12px; display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
    <b>Filter Type:</b>
    <select id="filterType"
      style="padding:6px 8px;border-radius:10px;border:1px solid #1e293b;background:#020617;color:#e5e7eb;">
      <option value="all">All</option>
    </select>
    <input id="productSearch" placeholder="Search product..."
      style="padding:6px 10px;border-radius:12px;border:1px solid #1e293b;background:#020617;color:#e5e7eb;min-width:160px;">
  </div>

  <div id="stockInvBox"
    style="margin-top:10px;padding:10px;background:#0b1120;border-radius:12px;border:1px solid #facc15;max-width:280px;margin-left:auto;font-weight:600;font-size:13px;">
    üì¶ Stock Investment (Before Sale):
    <span id="stockInvValue" style="color:#fbbf24;">‚Çπ0</span>
  </div>

  <table id="stockTable" style="margin-top:10px;">
    <thead>
      <tr>
        <th>Date</th>
        <th>Type</th>
        <th>Product</th>
        <th>Qty</th>
        <th>Sold</th>
        <th>Remain</th>
        <th>Alert</th>
        <th>Limit</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<!-- =============== SALES =============== -->
<section id="sales" class="section">
  <h3>üí∞ Sales & Profit</h3>
  <div class="row-inline" style="margin:10px 0;display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
    <label>Date:</label>
    <input id="saleDate" type="date"
      style="padding:6px 8px;border-radius:10px;border:1px solid #1e293b;background:#020617;color:#e5e7eb;">
    <label style="margin-left:4px">Filter Type:</label>
    <select id="saleType"
      style="padding:6px 8px;border-radius:10px;border:1px solid #1e293b;background:#020617;color:#e5e7eb;">
      <option value="all">All Types</option>
    </select>
    <button id="filterSalesBtn" class="small-btn" style="margin-left:4px">Filter</button>
    <button id="clearSalesBtn" class="small-btn"
      style="background:#c62828;color:#fff;border-color:#991b1b;margin-left:8px">üóëÔ∏è Clear All</button>
  </div>

  <table id="salesTable">
    <thead>
      <tr>
        <th>Date</th>
        <th>Type</th>
        <th>Product</th>
        <th>Qty</th>
        <th>Price</th>
        <th>Total</th>
        <th>Profit</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody></tbody>
    <tfoot>
      <tr>
        <td colspan="5" style="text-align:right">Total:</td>
        <td id="salesTotal">0</td>
        <td id="profitTotal">0</td>
        <td></td>
      </tr>
    </tfoot>
  </table>
</section>

<!-- =============== WANTING =============== -->
<section id="wanting" class="section">
  <h3>üõí Wanting List</h3>
  <div class="want-form" style="margin-bottom:10px;display:flex;gap:8px;flex-wrap:wrap;">
    <select id="wantType"
      style="padding:6px 8px;border-radius:10px;border:1px solid #1e293b;background:#020617;color:#e5e7eb;"></select>
    <input id="wantName" type="text" placeholder="Product"
      style="padding:6px 8px;border-radius:10px;border:1px solid #1e293b;background:#020617;color:#e5e7eb;min-width:140px;">
    <input id="wantNote" type="text" placeholder="Note"
      style="padding:6px 8px;border-radius:10px;border:1px solid #1e293b;background:#020617;color:#e5e7eb;min-width:160px;">
    <button id="addWantBtn" class="small-btn">Add</button>
    <button id="clearWantBtn" class="small-btn">Clear</button>
    <button id="printWantBtn" class="small-btn">Print</button>
  </div>

  <table id="wantingTable">
    <thead>
      <tr>
        <th>Date</th>
        <th>Type</th>
        <th>Product</th>
        <th>Note</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<!-- =============== SERVICE =============== -->
<section id="service" class="section">
  <h3>üõ† Service / Repair Manager</h3>
  <div class="row-inline"
    style="margin:10px 0;align-items:center;gap:8px;display:flex;flex-wrap:wrap;">
    <input id="svcReceivedDate" type="date"
      style="width:160px;padding:6px 8px;border-radius:10px;border:1px solid #1e293b;background:#020617;color:#e5e7eb;">
    <input id="svcCustomer" type="text" placeholder="Customer name"
      style="min-width:160px;padding:6px 8px;border-radius:10px;border:1px solid #1e293b;background:#020617;color:#e5e7eb;">
    <input id="svcPhone" type="text" placeholder="Phone Number"
      style="width:140px;padding:6px 8px;border-radius:10px;border:1px solid #1e293b;background:#020617;color:#e5e7eb;">
    <select id="svcItemType"
      style="width:120px;padding:6px 8px;border-radius:10px;border:1px solid #1e293b;background:#020617;color:#e5e7eb;">
      <option value="Mobile">Mobile</option>
      <option value="Laptop">Laptop</option>
      <option value="Other">Other</option>
    </select>
    <input id="svcModel" type="text" placeholder="Model"
      style="min-width:130px;padding:6px 8px;border-radius:10px;border:1px solid #1e293b;background:#020617;color:#e5e7eb;">
    <input id="svcProblem" type="text" placeholder="Problem / Complaint"
      style="min-width:220px;padding:6px 8px;border-radius:10px;border:1px solid #1e293b;background:#020617;color:#e5e7eb;">
    <input id="svcAdvance" type="number" placeholder="Advance ‚Çπ (0)"
      style="width:120px;padding:6px 8px;border-radius:10px;border:1px solid #1e293b;background:#020617;color:#e5e7eb;">
    <button id="addServiceBtn" class="small-btn">Add Job</button>
  </div>

  <div class="flex-row"
    style="margin:8px 0;display:flex;gap:10px;flex-wrap:wrap;">
    <div class="card"
      style="flex:1;min-width:120px;padding:8px 10px;border-radius:14px;background:#0b1120;border:1px solid #1e293b;">
      <small>Pending</small>
      <div id="svcPendingCount" style="font-size:18px;font-weight:700;">0</div>
    </div>
    <div class="card"
      style="flex:1;min-width:120px;padding:8px 10px;border-radius:14px;background:#022c22;border:1px solid #16a34a;">
      <small>Completed</small>
      <div id="svcCompletedCount" style="font-size:18px;font-weight:700;">0</div>
    </div>
    <div class="card"
      style="flex:1;min-width:160px;padding:8px 10px;border-radius:14px;background:#0b1120;border:1px solid #f97316;">
      <small>Total Repair Profit</small>
      <div id="svcTotalProfit" style="font-size:18px;font-weight:700;">‚Çπ0</div>
    </div>
  </div>

  <h4>Pending / Active Jobs</h4>
  <table id="svcTable">
    <thead>
      <tr>
        <th>Job ID</th>
        <th>Received</th>
        <th>Customer</th>
        <th>Phone</th>
        <th>Item</th>
        <th>Model</th>
        <th>Problem</th>
        <th>Status</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <button id="clearServiceBtn"
    class="small-btn"
    style="background:#b71c1c;color:white;margin:10px 0;border-color:#7f1d1d;">
    üóëÔ∏è Clear All Jobs
  </button>

  <h4 style="margin-top:14px">Completed / History</h4>
  <table id="svcHistoryTable">
    <thead>
      <tr>
        <th>Job ID</th>
        <th>Received</th>
        <th>Completed</th>
        <th>Customer</th>
        <th>Item</th>
        <th>Invest</th>
        <th>Paid</th>
        <th>Profit</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div style="max-width:520px;margin:14px auto;">
    <canvas id="svcPie" height="150"></canvas>
  </div>
</section>

<!-- =============== EXPENSES =============== -->
<section id="expenses" class="section">
  <h3>üßæ Expenses</h3>
  <div class="row-inline" style="margin-bottom:8px;display:flex;gap:8px;flex-wrap:wrap;">
    <input id="expDate" type="date" onfocus="if(!this.value)this.value=todayDate()"
      style="padding:6px 8px;border-radius:10px;border:1px solid #1e293b;background:#020617;color:#e5e7eb;">
    <input id="expCat" type="text" placeholder="Category"
      style="min-width:140px;padding:6px 8px;border-radius:10px;border:1px solid #1e293b;background:#020617;color:#e5e7eb;">
    <input id="expAmount" type="number" placeholder="Amount"
      style="width:120px;padding:6px 8px;border-radius:10px;border:1px solid #1e293b;background:#020617;color:#e5e7eb;">
    <input id="expNote" type="text" placeholder="Note"
      style="min-width:200px;padding:6px 8px;border-radius:10px;border:1px solid #1e293b;background:#020617;color:#e5e7eb;">
    <button id="addExpenseBtn" class="small-btn">Add Expense</button>
    <button id="clearExpensesBtn" class="small-btn" style="background:#b91c1c;border-color:#7f1d1d;">Clear All</button>
  </div>

  <table id="expensesTable">
    <thead>
      <tr>
        <th>Date</th>
        <th>Category</th>
        <th>Amount</th>
        <th>Note</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
    <tfoot>
      <tr>
        <td colspan="2" style="text-align:right">Total:</td>
        <td id="expTotal">0</td>
        <td></td><td></td>
      </tr>
    </tfoot>
  </table>
</section>

<!-- =============== NEW: CREDIT HISTORY SECTION =============== -->
<section id="creditHistory" class="section">
  <h3>üßæ Credit History (Sales + Service)</h3>

  <div class="credit-grid">
    <!-- SALES CREDIT PANEL -->
    <div class="credit-card">
      <div class="credit-header">
        <div>
          <div class="credit-title">Sales Credit</div>
          <small class="credit-sub">Pending & Collected from Sales</small>
        </div>
      </div>

      <h4 class="credit-subtitle">Pending Credit (Sales)</h4>
      <table id="creditSalesPending">
        <thead>
          <tr>
            <th>Date</th>
            <th>Customer / Product</th>
            <th>Amount</th>
            <th>Goto</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <h4 class="credit-subtitle" style="margin-top:14px;">Collected Credit (Sales)</h4>
      <table id="creditSalesCollected">
        <thead>
          <tr>
            <th>Date</th>
            <th>Customer / Product</th>
            <th>Collected</th>
            <th>Goto</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- SERVICE CREDIT PANEL -->
    <div class="credit-card">
      <div class="credit-header">
        <div>
          <div class="credit-title">Service Credit</div>
          <small class="credit-sub">Pending & Collected from Service Jobs</small>
        </div>
      </div>

      <h4 class="credit-subtitle">Pending Credit (Service)</h4>
      <table id="creditServicePending">
        <thead>
          <tr>
            <th>Date</th>
            <th>Customer / Job</th>
            <th>Amount</th>
            <th>Goto</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <h4 class="credit-subtitle" style="margin-top:14px;">Collected Credit (Service)</h4>
      <table id="creditServiceCollected">
        <thead>
          <tr>
            <th>Date</th>
            <th>Customer / Job</th>
            <th>Collected</th>
            <th>Goto</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</section>

<style>
  .credit-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(320px,1fr));
    gap:14px;
    margin-top:8px;
  }
  .credit-card{
    padding:12px 12px 14px;
    border-radius:16px;
    background:radial-gradient(circle at top left,#0b1120,#020617 60%);
    border:1px solid rgba(30,64,175,.5);
    box-shadow:0 14px 30px rgba(15,23,42,.9);
  }
  .credit-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:8px;
  }
  .credit-title{
    font-size:14px;
    font-weight:600;
  }
  .credit-sub{
    font-size:11px;
    color:#9ca3af;
  }
  .credit-subtitle{
    font-size:12px;
    margin:6px 0 4px;
    color:#cbd5f5;
  }
  .credit-pill{
    display:inline-flex;
    align-items:center;
    padding:3px 8px;
    border-radius:999px;
    font-size:10px;
    border:1px solid rgba(148,163,184,.6);
    color:#e5e7eb;
    gap:4px;
  }
  .credit-pill span.dot{
    width:6px;
    height:6px;
    border-radius:999px;
    background:#22c55e;
  }
  .btn-link{
    padding:4px 8px;
    border-radius:999px;
    border:1px solid #1d4ed8;
    background:#0b1120;
    color:#bfdbfe;
    font-size:11px;
    cursor:pointer;
  }
  .btn-link:hover{
    background:#1d4ed8;
    color:#0f172a;
  }
</style>
<!-- =============== DASHBOARD (TODAY + TOTAL) =============== -->
<section id="dashboard" class="section">
  <h3>üìä Dashboard (Today + Total)</h3>
  <div id="summaryCards" class="flex-row"
    style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;">
    <div class="card" style="flex:1;min-width:140px;padding:10px;border-radius:14px;background:#0b1120;border:1px solid #1d4ed8;">
      <div style="font-size:24px">üí∞</div>
      <b id="todaySales" style="font-size:18px;color:#38bdf8">‚Çπ0</b><br>
      <small>Today's Sales</small>
    </div>
    <div class="card" style="flex:1;min-width:140px;padding:10px;border-radius:14px;background:#0b1120;border:1px solid #1d4ed8;">
      <div style="font-size:24px">üí≥</div>
      <b id="todayCredit" style="font-size:18px;color:#38bdf8">‚Çπ0</b><br>
      <small>Today's Credit</small>
    </div>
    <div class="card" style="flex:1;min-width:140px;padding:10px;border-radius:14px;background:#111827;border:1px solid #b91c1c;">
      <div style="font-size:24px">üßæ</div>
      <b id="todayExpenses" style="font-size:18px;color:#f97316">‚Çπ0</b><br>
      <small>Today's Expenses</small>
    </div>
    <div class="card" style="flex:1;min-width:140px;padding:10px;border-radius:14px;background:#022c22;border:1px solid #16a34a;">
      <div style="font-size:24px">üìà</div>
      <b id="todayGross" style="font-size:18px;color:#22c55e">‚Çπ0</b><br>
      <small>Today's Gross Profit</small>
    </div>
    <div class="card" style="flex:1;min-width:140px;padding:10px;border-radius:14px;background:#022c22;border:1px solid #16a34a;">
      <div style="font-size:24px">üíπ</div>
      <b id="todayNet" style="font-size:18px;color:#22c55e">‚Çπ0</b><br>
      <small>Today's NET Profit</small>
    </div>
  </div>

  <hr style="margin:18px 0;border:none;border-top:1px dashed #1f2937;">

  <h4>Smart Dashboard (Total)</h4>
  <div class="flex-row" style="margin-bottom:18px;display:flex;gap:10px;flex-wrap:wrap;">
    <div class="card" style="flex:1;min-width:160px;padding:10px;border-radius:14px;background:#022c22;border:1px solid #16a34a;">
      <h4 style="margin:0 0 4px 0;font-size:13px;">Total Profit</h4>
      <b id="dashProfit" style="font-size:22px;color:#22c55e">‚Çπ0</b>
      <small>Sale + Service (collected only)</small>
    </div>
    <div class="card" style="flex:1;min-width:160px;padding:10px;border-radius:14px;background:#111827;border:1px solid #b91c1c;">
      <h4 style="margin:0 0 4px 0;font-size:13px;">Total Expenses</h4>
      <b id="dashExpenses" style="font-size:22px;color:#f97316">‚Çπ0</b>
    </div>
    <div class="card" style="flex:1;min-width:160px;padding:10px;border-radius:14px;background:#0b1120;border:1px solid #1d4ed8;">
      <h4 style="margin:0 0 4px 0;font-size:13px;">Credit Sales (Pending)</h4>
      <b id="dashCredit" style="font-size:22px;color:#38bdf8">‚Çπ0</b>
    </div>
    <div class="card" style="flex:1;min-width:160px;padding:10px;border-radius:14px;background:#0b1120;border:1px solid #facc15;">
      <h4 style="margin:0 0 4px 0;font-size:13px;">Total Investment (Sold Items)</h4>
      <b id="dashInv" style="font-size:22px;color:#facc15">‚Çπ0</b>
      <small>Sold stock + Service invest</small>
    </div>
  </div>

  <div style="max-width:600px;margin:auto;">
    <canvas id="cleanPie" height="150"></canvas>
  </div>
</section>

<!-- =============== COLLECTION TAB (NO PENDING TABLE) =============== -->
<section id="collection" class="section">
  <h3>ü™ô Collection Center</h3>

  <div class="flex-row" style="margin-bottom:14px;display:flex;gap:10px;flex-wrap:wrap;">
    <div class="card" style="flex:1;min-width:160px;padding:10px;border-radius:14px;background:#022c22;border:1px solid #16a34a;">
      <h4 style="margin:0 0 4px 0;font-size:13px;">Sales Profit (Collected)</h4>
      <b id="colSales" style="font-size:20px;color:#22c55e">‚Çπ0</b>
    </div>
    <div class="card" style="flex:1;min-width:160px;padding:10px;border-radius:14px;background:#0b1120;border:1px solid #1d4ed8;">
      <h4 style="margin:0 0 4px 0;font-size:13px;">Service Profit (Collected)</h4>
      <b id="colService" style="font-size:20px;color:#38bdf8">‚Çπ0</b>
    </div>
    <div class="card" style="flex:1;min-width:160px;padding:10px;border-radius:14px;background:#111827;border:1px solid #b91c1c;">
      <h4 style="margin:0 0 4px 0;font-size:13px;">Pending Credits</h4>
      <b id="colCredit" style="font-size:20px;color:#f97316">‚Çπ0</b>
    </div>
    <div class="card" style="flex:1;min-width:160px;padding:10px;border-radius:14px;background:#0b1120;border:1px solid #facc15;">
      <h4 style="margin:0 0 4px 0;font-size:13px;">Total Investment (Sold Items)</h4>
      <b id="colInvRemain" style="font-size:20px;color:#facc15">‚Çπ0</b>
    </div>
  </div>

  <!-- Pending table ‡∞™‡±Ç‡∞∞‡±ç‡∞§‡∞ø‡∞ó‡∞æ ‡∞§‡±ä‡∞≤‡∞ó‡∞ø‡∞Ç‡∞ö‡∞æ‡∞Ç -->

  <h4 style="margin-top:10px">Collection History</h4>
  <table id="collectionHistory">
    <thead>
      <tr>
        <th>Date</th>
        <th>Source</th>
        <th>Details</th>
        <th>Amount</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <button id="clearCollectionBtn"
    class="small-btn"
    style="background:#b71c1c;color:#fff;margin-top:10px;border-color:#7f1d1d;">
    üóë Clear Collection History
  </button>
</section>

<!-- =============== LIBRARIES =============== -->
<script src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.umd.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore-compat.js"></script>

<!-- =============== AUTO SCRIPT LOADER =============== -->
<script>
(function () {
  const v = Date.now();
  const js = [
    "/js/core.js",
    "/js/firebase.js",
    "/js/types.js",
    "/js/stock.js",
    "/js/sales.js",
    "/js/wanting.js",
    "/js/expenses.js",
    "/js/analytics.js",
    "/js/service.js",
    "/js/collection.js",
    "/js/universalBar.js",
    "/js/security.js"
  ];
  js.forEach(f => {
    document.write(`<script src="${f}?v=${v}"><\/script>`);
  });
})();
</script>

<script>
window.addEventListener("load", () => {
  try { updateEmailTag && updateEmailTag(); } catch (e) {
    console.error("emailTag update failed:", e);
  }
});
</script>
<!-- =============== COLLECT BUTTON CLICK HANDLER =============== -->
<script>
document.addEventListener("click", e => {
  const btn = e.target.closest(".collect-btn");
  if (!btn) return;
  const type = btn.dataset.collect;
  if (typeof window.handleCollect === "function") {
    handleCollect(type);
  } else {
    alert("Collect handler missing: " + type);
  }
});
</script>

<!-- =============== TAB SWITCHER =============== -->
<script>
function switchTab(id) {
  qsa(".section").forEach(sec => sec.classList.remove("active"));
  const target = qs("#" + id);
  if (target) target.classList.add("active");

  qsa(".tab").forEach(t => t.classList.remove("active"));
  const tab = qs(`.tab[data-tab="${id}"]`);
  if (tab) tab.classList.add("active");

  try { renderStock?.(); } catch {}
  try { renderSales?.(); } catch {}
  try { renderWanting?.(); } catch {}
  try { renderExpenses?.(); } catch {}
  try { renderServiceTables?.(); } catch {}
  try { renderCollection?.(); } catch {}
  try { renderAnalytics?.(); } catch {}
  try { updateSummaryCards?.(); } catch {}
  try { renderCreditHistory?.(); } catch {}
}

document.addEventListener("click", e => {
  if (e.target.classList.contains("tab")) {
    switchTab(e.target.dataset.tab);
  }
});
</script>

<!-- =============== CLOCK =============== -->
<script>
function updateClock() {
  const d = new Date();
  const t = qs("#clockTime");
  const dt = qs("#clockDate");
  if (t) t.textContent = d.toLocaleTimeString();
  if (dt) dt.textContent = d.toLocaleDateString();
}
setInterval(updateClock, 1000);
updateClock();
</script>

<!-- =============== THEME BUTTON (reuse from index style) =============== -->
<script>
(function(){
  const btn = document.getElementById("themeBtn");
  if(!btn) return;
  const saved = localStorage.getItem("ks-theme");
  if(saved === "dark"){
    document.body.classList.add("dark");
    btn.textContent = "‚òÄÔ∏è";
  }
  btn.addEventListener("click",()=>{
    const dark = document.body.classList.toggle("dark");
    localStorage.setItem("ks-theme", dark ? "dark" : "light");
    btn.textContent = dark ? "‚òÄÔ∏è" : "üåô";
  });
})();
</script>

<!-- =============== LOGOUT BUTTON =============== -->
<script>
document.getElementById("logoutBtn")?.addEventListener("click", async () => {
  try {
    if (window.fsLogout) {
      await window.fsLogout();
    } else {
      localStorage.removeItem("ks-user-email");
      window.location.href = "/login.html";
    }
  } catch (e) {
    console.error("Logout failed:", e);
    localStorage.removeItem("ks-user-email");
    window.location.href = "/login.html";
  }
});
</script>

<!-- =============== CREDIT HISTORY LOGIC =============== -->
<script>
function renderCreditHistory() {
  const sales    = Array.isArray(window.sales)    ? window.sales    : [];
  const services = Array.isArray(window.services) ? window.services : [];

  const sPendBody = qs("#creditSalesPending tbody");
  const sCollBody = qs("#creditSalesCollected tbody");
  const svcPendBody = qs("#creditServicePending tbody");
  const svcCollBody = qs("#creditServiceCollected tbody");

  if (!sPendBody || !sCollBody || !svcPendBody || !svcCollBody) return;

  const creditSalesPending = [];
  const creditSalesCollected = [];

  sales.forEach(s => {
    const status = String(s.status || "").toLowerCase();
    const total  = Number(s.total || (Number(s.qty||0)*Number(s.price||0)));
    const isCredit = status === "credit";
    const wasCredit = !!s.wasCredit; // collect ‡∞∏‡∞Æ‡∞Ø‡∞Ç‡∞≤‡±ã sales.js set ‡∞ö‡±á‡∞∏‡±ç‡∞§‡∞æ‡∞Ç

    if (isCredit) {
      creditSalesPending.push({
        date: s.date,
        customer: s.customer || "",
        phone: s.phone || "",
        product: s.product || "",
        qty: s.qty,
        price: s.price,
        total,
      });
    } else if (wasCredit) {
      const collected = Number(s.collectedAmount || total);
      creditSalesCollected.push({
        date: s.creditCollectedOn || s.date,
        customer: s.customer || "",
        phone: s.phone || "",
        product: s.product || "",
        qty: s.qty,
        price: s.price,
        total,
        collected,
      });
    }
  });

  if (!creditSalesPending.length) {
    sPendBody.innerHTML =
      `<tr><td colspan="4" style="text-align:center;opacity:.6;">No pending credit sales</td></tr>`;
  } else {
    sPendBody.innerHTML = creditSalesPending.map(r => `
      <tr>
        <td data-label="Date">${window.toDisplay ? toDisplay(r.date) : r.date}</td>
        <td data-label="Customer / Product">
          ${esc(r.customer || "-")}<br>
          <small>${esc(r.product)} (${r.qty} √ó ‚Çπ${r.price})</small>
          ${r.phone ? `<br><small>üìû ${esc(r.phone)}</small>` : ""}
        </td>
        <td data-label="Amount">‚Çπ${r.total}</td>
        <td data-label="Goto">
          <button class="btn-link" onclick="gotoSaleFromCredit('${r.date}')">Sales</button>
        </td>
      </tr>
    `).join("");
  }

  if (!creditSalesCollected.length) {
    sCollBody.innerHTML =
      `<tr><td colspan="4" style="text-align:center;opacity:.6;">No collected credit sales yet</td></tr>`;
  } else {
    sCollBody.innerHTML = creditSalesCollected.map(r => `
      <tr>
        <td data-label="Date">${window.toDisplay ? toDisplay(r.date) : r.date}</td>
        <td data-label="Customer / Product">
          ${esc(r.customer || "-")}<br>
          <small>${esc(r.product)} (${r.qty} √ó ‚Çπ${r.price})</small>
          ${r.phone ? `<br><small>üìû ${esc(r.phone)}</small>` : ""}
        </td>
        <td data-label="Collected">
          <span class="status-paid">Collected ‚Çπ${r.collected}</span>
        </td>
        <td data-label="Goto">
          <button class="btn-link" onclick="gotoSaleFromCredit('${r.date}')">Sales</button>
        </td>
      </tr>
    `).join("");
  }

  const svcPending = [];
  const svcCollected = [];

  services.forEach(j => {
    const status = String(j.status || "").toLowerCase();
    const remaining = Number(j.remaining || 0);
    const creditFlag = String(j.creditStatus || "").toLowerCase();

    if (creditFlag === "credit" || (status === "completed" && remaining > 0)) {
      svcPending.push({
        date: j.date_out || j.date_in,
        customer: j.customer || "",
        phone: j.phone || "",
        item: j.item || "",
        model: j.model || "",
        pending: remaining
      });
    } else if (creditFlag === "collected") {
      const collected = Number(j.creditCollectedAmount || 0);
      svcCollected.push({
        date: j.creditCollectedOn || j.date_out || j.date_in,
        customer: j.customer || "",
        phone: j.phone || "",
        item: j.item || "",
        model: j.model || "",
        collected
      });
    }
  });

  if (!svcPending.length) {
    svcPendBody.innerHTML =
      `<tr><td colspan="4" style="text-align:center;opacity:.6;">No pending service credits</td></tr>`;
  } else {
    svcPendBody.innerHTML = svcPending.map(r => `
      <tr>
        <td data-label="Date">${window.toDisplay ? toDisplay(r.date) : r.date}</td>
        <td data-label="Customer / Job">
          ${esc(r.customer || "-")}<br>
          <small>${esc(r.item)} ${esc(r.model)}</small>
          ${r.phone ? `<br><small>üìû ${esc(r.phone)}</small>` : ""}
        </td>
        <td data-label="Amount">‚Çπ${r.pending}</td>
        <td data-label="Goto">
          <button class="btn-link" onclick="gotoServiceFromCredit()">Service</button>
        </td>
      </tr>
    `).join("");
  }

  if (!svcCollected.length) {
    svcCollBody.innerHTML =
      `<tr><td colspan="4" style="text-align:center;opacity:.6;">No collected service credits yet</td></tr>`;
  } else {
    svcCollBody.innerHTML = svcCollected.map(r => `
      <tr>
        <td data-label="Date">${window.toDisplay ? toDisplay(r.date) : r.date}</td>
        <td data-label="Customer / Job">
          ${esc(r.customer || "-")}<br>
          <small>${esc(r.item)} ${esc(r.model)}</small>
          ${r.phone ? `<br><small>üìû ${esc(r.phone)}</small>` : ""}
        </td>
        <td data-label="Collected">
          <span class="status-paid">Collected ‚Çπ${r.collected}</span>
        </td>
        <td data-label="Goto">
          <button class="btn-link" onclick="gotoServiceFromCredit()">Service</button>
        </td>
      </tr>
    `).join("");
  }
}

window.renderCreditHistory = renderCreditHistory;

function gotoSaleFromCredit(date) {
  const dateInput = document.getElementById("saleDate");
  if (dateInput) {
    dateInput.value = date;
  }
  switchTab("sales");
  try { renderSales?.(); } catch {}
}

function gotoServiceFromCredit() {
  switchTab("service");
}

window.addEventListener("load", () => {
  try { renderCreditHistory(); } catch {}
});
</script>

</body>
</html>
