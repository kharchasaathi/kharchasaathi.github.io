<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ğŸ“¦ KharchaSaathi â€” Business Dashboard (v2.0)</title>
  <meta name="theme-color" content="#ff7a00" />
  <link rel="icon" href="/favicon.png" />
  <link rel="apple-touch-icon" href="/favicon.png" />

  <style>
    :root{
      --orange:#ff7a00; --orange-dark:#cc6300;
      --bg:#f8f9fa; --card:#ffffff; --text:#222;
      --dark-bg:#0f0f0f; --dark-card:#1a1a1a; --dark-text:#f2f2f2; --dark-border:#333;
    }
    *{box-sizing:border-box;transition:background .18s,color .18s}
    html,body{height:100%}
    body{
      margin:0;padding:18px;font-family:Poppins,Arial,sans-serif;
      background:var(--bg);color:var(--text);
    }
    body.dark{background:var(--dark-bg);color:var(--dark-text)}

    /* Topbar */
    .topbar{
      display:flex;justify-content:space-between;
      align-items:center;gap:10px;flex-wrap:wrap;
      margin-bottom:12px
    }
    h1{margin:0;font-size:20px;color:var(--orange)}
    .theme-btn,.small-btn{
      background:var(--orange);color:#fff;border:none;
      padding:8px 10px;border-radius:8px;cursor:pointer
    }
    .theme-btn:hover,.small-btn:hover{background:var(--orange-dark)}

    #emailTag{
      font-size:13px;opacity:.75;margin-right:8px;
      background:#eee;padding:4px 8px;border-radius:6px;
    }
    body.dark #emailTag{background:#222;color:#ddd}

    /* Tabs */
    .tabs{
      display:flex;gap:8px;margin:8px 0 16px;
      justify-content:center;flex-wrap:nowrap;overflow-x:auto
    }
    .tabs::-webkit-scrollbar{display:none}
    .tab{
      background:#eee;padding:8px 12px;border-radius:10px;
      cursor:pointer;font-weight:600;white-space:nowrap
    }
    .tab.active{background:var(--orange);color:#fff}
    body.dark .tab{background:#222;color:#ccc}
    body.dark .tab.active{background:var(--orange-dark);color:#fff}

    /* Sections */
    .section{
      display:none;background:var(--card);padding:14px;
      border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,0.05);
      margin-bottom:18px
    }
    .section.active{display:block}
    body.dark .section{
      background:var(--dark-card);
      border:1px solid var(--dark-border);color:var(--dark-text)
    }

    /* Summary + layout */
    .flex-row{display:flex;gap:18px;flex-wrap:wrap;align-items:flex-start}

    /* Table */
    table{
      width:100%;border-collapse:collapse;margin-top:12px;
      font-size:14px;border-radius:8px;overflow:hidden
    }
    th,td{padding:8px;border:1px solid #ddd;text-align:center}
    th{background:var(--orange);color:#fff}
    body.dark th{background:var(--orange-dark)}
    tr:nth-child(even){background:#fdfdfd}
    body.dark tr:nth-child(even){background:#1f1f1f}
    tr:hover{background:#fff3e0}

    /* Small forms */
    .row-inline{
      display:flex;gap:8px;align-items:center;flex-wrap:wrap
    }
    .row-inline input[type="text"],
    .row-inline input[type="number"],
    .row-inline select,
    .row-inline input[type="date"]{
      padding:6px;border-radius:6px;border:1px solid #ddd
    }

    /* small helper */
    .muted { color:#666; font-size:13px; }
  </style>
</head>

<body>

  <!-- ğŸ” TOPBAR -->
  <div class="topbar">
    <h1>ğŸ“¦ KharchaSaathi (Offline)</h1>

    <div style="display:flex;gap:10px;align-items:center">
      <span id="emailTag">Loading...</span>
      <button id="themeBtn" class="theme-btn">ğŸŒ™</button>
      <a class="small-btn" href="/index.html">ğŸ  Back</a>
      <button id="logoutBtn" class="small-btn" style="background:#e53935">ğŸ”“ Logout</button>
    </div>
  </div>

  <!-- ===== TABS ===== -->
  <div class="tabs" role="tablist">
    <div class="tab active" data-tab="types">ğŸ—‚ Types</div>
    <div class="tab" data-tab="stock">ğŸ“¦ Stock</div>
    <div class="tab" data-tab="sales">ğŸ“ˆ Sales</div>
    <div class="tab" data-tab="wanting">ğŸ›’ Wanting</div>
    <div class="tab" data-tab="dashboard">ğŸ“Š Overview</div>
    <div class="tab" data-tab="analytics">ğŸ“ˆ Smart Dashboard</div>
    <div class="tab" data-tab="expenses">ğŸ’¸ Expenses</div>
  </div>
  <!-- ===== TYPES ===== -->
  <section id="types" class="section active">
    <h3>ğŸ—‚ Manage Item Types</h3>

    <div class="row-inline" style="margin-top:8px">
      <input id="typeName" type="text" placeholder="Add new type" style="flex:1;min-width:160px">
      <button id="addTypeBtn" class="small-btn">Add</button>
      <button id="clearTypesBtn" class="small-btn">Clear All</button>
    </div>

    <ul id="typeList" style="margin-top:10px;padding-left:18px"></ul>
  </section>

  <!-- ===== STOCK ===== -->
  <section id="stock" class="section">
    <h3>ğŸ“¦ Current Stock</h3>

    <div class="row-inline" style="margin-top:6px">
      <label>Low Stock:</label>
      <input id="globalLimit" type="number" placeholder="2" style="width:80px">
      <button id="setLimitBtn" class="small-btn">Set</button>
      <button id="clearStockBtn" class="small-btn">Clear All</button>
    </div>

    <div class="row-inline" style="margin-top:12px">
      <!-- note: use type=date for inputs - internal storage is yyyy-mm-dd -->
      <input id="pdate" type="date">
      <select id="ptype"></select>
      <input id="pname" type="text" placeholder="Product">
      <input id="pqty" type="number" placeholder="Qty" style="width:80px">
      <input id="pcost" type="number" placeholder="Cost â‚¹" style="width:90px">
      <button id="addStockBtn" class="small-btn">Add</button>
    </div>

    <div style="margin-top:12px">
      <b>Filter Type:</b>
      <select id="filterType"><option value="all">All</option></select>
    </div>

    <table id="stockTable">
      <thead>
        <tr>
          <th>Date</th><th>Type</th><th>Product</th><th>Qty</th>
          <th>Sold</th><th>Remain</th><th>Alert</th><th>Limit</th><th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>
  <!-- ===== SALES (CLEAN) ===== -->
  <section id="sales" class="section">
    <h3>ğŸ’° Sales & Profit</h3>

    <div class="row-inline" style="margin:10px 0">
      <label>Date:</label>
      <input id="saleDate" type="date">

      <label style="margin-left:8px">Filter Type:</label>
      <select id="saleType">
        <option value="all">All Types</option>
      </select>

      <button id="filterSalesBtn" class="small-btn" style="margin-left:8px">
        Filter
      </button>

      <button id="clearSalesBtn" class="small-btn" 
        style="background:#c62828;color:#fff;margin-left:10px">
        ğŸ—‘ï¸ Clear All
      </button>
    </div>

    <table id="salesTable">
      <thead>
        <tr>
          <th>Date</th>
          <th>Type</th>
          <th>Product</th>
          <th>Qty</th>
          <th>Price</th>
          <th>Total</th>
          <th>Profit</th>
          <th>Status</th>
        </tr>
      </thead>

      <tbody></tbody>

      <tfoot>
        <tr>
          <td colspan="5" style="text-align:right">Total:</td>
          <td id="salesTotal">0</td>
          <td id="profitTotal">0</td>
          <td></td>
        </tr>
      </tfoot>
    </table>
  </section>

  <!-- ===== WANTING ===== -->
  <section id="wanting" class="section">
    <h3>ğŸ›’ Wanting List</h3>

    <div class="want-form">
      <select id="wantType"></select>
      <input id="wantName" type="text" placeholder="Product">
      <input id="wantNote" type="text" placeholder="Note">
      <button id="addWantBtn" class="small-btn">Add</button>
      <button id="clearWantBtn" class="small-btn">Clear</button>
      <button id="printWantBtn" class="small-btn">Print</button>
    </div>

    <table id="wantingTable">
      <thead>
        <tr>
          <th>Date</th>
          <th>Type</th>
          <th>Product</th>
          <th>Note</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- ===== OVERVIEW ===== -->
  <section id="dashboard" class="section">
    <h3>ğŸ“Š Business Overview</h3>

    <div id="summaryCards" class="flex-row" style="margin-top:10px">

      <div class="card">
        <div style="font-size:26px">ğŸ’°</div>
        <b id="todaySales" style="font-size:20px;color:var(--orange)">â‚¹0</b><br>
        <small>Today's Sales</small>
      </div>

      <div class="card">
        <div style="font-size:26px">ğŸ’³</div>
        <b id="todayCredit" style="font-size:20px;color:var(--orange)">â‚¹0</b><br>
        <small>Today's Credit</small>
      </div>

      <div class="card">
        <div style="font-size:26px">ğŸ§¾</div>
        <b id="todayExpenses" style="font-size:20px;color:var(--orange)">â‚¹0</b><br>
        <small>Today's Expenses</small>
      </div>

      <div class="card">
        <div style="font-size:26px">ğŸ“ˆ</div>
        <b id="todayGross" style="font-size:20px;color:var(--orange)">â‚¹0</b><br>
        <small>Today's Gross Profit</small>
      </div>

      <div class="card">
        <div style="font-size:26px">ğŸ’¹</div>
        <b id="todayNet" style="font-size:20px;color:var(--orange)">â‚¹0</b><br>
        <small>Today's NET Profit</small>
      </div>

      <div class="card">
        <div style="font-size:26px">ğŸ“¦</div>
        <b id="stockRemainValue" style="font-size:20px;color:var(--orange)">0%</b><br>
        <small>Stock Remaining</small>

        <div style="margin-top:6px;height:6px;background:#ddd;border-radius:4px">
          <div id="stockRemainBar"
               style="height:6px;width:0%;background:var(--orange);border-radius:4px">
          </div>
        </div>
      </div>

    </div>
  </section>

  <!-- ===== ANALYTICS (SMART DASHBOARD) ===== -->
  <section id="analytics" class="section">
    <h3>ğŸ“ˆ Smart Dashboard</h3>

    <!-- Summary Cards -->
    <div class="flex-row" style="margin-bottom:18px">

      <div class="card" style="flex:1;min-width:140px">
        <h4>Today Sales</h4>
        <b id="sumToday">â‚¹0</b>
      </div>

      <div class="card" style="flex:1;min-width:140px">
        <h4>This Week</h4>
        <b id="sumWeek">â‚¹0</b>
      </div>

      <div class="card" style="flex:1;min-width:140px">
        <h4>This Month</h4>
        <b id="sumMonth">â‚¹0</b>
      </div>

      <div class="card" style="flex:1;min-width:140px">
        <h4>Gross Profit</h4>
        <b id="sumGross">â‚¹0</b>
      </div>

      <div class="card" style="flex:1;min-width:140px">
        <h4>Net Profit</h4>
        <b id="sumNet">â‚¹0</b>
      </div>

    </div>

    <!-- Bar Chart -->
    <div style="max-width:900px;margin:auto">
      <canvas id="salesBar" height="150"></canvas>
    </div>

    <br>

    <!-- Pie Chart -->
    <div style="max-width:600px;margin:auto">
      <canvas id="salesPie" height="150"></canvas>
    </div>
  </section>
  <!-- ===== EXPENSES ===== -->
  <section id="expenses" class="section">
    <h3>ğŸ§¾ Expenses</h3>

    <div class="row-inline" style="margin-bottom:8px">
      <input id="expDate" type="date" onfocus="if(!this.value)this.value=todayDate()">
      <input id="expCategory" type="text" placeholder="Category" style="min-width:140px">
      <input id="expAmount" type="number" placeholder="Amount" style="width:120px">
      <input id="expNote" type="text" placeholder="Note" style="min-width:200px">
      <button id="addExpBtn" class="small-btn">Add Expense</button>
    </div>

    <table id="expensesTable">
      <thead>
        <tr>
          <th>Date</th>
          <th>Category</th>
          <th>Amount</th>
          <th>Note</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>

      <tfoot>
        <tr>
          <td colspan="2" style="text-align:right">Total:</td>
          <td id="expensesTotal">0</td>
          <td></td><td></td>
        </tr>
      </tfoot>
    </table>
  </section>

  <!-- HELP -->
  <div class="footer-btns" style="margin-top:18px">
    <a href="#" id="helpLink" class="small-btn">ğŸ“˜ Help & Guide</a>
    <div class="version-info">v2.0 â€” Fixed filters & dates</div>
  </div>

  <div id="helpModal" class="help-modal" style="display:none">
    <div class="help-content">
      <h2>ğŸ“˜ Quick Help</h2>
      <ul style="line-height:1.6">
        <li>Types â€” Manage categories</li>
        <li>Stock â€” Add/Update inventory</li>
        <li>Sales â€” View by date & type</li>
        <li>Wanting â€” Reorder required items</li>
        <li>Overview â€” Todayâ€™s summary</li>
        <li>Analytics â€” Smart charts</li>
      </ul>
      <button class="small-btn" onclick="toggleHelp()">Close</button>
    </div>
  </div>

  <!-- ===== JS LOGIC ===== -->
  <script>
    // small helpers (qs/qsa) + date display helpers
    const qs = s => document.querySelector(s);
    const qsa = s => Array.from(document.querySelectorAll(s));

    function toggleHelp(){
      const m = qs('#helpModal');
      m.style.display = (m.style.display==='flex' ? 'none' : 'flex');
    }

    qs('#helpLink').addEventListener('click', e=>{
      e.preventDefault();
      toggleHelp();
    });

    // Date format helpers (display: dd-mm-yyyy ; internal: yyyy-mm-dd)
    function toDisplay(d) {
      if (!d) return "";
      if (d.includes("-")) {
        const [y,m,dd] = d.split("-");
        return `${dd}-${m}-${y}`;
      }
      return d;
    }
    function toInternal(d) {
      if (!d) return "";
      if (d.includes("-")) {
        const parts = d.split("-");
        // if already dd-mm-yyyy then convert
        if (parts[0].length === 2) {
          const [dd,m,y] = parts;
          return `${y}-${m}-${dd}`;
        }
        return d; // assume already yyyy-mm-dd
      }
      return d;
    }

    // Theme
    if(localStorage.getItem('ks-theme')==='dark'){
      document.body.classList.add('dark');
    }
    qs('#themeBtn').addEventListener('click', ()=>{
      const d = document.body.classList.toggle('dark');
      localStorage.setItem('ks-theme', d?'dark':'light');
    });

    // Tabs switcher â€” refresh correct tabs
    (function () {
      const tabs = qsa('.tab'),
            sections = qsa('.section');

      function activate(name) {
        tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === name));
        sections.forEach(s => s.classList.toggle('active', s.id === name));

        if (name === 'types') {
          if (typeof renderTypes === "function") renderTypes();
        }
        if (name === 'stock') {
          updateTypeDropdowns?.();
          renderStock?.();
        }
        if (name === 'sales') {
          // refresh selector (types) and render
          if (typeof refreshSaleTypeSelector === "function") refreshSaleTypeSelector();
          if (typeof renderSales === "function") renderSales();
        }
        if (name === 'wanting') {
  if (typeof renderWanting === "function") renderWanting();
}

if (name === 'dashboard') {
  if (typeof updateSummaryCards === "function") updateSummaryCards();
}

if (name === 'analytics') {
  if (typeof renderAnalytics === "function") renderAnalytics();
}

if (name === 'expenses') {
  if (typeof renderExpenses === "function") renderExpenses();
}
      }

      tabs.forEach(t =>
        t.addEventListener('click', () => activate(t.dataset.tab))
      );

      window.activateTab = activate;
    })();

    // LOGIN CHECK + UI email
    // login-utils.js should expose isLoggedIn, getUserEmail, logoutUser
    
window.addEventListener("load", () => {

  // login check
  if (typeof isLoggedIn === "function" && !isLoggedIn()) {
    window.location.href = "/login.html";
    return;
  }

  // email set
  const tag = qs("#emailTag");
  if (tag && typeof getUserEmail === "function") {
    const mail = getUserEmail();
    tag.textContent = "Logged in: " + (mail || "Unknown User");
  }

  // logout
  qs("#logoutBtn")?.addEventListener("click", ()=>{
    if (typeof logoutUser === "function") logoutUser();
    window.location.href = "/login.html";
  });

});
</script>

    // When filterType changes in stock, ensure sales type also updated (keeps in sync)
    qs("#filterType")?.addEventListener("change", () => {
      // if sales selector exists, refresh it (sales.js will read types)
      if (typeof refreshSaleTypeSelector === "function") refreshSaleTypeSelector();
      renderStock?.();
    });

    // Attach immediate sales filter listeners if sales.js provided attachImmediateSalesFilters
    // Also add local fallback to call renderSales on change
    (function attachSalesInputs() {
      // If sales.js exposes attachImmediateSalesFilters, use it
      if (typeof attachImmediateSalesFilters === "function") {
        try { attachImmediateSalesFilters(); } catch (e) { /*ignore*/ }
      } else {
        qs("#saleType")?.addEventListener("change", () => renderSales?.());
        qs("#saleDate")?.addEventListener("change", () => renderSales?.());
        qs("#filterSalesBtn")?.addEventListener("click", () => renderSales?.());
      }
    })();

    // Update summary cards prints dd-mm-yyyy only for display (we show numbers but if you show dates use toDisplay)
    function updateSummaryCards() {
      const today = todayDate(); // yyyy-mm-dd from core
      let todaySales = 0, todayCredit = 0, todayProfit = 0;

      (window.sales || []).forEach(s => {
        if (String(s.date).slice(0,10) === today)  {
          todaySales += Number(s.amount || 0);
          if (s.status === "Credit") todayCredit += Number(s.amount || 0);
          todayProfit += Number(s.profit || 0);
        }
      });

      let todayExpenses = 0;
      (window.expenses || []).forEach(e => {
        if (String(e.date).slice(0,10) === today) todayExpenses += Number(e.amount || 0);
      });

      const todayNet = todayProfit - todayExpenses;

      let total = 0, remain = 0;
      (window.stock || []).forEach(s => {
        total += Number(s.qty || 0) + Number(s.sold || 0);
        remain += Number(s.qty || 0);
      });

      const pct = total ? Math.round((remain / total) * 100) : 0;

      qs("#todaySales").textContent = "â‚¹" + todaySales;
      qs("#todayCredit").textContent = "â‚¹" + todayCredit;
      qs("#todayExpenses").textContent = "â‚¹" + todayExpenses;
      qs("#todayGross").textContent = "â‚¹" + todayProfit;
      qs("#todayNet").textContent = "â‚¹" + todayNet;
      qs("#stockRemainValue").textContent = pct + "%";
      qs("#stockRemainBar").style.width = pct + "%";

      // analytics small cards
      qs("#sumToday") && (qs("#sumToday").textContent = "â‚¹" + todaySales);
      qs("#sumWeek") && (qs("#sumWeek").textContent = "â‚¹" + (typeof getAnalyticsData === "function" ? getAnalyticsData().weekSales : 0));
      qs("#sumMonth") && (qs("#sumMonth").textContent = "â‚¹" + (typeof getAnalyticsData === "function" ? getAnalyticsData().monthSales : 0));
      qs("#sumGross") && (qs("#sumGross").textContent = "â‚¹" + todayProfit);
      qs("#sumNet") && (qs("#sumNet").textContent = "â‚¹" + todayNet);
    }

    // SAFE initial render after modules loaded
    function safeInitialRender() {
      try { renderTypes?.(); } catch {}
      try { updateTypeDropdowns?.(); } catch {}
      try { renderStock?.(); } catch {}
      try { refreshSaleTypeSelector?.(); } catch {}
      try { renderSales?.(); } catch {}
      try { renderWanting?.(); } catch {}
      try { renderExpenses?.(); } catch {}
      try { renderAnalytics?.(); } catch {}
      try { updateSummaryCards?.(); } catch {}
    }

    // Wait a tick so external scripts have chance to register
    window.addEventListener("load", () => {
      setTimeout(safeInitialRender, 50);
    });
  </script>

  <!-- EXTERNAL LIBS + APP SCRIPTS (keep these at bottom) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.umd.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore-compat.js"></script>

  <!-- CORE (MUST LOAD FIRST) -->
<script src="/js/core.js"></script>

<!-- FIREBASE -->
<script src="/js/firebase.js"></script>

<!-- MODULES -->
<script src="/js/types.js"></script>
<script src="/js/stock.js"></script>
<script src="/js/sales.js"></script>
<script src="/js/wanting.js"></script>
<script src="/js/expenses.js"></script>
<script src="/js/analytics.js"></script>
<script src="/js/security.js"></script>

</body>
</html>
