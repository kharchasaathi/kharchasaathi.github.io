<!-- Part 1: business-dashboard.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ğŸ“¦ KharchaSaathi â€” Business Manager</title>
  <meta name="theme-color" content="#e5edff" />
  <link rel="icon" href="/favicon.png" />
  <link rel="apple-touch-icon" href="/favicon.png" />

  <!-- external CSS (kept) -->
  <link rel="stylesheet" href="/css/base.css" />
  <link rel="stylesheet" href="/css/layout.css" />
  <link rel="stylesheet" href="/css/components.css" />
  <link rel="stylesheet" href="/css/style.css" />
  <link rel="stylesheet" href="/css/table.css" />

  <!-- Inline critical theme CSS (kept minimal) -->
  <style>
    /* critical small theme vars (kept safe) */
    :root { --ks-accent:#2563eb; --ks-accent-soft:#3b82f6; --ks-bg-card:#fff; --ks-border-soft:#e2e8f0; --ks-text-main:#0f172a; --ks-radius-pill:999px; }
    body{ margin:0; font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif; background:radial-gradient(circle at top,#eef2ff 0,#e5e7eb 40%,#e2e8f0 100%); color:var(--ks-text-main); min-height:100vh; -webkit-font-smoothing:antialiased;}
    .topbar{ position:sticky; top:0; z-index:50; display:flex; justify-content:space-between; align-items:center; padding:10px 18px; background: rgba(255,255,255,.92); border-bottom:1px solid var(--ks-border-soft); }
    .topbar h1{ margin:0; font-size:20px; display:flex; gap:10px; align-items:center; text-transform:uppercase; font-weight:700; }
    .topbar-logo{ width:32px;height:32px;border-radius:999px; display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#22c55e,#2563eb); color:#fff; font-weight:700;}
    .tabs{ display:flex; gap:10px; padding:10px; overflow-x:auto; border-bottom:1px solid var(--ks-border-soft); }
    .tab{ padding:9px 18px; border-radius:999px; cursor:pointer; color:#6b7280; font-weight:600; }
    .tab.active{ background:linear-gradient(135deg,var(--ks-accent-soft),var(--ks-accent)); color:#fff; }
    .section{ display:none; padding:16px; max-width:1160px; margin:0 auto; }
    .section.active{ display:block; }
  </style>
</head>
<body>
<script>const qs=s=>document.querySelector(s), qsa=s=>Array.from(document.querySelectorAll(s));</script>

<div class="topbar">
  <h1><div class="topbar-logo">â‚¹</div>KHARCHASAATHI</h1>
  <div style="display:flex;gap:10px;align-items:center;">
    <span id="emailTag">Checking loginâ€¦</span>
    <div style="text-align:right;font-size:12px;">
      <div id="clockTime">--:--:--</div>
      <div id="clockDate">--</div>
    </div>
    <button id="themeBtn" class="theme-btn">ğŸŒ™</button>
    <a class="small-btn" href="/index.html">ğŸ  Home</a>
    <button id="logoutBtn" class="small-btn btn-danger">ğŸ”“ Logout</button>
  </div>
</div>

<!-- universal bar -->
<div id="universalBar" style="padding:12px 14px;border-bottom:1px solid var(--ks-border-soft);background:linear-gradient(to bottom,#eef2ff,#e5f3ff 55%,transparent);">
  <div style="max-width:1160px;margin:0 auto;display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;">
    <div class="card" style="position:relative;padding:12px;">
      <button class="collect-btn" data-collect="net">â‚¹ Collect</button>
      <div class="uni-title">Net Profit (Sale+Service âˆ’ Expenses)</div>
      <div class="uni-value" id="unNetProfit">â‚¹0</div>
      <div class="uni-sub">
        <span>Sale:</span><span id="unSaleProfit">â‚¹0</span>
        <span>Service:</span><span id="unServiceProfit">â‚¹0</span>
        <span>Exp:</span><span id="unExpenses">â‚¹0</span>
      </div>
    </div>
    <div class="card"><div class="uni-title">Stock Investment (Sold Items)</div><div class="uni-value" id="unStockInv">â‚¹0</div></div>
    <div class="card"><div class="uni-title">Service Investment (Completed)</div><div class="uni-value" id="unServiceInv">â‚¹0</div></div>
    <div class="card"><div class="uni-title">Pending Credit Sales</div><div class="uni-value" id="unCreditSales">â‚¹0</div></div>
  </div>
</div>

<div id="tabSummaryBar" style="text-align:center;padding:8px;margin:10px auto;max-width:1160px;border-radius:999px;background:#e6f4ea;color:#064e3b;">Profit: +â‚¹0</div>

<div class="tabs" role="tablist">
  <div class="tab active" data-tab="types">ğŸ“ Types</div>
  <div class="tab" data-tab="stock">ğŸ“¦ Stock</div>
  <div class="tab" data-tab="sales">ğŸ“ˆ Sales</div>
  <div class="tab" data-tab="wanting">ğŸ›’ Wanting</div>
  <div class="tab" data-tab="service">ğŸ›  Service</div>
  <div class="tab" data-tab="expenses">ğŸ’¸ Expenses</div>
  <div class="tab" data-tab="creditHistory">ğŸ§¾ Credit History</div>
  <div class="tab" data-tab="dashboard">ğŸ“Š Dashboard</div>
  <div class="tab" data-tab="collection">ğŸª™ Collection</div>
</div>

<!-- Sections skeleton â€” content filled in Part 4 modules, but include base placeholders so no undefined DOM -->
<section id="types" class="section active"></section>
<section id="stock" class="section"></section>
<section id="sales" class="section"></section>
<section id="wanting" class="section"></section>
<section id="service" class="section"></section>
<section id="expenses" class="section"></section>
<section id="creditHistory" class="section"></section>
<section id="dashboard" class="section"></section>
<section id="collection" class="section"></section>

<!-- libs: Chart.js + Firebase (compat) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.umd.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore-compat.js"></script>

<!-- AUTO LOADER (ensures correct order; firebase first) -->
<script>
(function(){
  if (window.__ks_loader_injected) return;
  window.__ks_loader_injected = true;

  const v = Date.now();
  const files = [
    "/js/firebase.js",       // must come before core & auth helpers
    "/js/core.js",
    "/js/types.js",
    "/js/stock.js",
    "/js/sales.js",
    "/js/wanting.js",
    "/js/service.js",
    "/js/expenses.js",
    "/js/collection.js",
    "/js/universalBar.js",
    "/js/analytics.js",
    "/js/security.js"
  ];

  files.forEach(src => {
    const s = document.createElement("script");
    s.src = src + "?v=" + v;
    s.defer = true;
    document.head.appendChild(s);
  });
})();
</script>

<!-- small inline bootstrap behaviors -->
<script>
(function(){
  // clock
  function updateClock(){ const d=new Date(); document.getElementById("clockTime").textContent = d.toLocaleTimeString(); document.getElementById("clockDate").textContent = d.toLocaleDateString(); }
  setInterval(updateClock,1000); updateClock();

  // theme
  const btn = document.getElementById("themeBtn");
  try{
    const saved = localStorage.getItem("ks-theme");
    if(saved==='dark') document.body.classList.add("dark");
    if(btn) btn.addEventListener("click", ()=>{ const dark = document.body.classList.toggle("dark"); localStorage.setItem("ks-theme", dark?'dark':'light'); btn.textContent = dark ? 'â˜€ï¸' : 'ğŸŒ™'; });
  }catch(e){console.warn(e);}

  // logout (delegates to firebase logout if available)
  document.getElementById("logoutBtn").addEventListener("click", async ()=>{
    try {
      if (typeof window.fsLogout === "function") { await window.fsLogout(); return; }
      // fallback (shouldn't be used in online-only mode)
      localStorage.removeItem("ks-user-email");
      location.href = "/login.html";
    } catch(e){ console.error("Logout failed", e); localStorage.removeItem("ks-user-email"); location.href="/login.html"; }
  });

  // tab switching
  document.addEventListener("click", e => {
    const t = e.target.closest(".tab");
    if(!t) return;
    const id = t.dataset.tab;
    qsa(".tab").forEach(x=>x.classList.remove("active"));
    t.classList.add("active");
    qsa(".section").forEach(s=>s.classList.remove("active"));
    const sec = document.getElementById(id);
    if(sec) sec.classList.add("active");
    // safe render hooks
    try{ window.renderStock?.(); }catch{}
    try{ window.renderSales?.(); }catch{}
    try{ window.renderWanting?.(); }catch{}
    try{ window.renderExpenses?.(); }catch{}
    try{ window.renderServiceTables?.(); }catch{}
    try{ window.renderCollection?.(); }catch{}
    try{ window.renderAnalytics?.(); }catch{}
  });

  // collect button delegation
  document.addEventListener("click", e => {
    const c = e.target.closest(".collect-btn");
    if(!c) return;
    const type = c.dataset.collect;
    try {
      if (typeof window.handleCollect === "function") window.handleCollect(type);
      else if (typeof window.onCollect === "function") {
        // default: read numeric value from universal bar
        const map = { net: "unNetProfit", stock: "unStockInv", service: "unServiceInv" };
        const el = document.getElementById(map[type]);
        const raw = el ? (el.textContent||"").replace(/[â‚¹,]/g,"").trim() : "0";
        const amount = Number(raw) || 0;
        window.onCollect(type, { amount, details: `${type} collect` });
      } else {
        alert("Collect handler missing");
      }
    } catch(err){ console.error("collect error", err); alert("Collect failed"); }
  });
})();
</script>

</body>
</html>
