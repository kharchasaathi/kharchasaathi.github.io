<!-- Part 1: head + CSS -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üì¶ KharchaSaathi ‚Äî Business Manager</title>
  <meta name="theme-color" content="#e5edff" />
  <link rel="icon" href="/favicon.png" />
  <link rel="apple-touch-icon" href="/favicon.png" />

  <!-- keep existing external CSS references (they may be customized) -->
  <link rel="stylesheet" href="/css/base.css" />
  <link rel="stylesheet" href="/css/layout.css" />
  <link rel="stylesheet" href="/css/components.css" />

  <!-- Consolidated theme CSS (light/dark variables + table styles) -->
  <style>
    :root{
      --ks-bg: #f3f4fb;
      --ks-bg-soft: #eef1ff;
      --ks-bg-card: #ffffff;
      --ks-border-soft: #e2e8f0;
      --ks-text-main: #0f172a;
      --ks-text-soft: #6b7280;
      --ks-accent: #2563eb;
      --ks-accent-soft: #3b82f6;
      --ks-accent-green: #16a34a;
      --ks-accent-orange:#ea580c;
      --ks-radius-card: 16px;
      --ks-radius-pill: 999px;
      --ks-shadow-soft: 0 14px 40px rgba(15,23,42,.08);
    }

    body.dark{
      --ks-bg: #0d1117;
      --ks-bg-soft: #020617;
      --ks-bg-card: #020617;
      --ks-border-soft: #1f2937;
      --ks-text-main: #e5e7eb;
      --ks-text-soft: #9ca3af;
      --ks-accent: #38bdf8;
      --ks-accent-soft: #0ea5e9;
      --ks-accent-green: #22c55e;
      --ks-accent-orange:#f97316;
      --ks-shadow-soft: 0 18px 55px rgba(15,23,42,.9);
    }

    html,body{height:100%}
    body{
      margin:0;
      padding:0;
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background: radial-gradient(circle at top,#eef2ff 0,#e5e7eb 40%,#e2e8f0 100%);
      color: var(--ks-text-main);
      min-height:100vh;
      -webkit-font-smoothing:antialiased;
    }
    body.dark{ background:#0d1117; color:var(--ks-text-main); }

    /* Topbar */
    .topbar{ position:sticky; top:0; z-index:50; display:flex; justify-content:space-between; align-items:center; padding:10px 18px; background: rgba(255,255,255,.92); backdrop-filter: blur(8px); border-bottom:1px solid var(--ks-border-soft); box-shadow:0 8px 18px rgba(15,23,42,.08); }
    body.dark .topbar{ background: linear-gradient(to right,#020617,#020617); border-bottom:1px solid rgba(148,163,184,0.16); box-shadow:0 10px 30px rgba(15,23,42,.8); }
    .topbar h1{ margin:0; font-size:20px; letter-spacing:.12em; text-transform:uppercase; display:flex; align-items:center; gap:10px; color:var(--ks-text-main); font-weight:700; }
    .topbar-logo{ width:32px; height:32px; border-radius:var(--ks-radius-pill); background: radial-gradient(circle at 30% 20%,#22c55e,#2563eb 55%,#0f172a 90%); display:flex; align-items:center; justify-content:center; box-shadow:0 0 18px rgba(37,99,235,.45); flex-shrink:0; }
    .topbar-logo span{ font-size:18px; color:#f9fafb; font-weight:700; }

    /* Universal bar */
    #universalBar{ padding:12px 14px 8px; border-bottom:1px solid var(--ks-border-soft); background:linear-gradient(to bottom,#eef2ff,#e5f3ff 55%,transparent); }
    body.dark #universalBar{ background: radial-gradient(circle at top,#020617,#020617 55%,#020617); border-bottom:1px solid #1f2937; }

    .uni-row{ display:grid; grid-template-columns:repeat(auto-fit,minmax(230px,1fr)); gap:12px; max-width:1160px; margin:0 auto; }
    .uni-card{ position:relative; padding:12px 14px 14px; border-radius:var(--ks-radius-card); background:var(--ks-bg-card); border:1px solid var(--ks-border-soft); box-shadow:var(--ks-shadow-soft); overflow:hidden; }
    .uni-card.main{ grid-column:span 2; min-width:260px; }
    body.dark .uni-card{ background: linear-gradient(135deg,#111827,#020617); border:1px solid rgba(148,163,184,.45); box-shadow:0 16px 36px rgba(15,23,42,.9); color:#e5e7eb; }

    .uni-title{ font-size:11px; text-transform:uppercase; letter-spacing:.18em; color:var(--ks-text-soft); margin-bottom:4px; font-weight:600; }
    .uni-value{ font-size:23px; font-weight:700; color:var(--ks-text-main); }
    .uni-sub{ margin-top:6px; display:grid; grid-template-columns:auto 1fr auto 1fr; gap:4px 6px; font-size:11px; align-items:center; color:var(--ks-text-soft); }

    .collect-btn{ position:absolute; right:12px; bottom:10px; padding:6px 12px; font-size:12px; border-radius:var(--ks-radius-pill); border:none; cursor:pointer; background:var(--ks-accent-green); color:#f0fdf4; font-weight:700; box-shadow:0 6px 14px rgba(22,163,74,.28); transition:.14s; white-space:nowrap;}
    .collect-btn:hover{ transform:translateY(-1px); opacity:.95; }
    body.dark .collect-btn{ background:#22c55e; color:#022c22; box-shadow:0 8px 22px rgba(22,163,74,.35); }

    /* Tabs */
    .tabs{ display:flex; gap:10px; padding:10px 12px 10px; overflow-x:auto; border-bottom:1px solid var(--ks-border-soft); background: linear-gradient(to right,#f9fafb,#eef2ff,#f9fafb); }
    .tab{ padding:9px 18px; border-radius:var(--ks-radius-pill); font-size:14px; cursor:pointer; white-space:nowrap; color:var(--ks-text-soft); border:1px solid transparent; display:flex; align-items:center; gap:6px; font-weight:600; }
    .tab.active{ background:linear-gradient(135deg,var(--ks-accent-soft),var(--ks-accent)); color:#f9fafb; box-shadow:0 10px 20px rgba(37,99,235,.20); }
    body.dark .tab{ color:#9ca3af; background:transparent; }
    body.dark .tab.active{ background:linear-gradient(135deg,#06b6d4,#0ea5e9); color:#0f172a; }

    /* Tables (excel-like thin vertical borders) */
    table{ width:100%; border-collapse:separate; border-spacing:0; margin-top:10px; font-size:13px; border-radius:10px; overflow:hidden; background:var(--ks-bg-card); box-shadow:var(--ks-shadow-soft); }
    thead{ background:linear-gradient(to right,#e5edff,#dbeafe); color:var(--ks-text-soft); }
    th,td{ padding:8px 10px; border-bottom:1px solid var(--ks-border-soft); border-right:1px solid var(--ks-border-soft); text-align:left; }
    th:last-child, td:last-child{ border-right:none; }
    tbody tr:nth-child(even){ background:#f9fafb; }
    tbody tr:nth-child(odd){ background:#ffffff; }
    body.dark tbody tr:nth-child(odd){ background:#020617; }
    body.dark tbody tr:nth-child(even){ background:#050816; }
    tfoot td{ background:#edf2ff; font-weight:600; }
    body.dark thead{ background:#111827; color:#cbd5f5; }
    body.dark tfoot td{ background:#020617; color:#f9fafb; }

    .status-credit{ display:inline-block; padding:3px 8px; border-radius:var(--ks-radius-pill); background:var(--ks-accent-orange); color:#111827; font-weight:700; }
    .status-paid{ display:inline-block; padding:3px 8px; border-radius:var(--ks-radius-pill); background:var(--ks-accent-green); color:#022c22; font-weight:700; }

    /* small responsive tweaks */
    @media(max-width:768px){ .topbar{ flex-direction:column; align-items:flex-start; gap:6px; } .uni-card.main{ grid-column:span 1; } }
  </style>
</head>
<!-- Part 2: topbar + universal bar -->
<body>
<script> const qs = s => document.querySelector(s); const qsa = s => Array.from(document.querySelectorAll(s)); </script>

<div class="topbar">
  <h1>
    <div class="topbar-logo"><span>‚Çπ</span></div>
    KHARCHASAATHI
  </h1>

  <div class="topbar-right" style="display:flex;align-items:center;gap:10px;">
    <span id="emailTag">Checking login‚Ä¶</span>
    <div class="simple-clock" style="display:flex;flex-direction:column;align-items:flex-end;font-size:11px;">
      <span id="clockTime" class="clock-line">--:--:--</span>
      <span id="clockDate" class="clock-line small">--</span>
    </div>
    <button id="themeBtn" class="theme-btn">üåô</button>
    <a class="small-btn" href="/index.html">üè† Home</a>
    <button id="logoutBtn" class="small-btn">üîì Logout</button>
  </div>
</div>

<div id="universalBar">
  <div class="uni-row">
    <div class="uni-card main">
      <button class="collect-btn" data-collect="net">‚Çπ Collect</button>
      <div class="uni-title">Net Profit (Sale + Service ‚àí Expenses)</div>
      <div class="uni-value" id="unNetProfit">‚Çπ0</div>
      <div class="uni-sub">
        <span>Sale:</span><span id="unSaleProfit">‚Çπ0</span>
        <span>Service:</span><span id="unServiceProfit">‚Çπ0</span>
        <span class="uni-exp-label">Exp:</span><span id="unExpenses" class="uni-exp-value">‚Çπ0</span>
      </div>
    </div>

    <div class="uni-card">
      <button class="collect-btn" data-collect="stock">‚Çπ Collect</button>
      <div class="uni-title">Stock Investment (Sold Items)</div>
      <div class="uni-value small" id="unStockInv">‚Çπ0</div>
      <div class="uni-sub"><span class="uni-chip">Sold stock</span></div>
    </div>

    <div class="uni-card">
      <button class="collect-btn" data-collect="service">‚Çπ Collect</button>
      <div class="uni-title">Service Investment (Completed)</div>
      <div class="uni-value small" id="unServiceInv">‚Çπ0</div>
      <div class="uni-sub"><span class="uni-chip">Closed jobs</span></div>
    </div>

    <div class="uni-card">
      <div class="uni-title">Pending Credit Sales</div>
      <div class="uni-value small" id="unCreditSales">‚Çπ0</div>
      <div class="uni-sub"><span class="uni-chip">To be collected</span></div>
    </div>
  </div>
</div>

<div id="tabSummaryBar">Profit: +‚Çπ0</div>
<!-- Part 3: tabs + empty sections skeleton (structure only) -->
<div class="tabs" role="tablist" aria-label="Main tabs">
  <div class="tab active" data-tab="types">üìÅ Types</div>
  <div class="tab" data-tab="stock">üì¶ Stock</div>
  <div class="tab" data-tab="sales">üìà Sales</div>
  <div class="tab" data-tab="wanting">üõí Wanting</div>
  <div class="tab" data-tab="service">üõ† Service</div>
  <div class="tab" data-tab="expenses">üí∏ Expenses</div>
  <div class="tab" data-tab="creditHistory">üßæ Credit History</div>
  <div class="tab" data-tab="dashboard">üìä Dashboard</div>
  <div class="tab" data-tab="collection">ü™ô Collection</div>
</div>

<!-- Sections container (keep content filled in Parts 4/5) -->
<section id="types" class="section active"></section>
<section id="stock" class="section"></section>
<section id="sales" class="section"></section>
<section id="wanting" class="section"></section>
<section id="service" class="section"></section>
<section id="expenses" class="section"></section>
<section id="creditHistory" class="section"></section>
<section id="dashboard" class="section"></section>
<section id="collection" class="section"></section>
<!-- Part 4: Fill core forms + tables for Sales, Stock & Service -->

<!-- TYPES (simple) -->
<section id="types" class="section active">
  <h3>üóÇ Manage Item Types</h3>
  <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;">
    <input id="typeName" type="text" placeholder="Add new type" style="flex:1;min-width:160px;padding:8px 10px;border-radius:12px;border:1px solid var(--ks-border-soft);background:var(--ks-bg-card);">
    <button id="addTypeBtn" class="small-btn">Add</button>
    <button id="clearTypesBtn" class="small-btn">Clear All</button>
  </div>
  <ul id="typeList" style="margin-top:10px;padding-left:18px;font-size:13px;"></ul>
</section>

<!-- STOCK -->
<section id="stock" class="section">
  <h3>üì¶ Current Stock</h3>
  <div style="margin-top:6px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
    <label>Low Stock:</label>
    <input id="globalLimit" type="number" placeholder="2" style="width:90px;padding:6px;border-radius:10px;border:1px solid var(--ks-border-soft);">
    <button id="setLimitBtn" class="small-btn">Set</button>
    <button id="clearStockBtn" class="small-btn" style="background:#fee2e2;color:#b91c1c;border-color:#fecaca;">Clear All</button>
  </div>

  <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;">
    <input id="pdate" type="date">
    <select id="ptype"></select>
    <input id="pname" type="text" placeholder="Product">
    <input id="pqty" type="number" placeholder="Qty" style="width:80px;">
    <input id="pcost" type="number" placeholder="Cost ‚Çπ" style="width:100px;">
    <button id="addStockBtn" class="small-btn">Add</button>
  </div>

  <div id="stockInvBox" style="margin-top:10px;padding:10px;background:#fefce8;border-radius:12px;border:1px solid #facc15;max-width:280px;margin-left:auto;font-weight:600;">
    üì¶ Stock Investment (Before Sale): <span id="stockInvValue" style="color:#ca8a04;">‚Çπ0</span>
  </div>

  <table id="stockTable" style="margin-top:10px;">
    <thead>
      <tr><th>Date</th><th>Type</th><th>Product</th><th>Qty</th><th>Sold</th><th>Remain</th><th>Alert</th><th>Limit</th><th>Action</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<!-- SALES -->
<section id="sales" class="section">
  <h3>üí∞ Sales & Profit</h3>
  <div style="margin:10px 0;display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
    <label>Date:</label>
    <input id="saleDate" type="date">
    <label>Filter Type:</label>
    <select id="saleType"><option value="all">All Types</option></select>
    <button id="filterSalesBtn" class="small-btn">Filter</button>
    <button id="clearSalesBtn" class="small-btn" style="background:#fee2e2;color:#b91c1c;border-color:#fecaca;">üóëÔ∏è Clear All</button>
  </div>

  <table id="salesTable">
    <thead>
      <tr><th>Date</th><th>Type</th><th>Product</th><th>Qty</th><th>Price</th><th>Total</th><th>Profit</th><th>Status</th></tr>
    </thead>
    <tbody></tbody>
    <tfoot>
      <tr>
        <td colspan="5" style="text-align:right">Total:</td>
        <td id="salesTotal">0</td>
        <td id="profitTotal">0</td>
        <td></td>
      </tr>
    </tfoot>
  </table>
</section>

<!-- SERVICE -->
<section id="service" class="section">
  <h3>üõ† Service / Repair Manager</h3>
  <div style="margin:10px 0;display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
    <input id="svcReceivedDate" type="date" style="width:160px;">
    <input id="svcCustomer" type="text" placeholder="Customer name" style="min-width:160px;">
    <input id="svcPhone" type="text" placeholder="Phone Number" style="width:140px;">
    <select id="svcItemType" style="width:120px;"><option>Mobile</option><option>Laptop</option><option>Other</option></select>
    <input id="svcModel" type="text" placeholder="Model" style="min-width:130px;">
    <input id="svcProblem" type="text" placeholder="Problem / Complaint" style="min-width:220px;">
    <input id="svcAdvance" type="number" placeholder="Advance ‚Çπ (0)" style="width:120px;">
    <button id="addServiceBtn" class="small-btn">Add Job</button>
  </div>

  <div style="display:flex;gap:10px;flex-wrap:wrap;margin:8px 0;">
    <div class="card" style="flex:1;min-width:120px;padding:8px 10px;"><small>Pending</small><div id="svcPendingCount" style="font-size:18px;font-weight:700;">0</div></div>
    <div class="card" style="flex:1;min-width:120px;padding:8px 10px;border-color:#bbf7d0;background:#ecfdf5;"><small>Completed</small><div id="svcCompletedCount" style="font-size:18px;font-weight:700;color:#16a34a;">0</div></div>
    <div class="card" style="flex:1;min-width:160px;padding:8px 10px;border-color:#fed7aa;background:#fff7ed;"><small>Total Repair Profit</small><div id="svcTotalProfit" style="font-size:18px;font-weight:700;color:#c2410c;">‚Çπ0</div></div>
  </div>

  <h4>Pending / Active Jobs</h4>
  <table id="svcTable">
    <thead><tr><th>Job ID</th><th>Received</th><th>Customer</th><th>Phone</th><th>Item</th><th>Model</th><th>Problem</th><th>Status</th><th>Action</th></tr></thead>
    <tbody></tbody>
  </table>

  <button id="clearServiceBtn" class="small-btn" style="background:#fee2e2;color:#b91c1c;margin:10px 0;border-color:#fecaca;">üóëÔ∏è Clear All Jobs</button>

  <h4 style="margin-top:14px">Completed / History</h4>
  <table id="svcHistoryTable">
    <thead><tr><th>Job ID</th><th>Received</th><th>Completed</th><th>Customer</th><th>Item</th><th>Invest</th><th>Paid</th><th>Profit</th><th>Status</th></tr></thead>
    <tbody></tbody>
  </table>
</section>
<!-- Part 5: Credit history panels, dashboard cards, collection history -->

<!-- CREDIT HISTORY -->
<section id="creditHistory" class="section">
  <h3>üßæ Credit History (Sales + Service)</h3>
  <div class="credit-grid">
    <div class="credit-card">
      <div class="credit-header"><div><div class="credit-title">Sales Credit</div><small class="credit-sub">Pending &amp; Collected from Sales</small></div></div>

      <h4 class="credit-subtitle">Pending Credit (Sales)</h4>
      <table id="creditSalesPending"><thead><tr><th>Date</th><th>Customer / Product</th><th>Amount</th><th>Goto</th></tr></thead><tbody></tbody></table>

      <h4 class="credit-subtitle" style="margin-top:14px;">Collected Credit (Sales)</h4>
      <table id="creditSalesCollected"><thead><tr><th>Date</th><th>Customer / Product</th><th>Collected</th><th>Action</th></tr></thead><tbody></tbody></table>
    </div>

    <div class="credit-card">
      <div class="credit-header"><div><div class="credit-title">Service Credit</div><small class="credit-sub">Pending &amp; Collected from Service Jobs</small></div></div>

      <h4 class="credit-subtitle">Pending Credit (Service)</h4>
      <table id="creditServicePending"><thead><tr><th>Date</th><th>Customer / Job</th><th>Amount</th><th>Goto</th></tr></thead><tbody></tbody></table>

      <h4 class="credit-subtitle" style="margin-top:14px;">Collected Credit (Service)</h4>
      <table id="creditServiceCollected"><thead><tr><th>Date</th><th>Customer / Job</th><th>Collected</th><th>Action</th></tr></thead><tbody></tbody></table>
    </div>
  </div>
</section>

<!-- DASHBOARD -->
<section id="dashboard" class="section">
  <h3>üìä Dashboard (Today + Total)</h3>
  <div id="summaryCards" style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;">
    <div class="card" style="flex:1;min-width:140px;padding:10px;"><div style="font-size:24px">üí∞</div><b id="todaySales" style="font-size:18px;color:var(--ks-accent);">‚Çπ0</b><br><small>Today's Sales</small></div>
    <div class="card" style="flex:1;min-width:140px;padding:10px;"><div style="font-size:24px">üí≥</div><b id="todayCredit" style="font-size:18px;color:var(--ks-accent);">‚Çπ0</b><br><small>Today's Credit</small></div>
    <div class="card" style="flex:1;min-width:140px;padding:10px;background:#fff7ed;"><div style="font-size:24px">üßæ</div><b id="todayExpenses" style="font-size:18px;color:#ea580c;">‚Çπ0</b><br><small>Today's Expenses</small></div>
    <div class="card" style="flex:1;min-width:140px;padding:10px;background:#ecfdf5;"><div style="font-size:24px">üìà</div><b id="todayGross" style="font-size:18px;color:#16a34a;">‚Çπ0</b><br><small>Today's Gross Profit</small></div>
    <div class="card" style="flex:1;min-width:140px;padding:10px;background:#ecfdf5;"><div style="font-size:24px">üíπ</div><b id="todayNet" style="font-size:18px;color:#16a34a;">‚Çπ0</b><br><small>Today's NET Profit</small></div>
  </div>

  <hr style="margin:18px 0;border:none;border-top:1px dashed var(--ks-border-soft);">

  <h4>Smart Dashboard (Total)</h4>
  <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:18px;">
    <div class="card" style="flex:1;min-width:160px;padding:10px;background:#ecfdf5;"><h4 style="margin:0;font-size:13px;">Total Profit</h4><b id="dashProfit" style="font-size:22px;color:#16a34a;">‚Çπ0</b><small>Sale + Service (collected only)</small></div>
    <div class="card" style="flex:1;min-width:160px;padding:10px;background:#fff7ed;"><h4 style="margin:0;font-size:13px;">Total Expenses</h4><b id="dashExpenses" style="font-size:22px;color:#ea580c;">‚Çπ0</b></div>
    <div class="card" style="flex:1;min-width:160px;padding:10px;"><h4 style="margin:0;font-size:13px;">Credit Sales (Pending)</h4><b id="dashCredit" style="font-size:22px;color:var(--ks-accent);">‚Çπ0</b></div>
    <div class="card" style="flex:1;min-width:160px;padding:10px;background:#fefce8;"><h4 style="margin:0;font-size:13px;">Total Investment (Sold Items)</h4><b id="dashInv" style="font-size:22px;color:#ca8a04;">‚Çπ0</b><small>Sold stock + Service invest</small></div>
  </div>

  <div style="max-width:600px;margin:auto;"><canvas id="cleanPie" height="150"></canvas></div>
</section>

<!-- COLLECTION -->
<section id="collection" class="section">
  <h3>ü™ô Collection Center</h3>
  <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:14px;">
    <div class="card" style="flex:1;min-width:160px;padding:10px;background:#ecfdf5;"><h4 style="margin:0;font-size:13px;">Sales Profit (Collected)</h4><b id="colSales" style="font-size:20px;color:#16a34a;">‚Çπ0</b></div>
    <div class="card" style="flex:1;min-width:160px;padding:10px;"><h4 style="margin:0;font-size:13px;">Service Profit (Collected)</h4><b id="colService" style="font-size:20px;color:var(--ks-accent);">‚Çπ0</b></div>
    <div class="card" style="flex:1;min-width:160px;padding:10px;background:#fff7ed;"><h4 style="margin:0;font-size:13px;">Pending Credits</h4><b id="colCredit" style="font-size:20px;color:#ea580c;">‚Çπ0</b></div>
    <div class="card" style="flex:1;min-width:160px;padding:10px;background:#fefce8;"><h4 style="margin:0;font-size:13px;">Total Investment (Sold Items)</h4><b id="colInvRemain" style="font-size:20px;color:#ca8a04;">‚Çπ0</b></div>
  </div>

  <h4 style="margin-top:10px">Collection History</h4>
  <table id="collectionHistory">
    <thead><tr><th>Date</th><th>Source</th><th>Details</th><th>Amount</th></tr></thead>
    <tbody></tbody>
  </table>

  <button id="clearCollectionBtn" class="small-btn" style="background:#fee2e2;color:#b91c1c;margin-top:10px;border-color:#fecaca;">üóë Clear Collection History</button>
</section>
<!-- Part 6: libraries + auto loader (we keep existing loader style but ensure unique injection) -->
<!-- LIBS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.umd.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore-compat.js"></script>

<!-- AUTO SCRIPT LOADER: add version param to avoid browser caching -->
<script>
  (function () {
    const v = Date.now();
    const js = [
      "/js/core.js",
      "/js/firebase.js",
      "/js/types.js",
      "/js/stock.js",
      "/js/sales.js",
      "/js/wanting.js",
      "/js/expenses.js",
      "/js/analytics.js",
      "/js/service.js",
      "/js/collection.js",
      "/js/universalBar.js",
      "/js/security.js"
    ];
    // Avoid double-injection: check for a marker
    if (!window.__ks_loader_injected) {
      window.__ks_loader_injected = true;
      js.forEach(f => {
        const s = document.createElement('script');
        s.src = f + "?v=" + v;
        s.defer = true;
        document.head.appendChild(s);
      });
    }
  })();
</script>
<!-- Part 7: core inline behaviors (safe, idempotent) -->
<script>
  // Utility selectors (already inlined earlier but ensure available)
  const qs = s => document.querySelector(s);
  const qsa = s => Array.from(document.querySelectorAll(s));

  // CLOCK
  function updateClock() {
    const d = new Date();
    if (qs("#clockTime")) qs("#clockTime").textContent = d.toLocaleTimeString();
    if (qs("#clockDate")) qs("#clockDate").textContent = d.toLocaleDateString();
  }
  setInterval(updateClock, 1000);
  updateClock();

  // THEME BUTTON: persist 'ks-theme'
  (function initTheme(){
    const btn = document.getElementById("themeBtn");
    try {
      const saved = localStorage.getItem("ks-theme");
      if (saved === "dark") { document.body.classList.add("dark"); if (btn) btn.textContent = "‚òÄÔ∏è"; }
      if (btn) btn.addEventListener("click", () => {
        const dark = document.body.classList.toggle("dark");
        localStorage.setItem("ks-theme", dark ? "dark" : "light");
        btn.textContent = dark ? "‚òÄÔ∏è" : "üåô";
      });
    } catch(e){ console.warn("theme init failed", e); }
  })();

  // SAFE handleCollect fallback: if collection.js defines window.handleCollect use that; else define a safe fallback
  if (typeof window.handleCollect !== "function") {
    window.handleCollect = function(type){
      try {
        type = String(type || "").toLowerCase();
        const map = { net: "unNetProfit", stock: "unStockInv", service: "unServiceInv" };
        const el = qs("#" + (map[type] || ""));
        const raw = el ? (el.textContent || "").replace(/[‚Çπ,]/g,"").trim() : "0";
        const amount = Number(raw) || 0;
        if (!amount) { alert("Nothing to collect for: " + type); return; }
        const now = new Date().toISOString().split("T")[0];
        const entry = { date: now, source: (type === "net") ? "Net Profit" : (type === "stock") ? "Stock Investment" : "Service Investment", details: `Collected from ${type}`, amount };
        // push to window.collections (core.js uses collections)
        window.collections = Array.isArray(window.collections) ? window.collections : [];
        window.collections.unshift(entry);
        try { window.saveCollections?.(); } catch {}
        // update UI
        if (el) el.textContent = "‚Çπ0";
        if (window.renderCollection) try { window.renderCollection(); } catch {}
        if (window.updateUniversalBar) try { window.updateUniversalBar(); } catch {}
        if (window.updateSummaryCards) try { window.updateSummaryCards(); } catch {}
        alert("Collected ‚Çπ" + amount);
      } catch (e){ console.error("handleCollect fallback error", e); alert("Collect failed"); }
    };
  }

  // COLLECT BUTTON CLICK HANDLER (delegates to window.handleCollect)
  document.addEventListener("click", e => {
    const btn = e.target.closest(".collect-btn");
    if (!btn) return;
    const type = btn.dataset.collect;
    if (typeof window.handleCollect === "function") return window.handleCollect(type);
    alert("Collect handler missing");
  });

  // TAB SWITCHER (idempotent)
  function switchTab(id) {
    qsa(".section").forEach(sec => sec.classList.remove("active"));
    const target = qs("#" + id);
    if (target) target.classList.add("active");
    qsa(".tab").forEach(t => t.classList.remove("active"));
    const tab = qs(`.tab[data-tab="${id}"]`); if (tab) tab.classList.add("active");
    // trigger renders safely if available
    try { renderStock?.(); } catch {}
    try { renderSales?.(); } catch {}
    try { renderWanting?.(); } catch {}
    try { renderExpenses?.(); } catch {}
    try { renderServiceTables?.(); } catch {}
    try { renderCollection?.(); } catch {}
    try { renderAnalytics?.(); } catch {}
    try { updateSummaryCards?.(); } catch {}
    try { renderCreditHistory?.(); } catch {}
  }

  document.addEventListener("click", e => {
    if (e.target.classList.contains("tab")) {
      switchTab(e.target.dataset.tab);
    }
  });

  // Boot-time safe render hooks
  window.addEventListener("load", () => {
    try { updateEmailTag?.(); } catch {}
    try { renderCollection?.(); } catch {}
    try { renderCreditHistory?.(); } catch {}
    try { renderAnalytics?.(); } catch {}
    try { updateSummaryCards?.(); } catch {}
    try { updateTabSummaryBar?.(); } catch {}
    try { updateUniversalBar?.(); } catch {}
  });
</script>
<!-- Part 8: finalize document -->
</body>
</html>
