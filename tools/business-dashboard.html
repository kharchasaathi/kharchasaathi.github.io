<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ğŸ“¦ KharchaSaathi â€” Business Manager</title>
  <meta name="theme-color" content="#e5edff" />
  <link rel="icon" href="/favicon.png" />
  <link rel="apple-touch-icon" href="/favicon.png" />

  <link rel="stylesheet" href="/css/base.css" />
  <link rel="stylesheet" href="/css/layout.css" />
  <link rel="stylesheet" href="/css/components.css" />
  <link rel="stylesheet" href="/css/style.css" />
  <link rel="stylesheet" href="/css/table.css" />
</head>

<body>

<script>
  const qs = s => document.querySelector(s);
  const qsa = s => Array.from(document.querySelectorAll(s));
</script>

<div class="topbar">
  <h1><div class="topbar-logo">â‚¹</div>KHARCHASAATHI</h1>

  <div style="display:flex;gap:10px;align-items:center;">
    <span id="emailTag">Checking loginâ€¦</span>
    <div style="text-align:right;font-size:12px;">
      <div id="clockTime">--:--:--</div>
      <div id="clockDate">--</div>
    </div>
    <button id="themeBtn" class="small-btn">ğŸŒ™</button>
    <a class="small-btn" href="/index.html">ğŸ  Home</a>
    <button id="logoutBtn" class="small-btn danger-btn">ğŸ”“ Logout</button>
  </div>
</div>

<div id="universalBar">
  <div style="max-width:1160px;margin:0 auto;display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;">

    <div class="card" style="position:relative;">
      <button class="collect-btn" data-collect="net">â‚¹ Collect</button>
      <div class="uni-title">Net Profit (Sale + Service âˆ’ Expense)</div>
      <div class="uni-value" id="unNetProfit">â‚¹0</div>
      <div class="uni-sub">
        <span>Sale:</span><span id="unSaleProfit">â‚¹0</span>
        <span>Service:</span><span id="unServiceProfit">â‚¹0</span>
        <span>Exp:</span><span id="unExpenses">â‚¹0</span>
      </div>
    </div>

    <div class="card" style="position:relative;">
      <button class="collect-btn" data-collect="stock">â‚¹ Collect</button>
      <div class="uni-title">Stock Investment (Sold Items)</div>
      <div class="uni-value" id="unStockInv">â‚¹0</div>
    </div>

    <div class="card" style="position:relative;">
      <button class="collect-btn" data-collect="service">â‚¹ Collect</button>
      <div class="uni-title">Service Investment (Completed)</div>
      <div class="uni-value" id="unServiceInv">â‚¹0</div>
    </div>

    <div class="card">
      <div class="uni-title">Pending Credit</div>
      <div class="uni-value" id="unCreditSales">â‚¹0</div>
    </div>
  </div>
</div>

<div id="tabSummaryBar">Profit: +â‚¹0</div>

<div class="tabs" role="tablist">
  <div class="tab active" data-tab="types">ğŸ“ Types</div>
  <div class="tab" data-tab="stock">ğŸ“¦ Stock</div>
  <div class="tab" data-tab="sales">ğŸ“ˆ Sales</div>
  <div class="tab" data-tab="wanting">ğŸ›’ Wanting</div>
  <div class="tab" data-tab="service">ğŸ›  Service</div>
  <div class="tab" data-tab="expenses">ğŸ’¸ Expenses</div>
  <div class="tab" data-tab="creditHistory">ğŸ§¾ Credit History</div>
  <div class="tab" data-tab="dashboard">ğŸ“Š Dashboard</div>
  <div class="tab" data-tab="collection">ğŸª™ Collection</div>
</div>
<section id="types" class="section active">
  <div style="margin-bottom:10px;display:flex;gap:8px;flex-wrap:wrap;">
    <input id="typeName" placeholder="Enter Type" class="input" />
    <button id="addTypeBtn" class="small-btn">Add</button>
    <button id="clearTypesBtn" class="small-btn danger-btn">Clear</button>
  </div>
  <ul id="typeList" class="list-card"></ul>
</section>

<section id="stock" class="section">
  <div style="margin-bottom:10px;display:flex;gap:8px;flex-wrap:wrap;">
    <select id="productType" class="input" style="flex:1;">
        <option value="">Select Type</option>
    </select>
    <input id="productName" placeholder="Product Name" class="input" style="flex:1;" />
    <input id="productQty" type="number" placeholder="Qty" class="input" style="width:70px;" />
    <input id="productCost" type="number" placeholder="Cost" class="input" style="width:90px;" />
    <input id="productPrice" type="number" placeholder="Price" class="input" style="width:90px;" />
    <input id="productLimit" type="number" placeholder="Limit" class="input" style="width:70px;" />
    <button id="addStockBtn" class="small-btn">Add Stock</button>
    <button id="clearStockBtn" class="small-btn danger-btn">Clear</button>
  </div>

  <div style="margin-bottom:10px;display:flex;gap:8px;flex-wrap:wrap;">
    <input id="productSearch" placeholder="Search Product" class="input" />
    <select id="filterType" class="input"></select>
  </div>
  <table id="stockTable"></table>
</section>

<section id="sales" class="section">
  <div style="margin-bottom:10px;display:flex;gap:8px;flex-wrap:wrap;align-items:flex-end;">
    <div style="display:flex;flex-direction:column;gap:5px;">
      <small>Date</small>
      <input id="saleDate" type="date" class="input" style="width:140px;" />
    </div>
    <select id="saleType" class="input" style="flex:1;"></select>
    <input id="saleProduct" placeholder="Product Name" class="input" style="flex:2;" />
    <input id="saleQty" type="number" placeholder="Qty" class="input" style="width:70px;" />
    <input id="salePrice" type="number" placeholder="Price" class="input" style="width:90px;" />
  </div>
  <div style="margin-bottom:10px;display:flex;gap:8px;flex-wrap:wrap;align-items:flex-end;">
    <input id="saleCustomer" placeholder="Customer Name" class="input" style="flex:2;" />
    <input id="salePhone" type="tel" placeholder="Phone (Optional)" class="input" style="flex:1.5;" />
    <div style="display:flex;gap:8px;align-items:center;">
        <label><input type="radio" name="saleStatus" id="saleStatusPaid" value="Paid" checked> Paid</label>
        <label><input type="radio" name="saleStatus" id="saleStatusCredit" value="Credit"> Credit</label>
    </div>
    <button id="addSaleBtn" class="small-btn" style="height:38px;">Add Sale</button>
    <button id="clearSalesBtn" class="small-btn danger-btn" style="height:38px;">Clear All</button>
  </div>
  <table id="salesTable"></table>
</section>

<section id="wanting" class="section">
  <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;">
    <select id="wantType" class="input"></select>
    <input id="wantName" placeholder="Product Name" class="input" />
    <input id="wantNote" placeholder="Note" class="input" />
    <button id="addWantBtn" class="small-btn">Add</button>
  </div>
  <table id="wantingTable"></table>
</section>

<section id="service" class="section">
  <div style="margin-bottom:10px;display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:8px;">
    <input id="svcCustomer" placeholder="Customer Name" class="input" />
    <input id="svcPhone" type="tel" placeholder="Phone (Optional)" class="input" />
    <input id="svcItem" placeholder="Item Name (e.g., Laptop)" class="input" />
    <input id="svcModel" placeholder="Model (e.g., Dell 5590)" class="input" />
    <input id="svcPrice" type="number" placeholder="Price (â‚¹)" class="input" />
    <input id="svcCost" type="number" placeholder="Cost/Invest (â‚¹)" class="input" />
    <div style="display:flex;flex-direction:column;gap:5px;">
      <small>Date In</small>
      <input id="svcDateIn" type="date" class="input" />
    </div>
    <div style="display:flex;flex-direction:column;gap:5px;">
      <small>Date Out (Expected)</small>
      <input id="svcDateOut" type="date" class="input" />
    </div>
    <textarea id="svcProblem" placeholder="Problem Description" class="input" style="grid-column:1/-1;"></textarea>
    <textarea id="svcSolution" placeholder="Solution / Notes" class="input" style="grid-column:1/-1;"></textarea>
    <select id="svcStatusSelect" class="input" style="grid-column:1/3;">
        <option value="Pending">Pending</option>
        <option value="Completed">Completed (Paid)</option>
        <option value="Credit">Completed (Credit)</option>
        <option value="Failed/Returned">Failed/Returned</option>
    </select>
    <button id="addServiceBtn" class="small-btn" style="grid-column:3/-1;">Add Job</button>
    <button id="clearServiceBtn" class="small-btn danger-btn" style="grid-column:1/-1;margin-top:-5px;">Clear ALL Jobs</button>
  </div>
  <hr />
  <table id="svcTable"></table>
  <hr />
  <table id="svcHistoryTable"></table>
</section>

<section id="expenses" class="section">
  <div style="margin-bottom:10px;display:flex;gap:8px;flex-wrap:wrap;align-items:flex-end;">
    <div style="display:flex;flex-direction:column;gap:5px;">
      <small>Date</small>
      <input id="expDate" type="date" class="input" style="width:140px;" />
    </div>
    <input id="expCat" placeholder="Category (e.g., Rent, Salary)" class="input" style="flex:1;" />
    <input id="expAmount" type="number" placeholder="Amount (â‚¹)" class="input" style="width:120px;" />
    <input id="expNote" placeholder="Note (Optional)" class="input" style="flex:1.5;" />
    <button id="addExpenseBtn" class="small-btn" style="height:38px;">Add Expense</button>
    <button id="clearExpensesBtn" class="small-btn danger-btn" style="height:38px;">Clear All</button>
  </div>
  <div class="uni-sub" style="margin-bottom:10px;">
    Total Expenses: <span id="expTotal">â‚¹0</span>
  </div>
  <table id="expensesTable"></table>
</section>

<section id="creditHistory" class="section">
  <table id="collectionHistory"></table>
</section>

<section id="dashboard" class="section">
  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:20px;">
      <div class="card"><div class="uni-title">Today Sales</div><div class="uni-value" id="todaySales">â‚¹0</div></div>
      <div class="card"><div class="uni-title">Today Credit Sales</div><div class="uni-value" id="todayCredit">â‚¹0</div></div>
      <div class="card"><div class="uni-title">Today Expenses</div><div class="uni-value" id="todayExpenses">â‚¹0</div></div>
      <div class="card"><div class="uni-title">Today Gross Profit</div><div class="uni-value" id="todayGross">â‚¹0</div></div>
      <div class="card"><div class="uni-title">Today Net Profit</div><div class="uni-value" id="todayNet">â‚¹0</div></div>
  </div>
  <canvas id="cleanPie" style="max-width:100%;height:260px;"></canvas>
</section>

<section id="collection" class="section">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
    <h2 style="font-size:1.2em;color:var(--ks-text-main);">Pending Credit Collections</h2>
  </div>
  <table id="pendingCollectionTable"></table>
  
  <hr style="margin:20px 0;"/>
  
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
    <h2 style="font-size:1.2em;color:var(--ks-text-main);">Collection History</h2>
    <button id="clearCollectionBtn" class="small-btn danger-btn">Clear History</button>
  </div>
  <table id="collectionHistory"></table>
</section>

<script src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.umd.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore-compat.js"></script>

<script>
(function(){
  if (window.__ks_loader_injected) return;
  window.__ks_loader_injected = true;

  const v = Date.now();
  const files = [
    "/js/firebase.js",
    "/js/core.js",
    "/js/types.js",
    "/js/stock.js",
    "/js/sales.js",
    "/js/wanting.js",
    "/js/service.js",
    "/js/expenses.js",
    "/js/collection.js",
    "/js/universalBar.js",
    "/js/analytics.js"
  ];

  files.forEach(src => {
    const s = document.createElement("script");
    s.src = src + "?v=" + v;
    s.defer = true;
    document.head.appendChild(s);
  });
})();
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {

  /* CLOCK */
  function updateClock(){
    const d=new Date();
    qs("#clockTime").textContent = d.toLocaleTimeString();
    qs("#clockDate").textContent = d.toLocaleDateString();
  }
  setInterval(updateClock,1000); updateClock();

  /* THEME SWITCH */
  const saved = localStorage.getItem("ks-theme");
  if(saved==='dark'){
    document.body.classList.add("dark");
    qs("#themeBtn").textContent="â˜€ï¸";
  }
  qs("#themeBtn").onclick=()=>{
    const dark=document.body.classList.toggle("dark");
    localStorage.setItem("ks-theme",dark?'dark':'light');
    qs("#themeBtn").textContent=dark?"â˜€ï¸":"ğŸŒ™";
  };

  /* LOGOUT */
  qs("#logoutBtn").onclick=()=>{
    localStorage.removeItem("ks-user-email");
    location.href="/login.html";
  };

  /* TAB SWITCHING */
  document.addEventListener("click", e => {
    const t = e.target.closest(".tab");
    if(!t) return;

    const id = t.dataset.tab;

    qsa(".tab").forEach(x=>x.classList.remove("active"));
    t.classList.add("active");

    qsa(".section").forEach(s=>s.classList.remove("active"));
    qs("#"+id).classList.add("active");

    try{ window.updateUniversalBar?.(); }catch{}
  });

  /* COLLECT HANDLER */
  document.addEventListener("click", e => {
    const c = e.target.closest(".collect-btn");
    if(!c) return;
    try {
      window.handleCollect?.(c.dataset.collect);
    }catch(err){
      console.error("collect failed", err);
    }
  });
});
</script>
</body>
</html>
