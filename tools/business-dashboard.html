<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ğŸ“¦ KharchaSaathi â€” Business Manager</title>
  <meta name="theme-color" content="#e5edff" />
  <link rel="icon" href="/favicon.png" />
  <link rel="apple-touch-icon" href="/favicon.png" />

  <!-- keep existing external CSS references (they may be customized) -->
  <link rel="stylesheet" href="/css/base.css" />
  <link rel="stylesheet" href="/css/layout.css" />
  <link rel="stylesheet" href="/css/components.css" />

  <!-- Consolidated theme CSS (light/dark variables + table styles) -->
  <style>
    /* ... your CSS (unchanged) ... */
    :root{
      --ks-bg: #f3f4fb;
      --ks-bg-soft: #eef1ff;
      --ks-bg-card: #ffffff;
      --ks-border-soft: #e2e8f0;
      --ks-text-main: #0f172a;
      --ks-text-soft: #6b7280;
      --ks-accent: #2563eb;
      --ks-accent-soft: #3b82f6;
      --ks-accent-green: #16a34a;
      --ks-accent-orange:#ea580c;
      --ks-radius-card: 16px;
      --ks-radius-pill: 999px;
      --ks-shadow-soft: 0 14px 40px rgba(15,23,42,.08);
    }
    body.dark{ /* ... */ }
    /* rest of CSS omitted here for brevity â€” keep your original block */
  </style>
</head>
<body>

  <!-- IMPORTANT: define safe global helpers ONCE (avoid const redeclare errors) -->
  <script>
    // If some other script already created window.qs/window.qsa, reuse them.
    // This avoids "Identifier 'qs' has already been declared" when files load twice.
    window.qs = window.qs || (s => document.querySelector(s));
    window.qsa = window.qsa || (s => Array.from(document.querySelectorAll(s)));
  </script>

  <!-- Topbar + universal bar (unchanged) -->
  <div class="topbar">
    <h1>
      <div class="topbar-logo"><span>â‚¹</span></div>
      KHARCHASAATHI
    </h1>

    <div class="topbar-right" style="display:flex;align-items:center;gap:10px;">
      <span id="emailTag">Checking loginâ€¦</span>
      <div class="simple-clock" style="display:flex;flex-direction:column;align-items:flex-end;font-size:11px;">
        <span id="clockTime" class="clock-line">--:--:--</span>
        <span id="clockDate" class="clock-line small">--</span>
      </div>
      <button id="themeBtn" class="theme-btn">ğŸŒ™</button>
      <a class="small-btn" href="/index.html">ğŸ  Home</a>
      <button id="logoutBtn" class="small-btn">ğŸ”“ Logout</button>
    </div>
  </div>

  <div id="universalBar">
    <!-- ... universal cards as you had ... -->
  </div>

  <div id="tabSummaryBar">Profit: +â‚¹0</div>

  <div class="tabs" role="tablist" aria-label="Main tabs">
    <div class="tab active" data-tab="types">ğŸ“ Types</div>
    <div class="tab" data-tab="stock">ğŸ“¦ Stock</div>
    <div class="tab" data-tab="sales">ğŸ“ˆ Sales</div>
    <div class="tab" data-tab="wanting">ğŸ›’ Wanting</div>
    <div class="tab" data-tab="service">ğŸ›  Service</div>
    <div class="tab" data-tab="expenses">ğŸ’¸ Expenses</div>
    <div class="tab" data-tab="creditHistory">ğŸ§¾ Credit History</div>
    <div class="tab" data-tab="dashboard">ğŸ“Š Dashboard</div>
    <div class="tab" data-tab="collection">ğŸª™ Collection</div>
  </div>

  <!-- (all sections + markup unchanged â€” keep your original HTML sections here) -->
  <!-- ... (types, stock, sales, service, expenses, creditHistory, dashboard, collection) ... -->

  <!-- LIBRARIES -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.umd.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore-compat.js"></script>

  <!-- AUTO SCRIPT LOADER: keep marker to avoid double injections -->
  <script>
    (function () {
      const v = Date.now();
      const js = [
        "/js/core.js",
        "/js/firebase.js",
        "/js/types.js",
        "/js/stock.js",
        "/js/sales.js",
        "/js/wanting.js",
        "/js/expenses.js",
        "/js/analytics.js",
        "/js/service.js",
        "/js/collection.js",
        "/js/universalBar.js",
        "/js/security.js"
      ];
      if (!window.__ks_loader_injected) {
        window.__ks_loader_injected = true;
        js.forEach(f => {
          const s = document.createElement('script');
          s.src = f + "?v=" + v;
          s.defer = true;
          document.head.appendChild(s);
        });
      }
    })();
  </script>

  <!-- Part7: inline behaviors â€” use the global helpers without redeclaring them -->
  <script>
    // Use the global helpers (do NOT redeclare with const in global scope)
    const qs = window.qs;
    const qsa = window.qsa;

    // CLOCK
    function updateClock() {
      const d = new Date();
      if (qs("#clockTime")) qs("#clockTime").textContent = d.toLocaleTimeString();
      if (qs("#clockDate")) qs("#clockDate").textContent = d.toLocaleDateString();
    }
    setInterval(updateClock, 1000);
    updateClock();

    // THEME BUTTON
    (function initTheme(){
      const btn = document.getElementById("themeBtn");
      try {
        const saved = localStorage.getItem("ks-theme");
        if (saved === "dark") { document.body.classList.add("dark"); if (btn) btn.textContent = "â˜€ï¸"; }
        if (btn) btn.addEventListener("click", () => {
          const dark = document.body.classList.toggle("dark");
          localStorage.setItem("ks-theme", dark ? "dark" : "light");
          btn.textContent = dark ? "â˜€ï¸" : "ğŸŒ™";
        });
      } catch(e){ console.warn("theme init failed", e); }
    })();

    // SAFE handleCollect fallback (if collection.js not loaded yet)
    if (typeof window.handleCollect !== "function") {
      window.handleCollect = function(type){
        try {
          type = String(type || "").toLowerCase();
          const map = { net: "unNetProfit", stock: "unStockInv", service: "unServiceInv" };
          const el = qs("#" + (map[type] || ""));
          const raw = el ? (el.textContent || "").replace(/[â‚¹,]/g,"").trim() : "0";
          const amount = Number(raw) || 0;
          if (!amount) { alert("Nothing to collect for: " + type); return; }
          const now = new Date().toISOString().split("T")[0];
          const entry = { date: now, source: (type === "net") ? "Net Profit" : (type === "stock") ? "Stock Investment" : "Service Investment", details: `Collected from ${type}`, amount };
          window.collections = Array.isArray(window.collections) ? window.collections : [];
          window.collections.unshift(entry);
          try { window.saveCollections?.(); } catch {}
          if (el) el.textContent = "â‚¹0";
          try { window.renderCollection?.(); } catch {}
          try { window.updateUniversalBar?.(); } catch {}
          try { window.updateSummaryCards?.(); } catch {}
          alert("Collected â‚¹" + amount);
        } catch (e){ console.error("handleCollect fallback error", e); alert("Collect failed"); }
      };
    }

    // Collect button delegation (uses window.handleCollect)
    document.addEventListener("click", e => {
      const btn = e.target.closest(".collect-btn");
      if (!btn) return;
      const type = btn.dataset.collect;
      if (typeof window.handleCollect === "function") return window.handleCollect(type);
      alert("Collect handler missing");
    });

    // Tab switcher (idempotent)
    function switchTab(id) {
      qsa(".section").forEach(sec => sec.classList.remove("active"));
      const target = qs("#" + id);
      if (target) target.classList.add("active");
      qsa(".tab").forEach(t => t.classList.remove("active"));
      const tab = qs(`.tab[data-tab="${id}"]`); if (tab) tab.classList.add("active");

      // safe renders
      try { renderStock?.(); } catch {}
      try { renderSales?.(); } catch {}
      try { renderWanting?.(); } catch {}
      try { renderExpenses?.(); } catch {}
      try { renderServiceTables?.(); } catch {}
      try { renderCollection?.(); } catch {}
      try { renderAnalytics?.(); } catch {}
      try { updateSummaryCards?.(); } catch {}
      try { renderCreditHistory?.(); } catch {}
    }
    document.addEventListener("click", e => {
      if (e.target.classList.contains("tab")) {
        switchTab(e.target.dataset.tab);
      }
    });

    // Boot-time safe render hooks
    window.addEventListener("load", () => {
      try { updateEmailTag?.(); } catch {}
      try { renderCollection?.(); } catch {}
      try { renderCreditHistory?.(); } catch {}
      try { renderAnalytics?.(); } catch {}
      try { updateSummaryCards?.(); } catch {}
      try { updateTabSummaryBar?.(); } catch {}
      try { updateUniversalBar?.(); } catch {}
    });
  </script>

</body>
</html>
