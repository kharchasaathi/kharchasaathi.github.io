<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ğŸ“¦ KharchaSaathi â€” Business Dashboard v6.2.8</title>
<meta name="theme-color" content="#ff7a00">
<style>
:root{
  --orange:#ff7a00; --orange-dark:#cc6300;
  --bg:#f8f9fa; --card:#fff; --text:#222;
  --dark-bg:#0f0f0f; --dark-card:#1b1b1b; --dark-text:#f2f2f2;
  --dark-border:#444;
}
*{box-sizing:border-box;transition:background .3s,color .3s;}
body{font-family:Poppins,Arial,sans-serif;margin:0;padding:18px;background:var(--bg);color:var(--text);}
body.dark{background:var(--dark-bg);color:var(--dark-text);}
h1{color:var(--orange);}
.topbar{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;}
.theme-btn,.small-btn,.action-btn{
  background:var(--orange);color:#fff;border:none;
  padding:8px 10px;border-radius:8px;cursor:pointer;transition:.2s;
}
.theme-btn:hover,.small-btn:hover,.action-btn:hover{background:var(--orange-dark);}
.tabs{display:flex;gap:8px;margin:18px 0;justify-content:center;flex-wrap:wrap;}
.tab{background:#eee;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600;transition:.2s;}
body.dark .tab{background:#222;color:#ccc;}
.tab.active{background:var(--orange);color:#fff;}
.section{
  display:none;background:var(--card);
  padding:14px;border-radius:12px;
  box-shadow:0 6px 20px rgba(0,0,0,.08);
  margin-bottom:18px;position:relative;z-index:2;
}
.section.active{display:block;}
body.dark .section{
  background:var(--dark-card);
  border:1px solid var(--dark-border);
  box-shadow:0 0 12px rgba(255,255,255,0.05);
  color:var(--dark-text);
}
table{width:100%;border-collapse:collapse;margin-top:12px;}
th,td{padding:8px;border:1px solid #ddd;text-align:center;font-size:13px;}
th{background:var(--orange);color:#fff;}
body.dark th{background:var(--orange-dark);}
body.dark td{border:1px solid var(--dark-border);}
.low{color:#ffbb33;font-weight:700;}
.out{color:#ff5555;font-weight:700;}
.ok{color:#4eff90;font-weight:700;}
.footer-btns{text-align:center;margin-top:20px;}
.footer-btns a{background:var(--orange);color:#fff;padding:10px 16px;border-radius:8px;text-decoration:none;margin:6px;display:inline-block;}
.footer-btns a:hover{background:var(--orange-dark);}
.help-modal{
  position:fixed;top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.6);display:none;
  justify-content:center;align-items:center;z-index:1000;
}
.help-content{background:var(--card);padding:20px;max-width:550px;border-radius:12px;color:var(--text);overflow-y:auto;max-height:85vh;}
body.dark .help-content{background:var(--dark-card);color:var(--dark-text);}
input, select{
  padding:6px;border:1px solid #ccc;border-radius:6px;
  margin:4px;outline:none;font-size:14px;
}
body.dark input,body.dark select{
  background:#222;color:#fff;border:1px solid var(--dark-border);
}
</style>
</head>
<body>

<div class="topbar">
  <h1>ğŸ“¦ KharchaSaathi v6.2.8</h1>
  <button class="theme-btn" id="themeBtn">ğŸŒ™</button>
</div>

<div class="tabs">
  <div class="tab active" data-tab="types">ğŸ—‚ Types</div>
  <div class="tab" data-tab="stock">ğŸ“¦ Stock</div>
  <div class="tab" data-tab="sales">ğŸ“ˆ Sales</div>
  <div class="tab" data-tab="wanting">ğŸ›’ Wanting</div>
</div>

<!-- TYPES -->
<section id="types" class="section active">
  <h3>ğŸ—‚ Manage Item Types</h3>
  <input type="text" id="typeName" placeholder="Add new type">
  <button onclick="addType()">Add</button>
  <button class="small-btn" onclick="clearTypes()">Clear All</button>
  <ul id="typeList" style="margin-top:10px;padding-left:18px;"></ul>
</section>

<!-- STOCK -->
<section id="stock" class="section">
  <h3>ğŸ“¦ Current Stock</h3>
  <div>
    <label>Low Stock Limit: </label>
    <input type="number" id="globalLimit" placeholder="e.g. 2" style="width:80px">
    <button class="small-btn" onclick="setGlobalLimit()">Set</button>
    <button class="small-btn" onclick="clearStock()">Clear All</button>
  </div>
  <br>
  <input type="date" id="pdate">
  <select id="ptype"></select>
  <input type="text" id="pname" placeholder="Product name">
  <input type="number" id="pqty" placeholder="Qty">
  <button onclick="addStock()">Add</button>
  <br><br>
  <label><b>Filter by Type:</b></label>
  <select id="filterType" onchange="renderStock()">
    <option value="all">All Types</option>
  </select>

  <table id="stockTable">
    <thead>
      <tr>
        <th>Date</th><th>Type</th><th>Product</th><th>Qty</th><th>Sold</th><th>Remain</th>
        <th>Alert</th><th>Limit</th><th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<!-- SALES -->
<section id="sales" class="section">
  <h3>ğŸ’° Sales Ledger</h3>
  <button class="small-btn" onclick="clearSales()">ğŸ§¹ Clear All</button>
  <table id="salesTable">
    <thead><tr><th>Date</th><th>Type</th><th>Product</th><th>Qty</th><th>Price â‚¹</th><th>Total â‚¹</th><th>Status</th></tr></thead>
    <tbody></tbody>
    <tfoot><tr><td colspan="5" style="text-align:right">Total:</td><td id="dayTotal">0</td><td></td></tr></tfoot>
  </table>
</section>

<!-- WANTING -->
<section id="wanting" class="section">
  <h3>ğŸ›’ Wanting List</h3>
  <input type="date" id="wdate">
  <select id="wtype"></select>
  <input type="text" id="witem" placeholder="Item name">
  <button onclick="addWant()">Add</button>
  <button onclick="printWanting()">ğŸ–¨ï¸ Print</button>
  <table id="wantTable">
    <thead><tr><th>Date</th><th>Type</th><th>Item</th><th>Action</th></tr></thead>
    <tbody></tbody>
  </table>
</section>

<div class="footer-btns">
  <a href="#" onclick="toggleHelp()">ğŸ“˜ Help & Guide</a>
  <a href="../index.html">ğŸ  Back</a>
</div>

<!-- ğŸ“˜ Help -->
<div id="helpModal" class="help-modal">
  <div class="help-content">
    <h2>ğŸ“˜ KharchaSaathi â€” User Guide</h2>
    <ul>
      <li>ğŸ—‚ Create Types â†’ ğŸ“¦ Add Stock â†’ ğŸ’° Sell â†’ ğŸ›’ Auto Wanting â†’ âœ… Restock.</li>
      <li>ğŸ’° â€œSaleâ€ = Cash, ğŸ“’ â€œCreditâ€ = Khata.</li>
      <li>âš™ï¸ Set Low Stock Limit â†’ get automatic alerts.</li>
      <li>ğŸŒ™ Dark mode auto-saves your preference.</li>
      <li>ğŸ’¾ Offline + Cloud Sync (auto backup to Firebase)</li>
    </ul>
    <button onclick="toggleHelp()">Close</button>
  </div>
</div>

<!-- ğŸŒ™ THEME + FIREBASE + LOCAL LOGIC -->
<script type="module">
if(localStorage.getItem('theme')==='true') document.body.classList.add('dark');
document.getElementById('themeBtn').onclick=()=>{
  document.body.classList.toggle('dark');
  localStorage.setItem('theme',document.body.classList.contains('dark'));
};

import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyC1TSwODhcD88-IizbteOGF-bbebAP6Poc",
  authDomain: "kharchasaathi-main.firebaseapp.com",
  projectId: "kharchasaathi-main",
  storageBucket: "kharchasaathi-main.firebasestorage.app",
  messagingSenderId: "116390837159",
  appId: "1:116390837159:web:6e3900fa3b25a07d4c9482",
  measurementId: "G-1M4H9VRSBY"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

onAuthStateChanged(auth, async (user) => {
  if(!user){
    alert("âš ï¸ Please login first to access Dashboard!");
    window.location.href="../index.html";
    return;
  }

  const userId = user.uid;
  const userDoc = doc(db, "users", userId, "business_data", "dashboard");

  const snapshot = await getDoc(userDoc);
  if(!snapshot.exists()){
    await setDoc(userDoc,{
      createdAt:new Date().toLocaleString(),
      totalSales:0,
      totalStock:0,
      lastSync:new Date().toLocaleString()
    });
  } else {
    console.log("âœ… Cloud data loaded:", snapshot.data());
  }
  console.log("âœ… Cloud connected:", user.email);
});
</script>

<script>
/* âœ… Local Storage + UI Logic */
  if (!localStorage.getItem(K_TYPES)) localStorage.setItem(K_TYPES, "[]");
if (!localStorage.getItem(K_STOCK)) localStorage.setItem(K_STOCK, "[]");
if (!localStorage.getItem(K_SALES)) localStorage.setItem(K_SALES, "[]");
if (!localStorage.getItem(K_WANT)) localStorage.setItem(K_WANT, "[]");
const K_TYPES='item-types',K_STOCK='stock-data',K_SALES='sales-data',K_WANT='wanting-data',K_LIMIT='default-limit';
let types=JSON.parse(localStorage.getItem(K_TYPES)||'[]'),
stock=JSON.parse(localStorage.getItem(K_STOCK)||'[]'),
sales=JSON.parse(localStorage.getItem(K_SALES)||'[]'),
want=JSON.parse(localStorage.getItem(K_WANT)||'[]');

function saveAll(){localStorage.setItem(K_TYPES,JSON.stringify(types));
localStorage.setItem(K_STOCK,JSON.stringify(stock));
localStorage.setItem(K_SALES,JSON.stringify(sales));
localStorage.setItem(K_WANT,JSON.stringify(want));}

/* TYPES */
function addType(){const t=document.getElementById('typeName').value.trim();
if(!t)return alert("Enter a type name");
if(types.includes(t))return alert("Already exists");
types.push(t);saveAll();renderTypes();updateDropdowns();
document.getElementById('typeName').value='';}
function renderTypes(){document.getElementById('typeList').innerHTML=types.map(t=>`<li>${t}</li>`).join('')||'<li>No types yet</li>';}
function clearTypes(){if(confirm("Clear all types?")){types=[];saveAll();renderTypes();updateDropdowns();}}
function updateDropdowns(){['ptype','wtype','filterType'].forEach(id=>{
const el=document.getElementById(id);if(!el)return;
let extra=id==='filterType'?'<option value="all">All Types</option>':'<option value="">Select</option>';
el.innerHTML=extra+types.map(t=>`<option value="${t}">${t}</option>`).join('');});}

/* LIMIT + STOCK */
function setGlobalLimit(){const v=parseInt(document.getElementById('globalLimit').value);
if(isNaN(v)||v<0)return alert("Invalid limit");
localStorage.setItem(K_LIMIT,v);alert("Limit set "+v);}
function getLimit(){const v=parseInt(localStorage.getItem(K_LIMIT));return isNaN(v)?0:v;}
function addStock(){const date=document.getElementById('pdate').value,type=document.getElementById('ptype').value,name=document.getElementById('pname').value.trim(),qty=parseInt(document.getElementById('pqty').value);
if(!date||!type||!name||!qty)return alert("Fill all fields");
const ex=stock.find(s=>s.type===type&&s.name.toLowerCase()===name.toLowerCase());
if(ex){ex.qty+=qty;ex.date=date;}else{stock.push({date,type,name,qty,sold:0});}
saveAll();renderStock();}
function clearStock(){if(confirm("Clear all stock?")){stock=[];saveAll();renderStock();}}
function renderStock(){const filter=document.getElementById('filterType').value;
const tb=document.querySelector('#stockTable tbody');
tb.innerHTML=stock.filter(s=>filter==='all'||s.type===filter)
.map((s,i)=>{const sold=s.sold||0,rem=s.qty-sold,limit=getLimit();
let cls='ok',status='OK';
if(rem<=0){cls='out';status='OUT';}
else if(rem<=limit){cls='low';status='LOW';}
return `<tr><td>${s.date}</td><td>${s.type}</td><td>${s.name}</td>
<td>${s.qty}</td><td>${sold}</td><td>${rem}</td>
<td class="${cls}">${status}</td><td>${limit}</td>
<td><button onclick="sellItem(${i},'Paid')">ğŸ’° Sale</button>
<button onclick="sellItem(${i},'Credit')">ğŸ“’ Credit</button></td></tr>`;}).join('');}

/* SALES */
function sellItem(i,status){const s=stock[i],remain=s.qty-(s.sold||0);
if(remain<=0)return alert("No stock left!");
const qty=parseInt(prompt(`Enter qty (max ${remain})`));
if(!qty||qty>remain)return;
const price=parseFloat(prompt("Enter price â‚¹:"));
if(!price)return;
const date=new Date().toISOString().split('T')[0];
s.sold=(s.sold||0)+qty;
sales.push({date,type:s.type,product:s.name,qty,price,amount:qty*price,status});
saveAll();renderStock();renderSales();checkWantAuto(s);}
function renderSales(){const tb=document.querySelector('#salesTable tbody');let t=0;
tb.innerHTML=sales.map(s=>{t+=s.amount;return `<tr><td>${s.date}</td><td>${s.type}</td><td>${s.product}</td>
<td>${s.qty}</td><td>${s.price}</td><td>${s.amount}</td><td>${s.status}</td></tr>`;}).join('');
document.getElementById('dayTotal').textContent=t;}
function clearSales(){if(confirm("Clear sales?")){sales=[];saveAll();renderSales();}}

/* WANTING */
function checkWantAuto(s){const remain=s.qty-(s.sold||0);
if(remain<=0&&!want.find(w=>w.type===s.type&&w.item.toLowerCase()===s.name.toLowerCase())){
want.push({date:new Date().toISOString().split('T')[0],type:s.type,item:s.name});
saveAll();renderWant();}}
function addWant(){const date=document.getElementById('wdate').value,
type=document.getElementById('wtype').value,item=document.getElementById('witem').value.trim();
if(!date||!type||!item)return alert("Fill all");
if(want.find(w=>w.type===type&&w.item.toLowerCase()===item.toLowerCase()))
return alert("Already exists");
want.push({date,type,item});saveAll();renderWant();}
function renderWant(){const tb=document.querySelector('#wantTable tbody');
tb.innerHTML=want.map((w,i)=>`<tr><td>${w.date}</td><td>${w.type}</td><td>${w.item}</td>
<td><button onclick="restock(${i})">âœ… Restock</button>
<button onclick="delWant(${i})">ğŸ—‘ Delete</button></td></tr>`).join('');}
function restock(i){const q=parseInt(prompt("Enter Restock Qty:"));
if(!q||q<=0)return alert("Invalid qty");
const w=want[i];const date=new Date().toISOString().split('T')[0];
const ex=stock.find(s=>s.type===w.type&&s.name.toLowerCase()===w.item.toLowerCase());
if(ex){ex.qty+=q;}else{stock.push({date,type:w.type,name:w.item,qty:q,sold:0});}
want.splice(i,1);saveAll();renderStock();renderWant();
alert(`âœ… ${q} of "${w.item}" added to Stock & removed from Wanting.`);}
function delWant(i){want.splice(i,1);saveAll();renderWant();}
function printWanting(){const w=window.open('','_blank');
w.document.write('<h3>ğŸ›’ Wanting List</h3>'+document.getElementById('wantTable').outerHTML);
w.document.close();w.print();}

/* HELP + INIT */
function toggleHelp(){const h=document.getElementById('helpModal');
h.style.display=h.style.display==='flex'?'none':'flex';}
functionwindow.onload = () => {
  renderAll();
};
{renderTypes();updateDropdowns();renderStock();renderSales();renderWant();}
renderAll();
</script>
</body>
</html>
