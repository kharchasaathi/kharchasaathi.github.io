<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üì¶ KharchaSaathi ‚Äî Business Manager</title>
  <meta name="theme-color" content="#e5edff" />
  <link rel="icon" href="/favicon.png" />
  <link rel="apple-touch-icon" href="/favicon.png" />

  <!-- external CSS -->
  <link rel="stylesheet" href="/css/base.css" />
  <link rel="stylesheet" href="/css/layout.css" />
  <link rel="stylesheet" href="/css/components.css" />
  <link rel="stylesheet" href="/css/style.css" />
  <link rel="stylesheet" href="/css/table.css" />

  <style>
    /* ===================== TOPBAR FIX (DARK SAFE) ===================== */
    .topbar{
      position:sticky; top:0; z-index:50;
      display:flex; justify-content:space-between; align-items:center;
      padding:10px 18px;
      background:var(--ks-bg-card);
      border-bottom:1px solid var(--ks-border-soft);
      backdrop-filter:blur(12px);
    }
    body.dark .topbar{
      background:var(--ks-bg-card);
      color:var(--ks-text-main);
    }
    .topbar h1{ margin:0; font-size:20px; display:flex; gap:10px; align-items:center; font-weight:700; }
    .topbar-logo{
      width:32px;height:32px;border-radius:999px;
      display:flex;align-items:center;justify-content:center;
      background:linear-gradient(135deg,var(--ks-accent-green),var(--ks-accent));
      color:#fff;
    }

    /* ===================== UNIVERSAL BAR FIX ===================== */
    #universalBar{
      padding:12px 14px;
      border-bottom:1px solid var(--ks-border-soft);
      background:linear-gradient(to bottom,var(--ks-bg-soft) 40%,transparent);
    }
    body.dark #universalBar{
      background:linear-gradient(to bottom,var(--ks-bg-soft) 30%,transparent);
    }

    .uni-title{ font-size:13px; opacity:.75; margin-bottom:4px; }
    .uni-value{ font-size:22px; font-weight:700; margin-bottom:6px; }
    .uni-sub{ display:flex; gap:10px; flex-wrap:wrap; font-size:12px; opacity:.85; }

    .collect-btn{
      position:absolute;
      right:10px;
      bottom:10px;
      padding:5px 12px;
      border-radius:999px;
      border:1px solid var(--ks-accent);
      background:var(--ks-bg-soft);
      color:var(--ks-accent);
      font-size:11px;
    }
    body.dark .collect-btn{
      background:var(--ks-bg-card);
      color:var(--ks-accent-soft);
    }

    /* ===================== SUMMARY BAR ===================== */
    #tabSummaryBar{
      text-align:center;
      padding:8px;
      margin:10px auto;
      max-width:1160px;
      border-radius:999px;
      background:var(--ks-bg-soft);
      color:var(--ks-accent-green);
      font-weight:600;
    }

    /* ===================== SECTION AREA ===================== */
    .section{
      display:none;
      padding:16px 14px 28px;
      max-width:1160px;
      margin:0 auto;
    }
    .section.active{ display:block; }

    /* ===================== TABS ===================== */
    .tabs{
      display:flex;
      gap:10px;
      overflow-x:auto;
      padding:10px;
    }
    .tab{
      padding:9px 18px;
      border-radius:999px;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
      white-space:nowrap;
      background:var(--ks-bg-card);
      color:var(--ks-text-soft);
      border:1px solid var(--ks-border-soft);
    }
    .tab.active{
      background:var(--ks-accent);
      color:#fff;
    }
    body.dark .tab{
      background:var(--ks-bg-card);
      color:var(--ks-text-soft);
    }
    body.dark .tab.active{
      background:var(--ks-accent-soft);
      color:#fff;
    }
  </style>
</head>
<body>

<script>
  const qs = s => document.querySelector(s);
  const qsa = s => Array.from(document.querySelectorAll(s));
</script>

<!-- ===================== TOPBAR ===================== -->
<div class="topbar">
  <h1><div class="topbar-logo">‚Çπ</div>KHARCHASAATHI</h1>

  <div style="display:flex;gap:10px;align-items:center;">
    <span id="emailTag">Checking login‚Ä¶</span>
    <div style="text-align:right;font-size:12px;">
      <div id="clockTime">--:--:--</div>
      <div id="clockDate">--</div>
    </div>
    <button id="themeBtn" class="small-btn">üåô</button>
    <a class="small-btn" href="/index.html">üè† Home</a>
    <button id="logoutBtn" class="small-btn danger-btn">üîì Logout</button>
  </div>
</div>

<!-- ===================== UNIVERSAL BAR ===================== -->
<div id="universalBar">
  <div style="max-width:1160px;margin:0 auto;display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;">
    
    <!-- ‚≠ê NET PROFIT -->
    <div class="card" style="position:relative;">
      <button class="collect-btn" data-collect="net">‚Çπ Collect</button>
      <div class="uni-title">Net Profit (Sale + Service ‚àí Expense)</div>
      <div class="uni-value" id="unNetProfit">‚Çπ0</div>
      <div class="uni-sub">
        <span>Sale:</span><span id="unSaleProfit">‚Çπ0</span>
        <span>Service:</span><span id="unServiceProfit">‚Çπ0</span>
        <span>Exp:</span><span id="unExpenses">‚Çπ0</span>
      </div>
    </div>

    <!-- ‚≠ê STOCK INVESTMENT -->
    <div class="card" style="position:relative;">
      <button class="collect-btn" data-collect="stock">‚Çπ Collect</button>
      <div class="uni-title">Stock Investment (Sold Items)</div>
      <div class="uni-value" id="unStockInv">‚Çπ0</div>
    </div>

    <!-- ‚≠ê SERVICE INVESTMENT -->
    <div class="card" style="position:relative;">
      <button class="collect-btn" data-collect="service">‚Çπ Collect</button>
      <div class="uni-title">Service Investment (Completed)</div>
      <div class="uni-value" id="unServiceInv">‚Çπ0</div>
    </div>

    <!-- ‚≠ê CREDIT -->
    <div class="card">
      <div class="uni-title">Pending Credit</div>
      <div class="uni-value" id="unCreditSales">‚Çπ0</div>
    </div>

  </div>
</div>

<!-- ===================== SUMMARY BAR ===================== -->
<div id="tabSummaryBar">Profit: +‚Çπ0</div>

<!-- ===================== TABS ===================== -->
<div class="tabs" role="tablist">
  <div class="tab active" data-tab="types">üìÅ Types</div>
  <div class="tab" data-tab="stock">üì¶ Stock</div>
  <div class="tab" data-tab="sales">üìà Sales</div>
  <div class="tab" data-tab="wanting">üõí Wanting</div>
  <div class="tab" data-tab="service">üõ† Service</div>
  <div class="tab" data-tab="expenses">üí∏ Expenses</div>
  <div class="tab" data-tab="creditHistory">üßæ Credit History</div>
  <div class="tab" data-tab="dashboard">üìä Dashboard</div>
  <div class="tab" data-tab="collection">ü™ô Collection</div>
</div>

<!-- ===================== SECTIONS WITH STRUCTURE ===================== -->

<!-- ‚≠ê TYPES -->
<section id="types" class="section active">
  <div style="margin-bottom:10px;display:flex;gap:8px;">
    <input id="typeName" placeholder="Enter Type" />
    <button id="addTypeBtn">Add</button>
    <button id="clearTypesBtn" class="danger-btn">Clear</button>
  </div>
  <ul id="typeList" class="list-card"></ul>
</section>

<!-- ‚≠ê STOCK -->
<section id="stock" class="section">
  <div style="margin-bottom:10px;display:flex;gap:8px;flex-wrap:wrap;">
    <input id="productSearch" placeholder="Search Product" />
    <select id="filterType"></select>
  </div>
  <table id="stockTable" class="table"></table>
</section>

<!-- ‚≠ê SALES -->
<section id="sales" class="section">
  <select id="saleType"></select>
  <table id="salesTable" class="table"></table>
</section>

<!-- ‚≠ê WANTING -->
<section id="wanting" class="section">
  <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;">
    <select id="wantType"></select>
    <input id="wantName" placeholder="Product Name"/>
    <input id="wantNote" placeholder="Note"/>
  </div>
  <table id="wantingTable" class="table"></table>
</section>

<!-- ‚≠ê SERVICE -->
<section id="service" class="section">
  <table id="svcTable" class="table"></table>
  <hr/>
  <table id="svcHistoryTable" class="table"></table>
</section>

<!-- ‚≠ê EXPENSES -->
<section id="expenses" class="section">
  <table id="expensesTable" class="table"></table>
</section>

<!-- ‚≠ê CREDIT HISTORY -->
<section id="creditHistory" class="section">
  <table id="collectionHistory" class="table"></table>
</section>

<!-- ‚≠ê DASHBOARD -->
<section id="dashboard" class="section">
  <!-- analytics.js will render charts here -->
  <canvas id="salesBar"></canvas>
  <canvas id="salesPie"></canvas>
  <canvas id="svcPie"></canvas>
</section>

<!-- ‚≠ê COLLECTION -->
<section id="collection" class="section">
  <table id="creditSalesCollected" class="table"></table>
  <table id="creditServiceCollected" class="table"></table>
</section>

<!-- ===================== LIBS ===================== -->
<script src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.umd.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore-compat.js"></script>

<!-- ===================== SCRIPT LOADER ===================== -->
<script>
(function(){
  if (window.__ks_loader_injected) return;
  window.__ks_loader_injected = true;

  const v = Date.now();
  const files = [
    "/js/firebase.js",
    "/js/core.js",
    "/js/types.js",
    "/js/stock.js",
    "/js/sales.js",
    "/js/wanting.js",
    "/js/service.js",
    "/js/expenses.js",
    "/js/collection.js",
    "/js/universalBar.js",
    "/js/analytics.js"
  ];

  files.forEach(src => {
    const s = document.createElement("script");
    s.src = src + "?v=" + v;
    s.defer = true;
    document.head.appendChild(s);
  });
})();
</script>

<!-- ===================== RUNTIME UI ===================== -->
<script>
(function() {
  document.addEventListener("DOMContentLoaded", () => {
    
    // CLOCK
    function updateClock(){
      const d=new Date();
      qs("#clockTime").textContent = d.toLocaleTimeString();
      qs("#clockDate").textContent = d.toLocaleDateString();
    }
    setInterval(updateClock,1000); updateClock();

    // THEME
    const btn = qs("#themeBtn");
    const saved = localStorage.getItem("ks-theme");
    if(saved==='dark'){ document.body.classList.add("dark"); btn.textContent="‚òÄÔ∏è"; }

    btn.addEventListener("click", ()=>{
      const dark = document.body.classList.toggle("dark");
      localStorage.setItem("ks-theme", dark?'dark':'light');
      btn.textContent = dark ? "‚òÄÔ∏è" : "üåô";
    });

    // LOGOUT
    qs("#logoutBtn").addEventListener("click", async ()=>{
      if (typeof fsLogout === "function") { await fsLogout(); return; }
      localStorage.removeItem("ks-user-email");
      location.href="/login.html";
    });

    // TAB SWITCH
    document.addEventListener("click", e => {
      const t = e.target.closest(".tab");
      if(!t) return;
      const id=t.dataset.tab;

      qsa(".tab").forEach(x=>x.classList.remove("active"));
      t.classList.add("active");

      qsa(".section").forEach(s=>s.classList.remove("active"));
      const sec = document.getElementById(id);
      if (sec) sec.classList.add("active");

      try{ window.updateUniversalBar?.(); }catch{}
    });

    // COLLECT
    document.addEventListener("click", e => {
      const c = e.target.closest(".collect-btn");
      if(!c) return;
      const type=c.dataset.collect;
      try { window.handleCollect?.(type); }
      catch(err){ console.error("collect failed", err); }
    });

  });
})();
</script>

</body>
</html>
