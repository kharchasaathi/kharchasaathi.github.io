<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>üì¶ KharchaSaathi ‚Äî Business Dashboard (Stable)</title>
<meta name="theme-color" content="#ff7a00">
<style>
:root{
  --orange:#ff7a00;--orange-dark:#cc6300;
  --bg:#f8f9fa;--card:#fff;--text:#222;
  --dark-bg:#0f0f0f;--dark-card:#1b1b1b;--dark-text:#f2f2f2;
  --dark-border:#444;
}
*{box-sizing:border-box;transition:background .2s,color .2s}
body{font-family:Poppins,Arial,sans-serif;margin:0;padding:18px;background:var(--bg);color:var(--text)}
body.dark{background:var(--dark-bg);color:var(--dark-text)}
h1{color:var(--orange);margin:0;font-size:20px}
.topbar{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:14px}
.theme-btn,.small-btn{background:var(--orange);color:#fff;border:none;padding:8px 10px;border-radius:8px;cursor:pointer;transition:.15s}
.theme-btn:hover,.small-btn:hover{background:var(--orange-dark)}
.tabs{display:flex;gap:8px;margin:6px 0 18px;justify-content:center;flex-wrap:wrap}
.tab{background:#eee;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600}
body.dark .tab{background:#222;color:#ccc}
.tab.active{background:var(--orange);color:#fff}
.section{display:none;background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,.06);margin-bottom:18px}
.section.active{display:block}
body.dark .section{background:var(--dark-card);border:1px solid var(--dark-border);color:var(--dark-text)}
.footer-btns{text-align:center;margin-top:20px}
.footer-btns a{background:var(--orange);color:#fff;padding:10px 16px;border-radius:8px;text-decoration:none;margin:6px;display:inline-block}
.footer-btns a:hover{background:var(--orange-dark)}
.help-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:none;justify-content:center;align-items:center;z-index:1000}
.help-content{background:var(--card);padding:20px;max-width:640px;border-radius:12px;color:var(--text);overflow-y:auto;max-height:85vh}
body.dark .help-content{background:var(--dark-card);color:var(--dark-text)}
.ok{color:green;font-weight:600}
.low{color:orange;font-weight:600}
.out{color:red;font-weight:700}
table{width:100%;border-collapse:collapse;margin-top:12px}
th,td{border:1px solid #ddd;padding:6px 8px;text-align:center}
th{background:var(--orange);color:#fff}
body.dark th{background:var(--orange-dark)}
</style>
</head>

<body>
<div class="topbar">
  <h1>üì¶ KharchaSaathi (Offline)</h1>
  <div style="display:flex;gap:8px;align-items:center">
    <button class="theme-btn" id="themeBtn">üåô</button>
    <a class="small-btn" href="../index.html">üè† Back</a>
  </div>
</div>

<div class="tabs" role="tablist">
  <div class="tab active" data-tab="types">üóÇ Types</div>
  <div class="tab" data-tab="stock">üì¶ Stock</div>
  <div class="tab" data-tab="sales">üìà Sales</div>
  <div class="tab" data-tab="wanting">üõí Wanting</div>
</div>

<!-- Sections -->
<section id="types" class="section active">
  <h3>üóÇ Manage Item Types</h3>
  <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
    <input type="text" id="typeName" placeholder="Add new type (e.g. Mobiles, Accessories)" style="flex:1;min-width:200px">
    <button id="addTypeBtn">Add</button>
    <button class="small-btn" id="clearTypesBtn">Clear All</button>
  </div>
  <ul id="typeList" style="margin-top:10px;padding-left:18px"></ul>
</section>

<section id="stock" class="section">
  <h3>üì¶ Current Stock</h3>
  <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
    <label>Low Stock Limit:</label>
    <input type="number" id="globalLimit" placeholder="e.g. 2" style="width:100px">
    <button class="small-btn" id="setLimitBtn">Set</button>
    <button class="small-btn" id="clearStockBtn">Clear All</button>
  </div>

  <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
    <input type="date" id="pdate" style="min-width:150px">
    <select id="ptype" style="min-width:140px"></select>
    <input type="text" id="pname" placeholder="Product name" style="min-width:160px">
    <input type="number" id="pqty" placeholder="Qty" style="width:80px">
    <input type="number" id="pcost" placeholder="Cost ‚Çπ" style="width:100px">
    <button id="addStockBtn">Add</button>
  </div>

  <div style="margin-top:12px">
    <label><b>Filter by Type:</b></label>
    <select id="filterType" style="min-width:160px"><option value="all">All Types</option></select>
  </div>

  <table id="stockTable">
    <thead><tr><th>Date</th><th>Type</th><th>Product</th><th>Qty</th><th>Sold</th><th>Remain</th><th>Alert</th><th>Limit</th><th>Action</th></tr></thead>
    <tbody></tbody>
  </table>
</section>

<section id="sales" class="section">
  <h3>üìà Sales (coming soon...)</h3>
  <p>Sales ledger and profit tracking will be added next update.</p>
</section>

<section id="wanting" class="section">
  <h3>üõí Wanting (coming soon...)</h3>
  <p>Auto wanting & reminders section will appear here.</p>
</section>

<div class="footer-btns">
  <a href="#" id="helpLink">üìò Help & Guide</a>
</div>

<!-- Help Modal -->
<div id="helpModal" class="help-modal">
  <div class="help-content">
    <h2>üìò Quick Help</h2>
    <ul style="padding-left:18px;line-height:1.6">
      <li>üóÇ Add & manage item <b>Types</b></li>
      <li>üì¶ Add stock, set low limit, auto alert</li>
      <li>üí∞ Record Sales (Cash / Credit)</li>
      <li>üõí Auto Wanting when stock finishes</li>
      <li>‚òÅÔ∏è Data saved offline</li>
    </ul>
    <button class="small-btn" onclick="toggleHelp()">Close</button>
  </div>
</div>

<script>
/* üåô Theme Toggle */
if(localStorage.getItem('ks-theme')==='dark')document.body.classList.add('dark');
document.getElementById('themeBtn').onclick=()=>{
  document.body.classList.toggle('dark');
  localStorage.setItem('ks-theme',document.body.classList.contains('dark')?'dark':'light');
};

/* Tabs */
const tabs=document.querySelectorAll('.tab'),sections=document.querySelectorAll('.section');
tabs.forEach(tab=>{
  tab.addEventListener('click',()=>{
    tabs.forEach(t=>t.classList.remove('active'));
    sections.forEach(s=>s.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById(tab.dataset.tab)?.classList.add('active');
  });
});

/* Help */
function toggleHelp(){
  const m=document.getElementById('helpModal');
  m.style.display=m.style.display==='flex'?'none':'flex';
}
document.getElementById('helpLink').onclick=e=>{e.preventDefault();toggleHelp();};

/* ===== TYPES + STOCK LOGIC ===== */
const K_TYPES='item-types',K_STOCK='stock-data',K_LIMIT='default-limit';
window.types=JSON.parse(localStorage.getItem(K_TYPES)||'["Mobiles","Accessories"]');
window.stock=JSON.parse(localStorage.getItem(K_STOCK)||'[]');
function saveAll(){localStorage.setItem(K_TYPES,JSON.stringify(types));localStorage.setItem(K_STOCK,JSON.stringify(stock));}
function renderTypes(){typeList.innerHTML=types.map(t=>`<li>${t}</li>`).join('');}
function updateDropdowns(){
  ['ptype','filterType'].forEach(id=>{
    const el=document.getElementById(id);
    if(!el)return;
    const base=id==='filterType'?'<option value="all">All Types</option>':'<option value="">Select</option>';
    el.innerHTML=base+types.map(t=>`<option value="${t}">${t}</option>`).join('');
  });
}
function addType(){
  const t=typeName.value.trim();
  if(!t)return alert('Enter type');
  if(types.includes(t))return alert('Exists');
  types.push(t);saveAll();renderTypes();updateDropdowns();typeName.value='';
}
function clearTypes(){if(confirm('Clear all types?')){types=[];saveAll();renderTypes();updateDropdowns();}}
function setGlobalLimit(){const v=parseInt(globalLimit.value);if(isNaN(v)||v<0)return alert('Invalid');localStorage.setItem(K_LIMIT,v);alert('Limit set '+v);}
function getLimit(){const v=parseInt(localStorage.getItem(K_LIMIT));return isNaN(v)?0:v;}
function addStock(){
  const d=pdate.value,t=ptype.value,n=pname.value.trim(),q=parseInt(pqty.value),c=parseFloat(pcost.value);
  if(!d||!t||!n||!q||!c)return alert('Fill all fields');
  let ex=stock.find(s=>s.type===t&&s.name.toLowerCase()===n.toLowerCase());
  if(ex){ex.qty+=q;ex.date=d;ex.cost=c;ex.history=ex.history||[];ex.history.push({date:d,qty:q,cost:c});}
  else stock.push({date:d,type:t,name:n,qty:q,sold:0,cost:c,history:[{date:d,qty:q,cost:c}]});
  saveAll();renderStock();pname.value='';pqty.value='';pcost.value='';
}
function renderStock(){
  const f=filterType.value,tb=document.querySelector('#stockTable tbody');
  tb.innerHTML=stock.filter(s=>f==='all'||s.type===f).map((s,i)=>{
    const sold=s.sold||0,rem=s.qty-sold,lim=getLimit();
    let cls='ok',msg='OK';if(rem<=0){cls='out';msg='OUT'}else if(rem<=lim){cls='low';msg='LOW'}
    return `<tr><td>${s.date}</td><td>${s.type}</td><td>${s.name}</td><td>${s.qty}</td><td>${sold}</td><td>${rem}</td><td class="${cls}">${msg}</td><td>${lim}</td><td><button onclick="viewHistory(${i})">üìú</button></td></tr>`;
  }).join('')||'<tr><td colspan="9">No Data</td></tr>';
}
function viewHistory(i){
  const s=stock[i];
  if(!s.history)return alert('No history');
  alert(`üìú ${s.name}:\n`+s.history.map(h=>`${h.date} ‚Äî Qty:${h.qty} @‚Çπ${h.cost}`).join('\n'));
}
document.addEventListener('click',e=>{
  if(e.target.id==='addTypeBtn')addType();
  if(e.target.id==='clearTypesBtn')clearTypes();
  if(e.target.id==='setLimitBtn')setGlobalLimit();
  if(e.target.id==='clearStockBtn'){if(confirm('Clear all stock?')){stock=[];saveAll();renderStock();}}
  if(e.target.id==='addStockBtn')addStock();
});
filterType?.addEventListener('change',renderStock);
window.addEventListener('load',()=>{renderTypes();updateDropdowns();renderStock();});
</script>
  <!-- ===== PART: Sales + Profit Module (STEP 1) ===== -->
<section id="sales" class="section">
  <h3>üí∞ Sales & Profit</h3>

  <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:10px;">
    <label>Sale Date:</label>
    <input type="date" id="saleDate" style="min-width:150px">
    <label>Type</label>
    <select id="saleType" style="min-width:140px"></select>
    <label>Product</label>
    <select id="saleProduct" style="min-width:180px"></select>
    <input type="number" id="saleQty" placeholder="Qty" style="width:80px">
    <input type="number" id="salePrice" placeholder="Sale ‚Çπ" style="width:100px">
    <select id="saleStatus" style="min-width:100px">
      <option value="Paid">Paid</option>
      <option value="Credit">Credit</option>
    </select>
    <button id="addSaleBtn">Add Sale</button>
  </div>

  <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:8px;">
    <label>GST?</label>
    <input type="checkbox" id="includeGst"><input type="number" id="gstPercent" placeholder="GST %" style="width:80px" value="0">
    <button id="viewSalesBtn" class="small-btn">View by Date</button>
    <button id="printSalesBtn" class="small-btn">Print</button>

    <!-- Admin controls for profit column -->
    <div style="margin-left:auto;display:flex;gap:8px;align-items:center;">
      <button id="toggleProfitBtn" class="small-btn">üîí Lock/Unlock Profit</button>
      <button id="setAdminBtn" class="small-btn">Set Admin PW</button>
    </div>
  </div>

  <table id="salesTable" aria-label="Sales table">
    <thead>
      <tr>
        <th>Date</th><th>Type</th><th>Product</th><th>Qty</th><th>Price ‚Çπ</th><th>Total ‚Çπ</th><th>Profit ‚Çπ</th><th>Status</th>
      </tr>
    </thead>
    <tbody></tbody>
    <tfoot>
      <tr>
        <td colspan="5" style="text-align:right">Total:</td>
        <td id="salesTotal">0</td>
        <td id="profitTotal">0</td>
        <td></td>
      </tr>
    </tfoot>
  </table>
</section>

<script>
/* Sales + Profit Module
   - plugs into existing window.stock and localStorage
   - stores sales in localStorage key 'sales-data'
   - profit column can be locked (admin password)
*/

/* --- Setup data stores --- */
window.sales = JSON.parse(localStorage.getItem('sales-data') || '[]');
const SALES_KEY = 'sales-data';
const ADMIN_KEY = 'ks-admin-pw'; // stored hashed? using plain here for simplicity (you can replace with better hashing)

/* --- Helper: persist sales --- */
function saveSales(){
  localStorage.setItem(SALES_KEY, JSON.stringify(sales));
  try{ if(typeof saveAllLocal === 'function') saveAllLocal(); }catch(e){}
}

/* --- Utility: default admin pw if none --- */
if(!localStorage.getItem(ADMIN_KEY)){
  localStorage.setItem(ADMIN_KEY, 'admin123'); // default, change via Set Admin PW
}

/* --- DOM refs --- */
const saleDate = document.getElementById('saleDate');
const saleType = document.getElementById('saleType');
const saleProduct = document.getElementById('saleProduct');
const saleQty = document.getElementById('saleQty');
const salePrice = document.getElementById('salePrice');
const saleStatus = document.getElementById('saleStatus');
const includeGst = document.getElementById('includeGst');
const gstPercent = document.getElementById('gstPercent');

const salesTableBody = document.querySelector('#salesTable tbody');
const salesTotalEl = document.getElementById('salesTotal');
const profitTotalEl = document.getElementById('profitTotal');

/* --- Init saleDate to today if empty --- */
const today = new Date().toISOString().split('T')[0];
if(saleDate && !saleDate.value) saleDate.value = today;

/* --- Populate Type and Product selects from window.stock/types --- */
function refreshSaleSelectors(){
  // types
  const typesList = Array.isArray(window.types) ? window.types : (window.types = JSON.parse(localStorage.getItem('item-types')||'[]'));
  saleType.innerHTML = `<option value="">All Types</option>` + typesList.map(t=>`<option value="${t}">${t}</option>`).join('');
  // products (unique across stock)
  const prodOptions = (window.stock || []).map(s => ({type:s.type,name:s.name})).filter((v,i,a)=>
    a.findIndex(x=>x.type===v.type&&x.name===v.name)===i
  );
  saleProduct.innerHTML = '<option value="">Select</option>' + prodOptions.map(p=>`<option value="${p.type}|||${p.name}">${p.type} ‚Äî ${p.name}</option>`).join('');
}

/* on type change, filter products */
saleType?.addEventListener('change', ()=>{
  const t = saleType.value;
  const filtered = (window.stock || []).filter(s=>!t||s.type===t)
    .map(s=>({type:s.type,name:s.name}))
    .filter((v,i,a)=>a.findIndex(x=>x.type===v.type&&x.name===v.name)===i);
  saleProduct.innerHTML = '<option value="">Select</option>' + filtered.map(p=>`<option value="${p.type}|||${p.name}">${p.type} ‚Äî ${p.name}</option>`).join('');
});

/* --- Compute average cost for a product (from its history) --- */
function getProductCost(type, name){
  const ex = (window.stock || []).find(s => s.type === type && s.name.toLowerCase() === name.toLowerCase());
  if(!ex) return 0;
  // Prefer explicit cost if stored
  if(ex.cost) return parseFloat(ex.cost) || 0;
  // otherwise use history average
  if(Array.isArray(ex.history) && ex.history.length){
    const tot = ex.history.reduce((acc,h)=>acc + (h.qty*(h.cost||0)), 0);
    const qtot = ex.history.reduce((acc,h)=>acc + (h.qty||0), 0);
    return qtot ? (tot / qtot) : 0;
  }
  return 0;
}

/* --- Add sale handler --- */
function addSale(){
  const d = saleDate.value || today;
  const prodVal = saleProduct.value;
  const qty = parseInt(saleQty.value,10);
  const price = parseFloat(salePrice.value);
  const status = saleStatus.value || 'Paid';
  if(!prodVal) return alert('Select product');
  if(!qty || qty <= 0) return alert('Invalid qty');
  if(!price || price <= 0) return alert('Invalid price');

  const [type, name] = prodVal.split('|||');

  // find stock item and remaining
  const sIndex = (window.stock || []).findIndex(s => s.type === type && s.name.toLowerCase() === name.toLowerCase());
  let remain = 0;
  if(sIndex >= 0){
    const stockItem = window.stock[sIndex];
    const soldSoFar = stockItem.sold || 0;
    remain = (stockItem.qty || 0) - soldSoFar;
    if(qty > remain) {
      if(!confirm(`Only ${remain} remaining in stock. Proceed to sell ${qty} anyway?`)) return;
    }
    // Update sold (but don't reduce qty entries ‚Äî keep original qty + sold)
    stockItem.sold = (stockItem.sold || 0) + qty;
    // persist stock
    try{ if(typeof saveAllLocal === 'function') saveAllLocal(); }catch(e){}
  }

  // cost & profit calculation
  let cost = getProductCost(type, name) || 0;
  let netSalePrice = price;
  if(includeGst.checked){
    const g = parseFloat(gstPercent.value) || 0;
    if(g > 0) netSalePrice = price / (1 + (g/100));
  }
  const profit = ((netSalePrice - cost) * qty);

  // create sale entry
  const entry = {
    date: d,
    type,
    product: name,
    qty,
    price,
    amount: price * qty,
    costPerUnit: cost,
    profit: Math.round(profit*100)/100,
    status
  };
  sales.push(entry);
  saveSales();

  // re-render
  renderSales();
  // reset inputs
  saleQty.value = '';
  salePrice.value = '';
  // re-render stock table if function exists
  try{ if(typeof renderStock === 'function') renderStock(); }catch(e){}
}

/* --- Render sales table (optionally filter by date) --- */
function renderSales(filterDate){
  const tb = salesTableBody;
  const list = (window.sales || []);
  const rows = (filterDate ? list.filter(s => s.date === filterDate) : list);
  let total = 0, pTotal = 0;
  tb.innerHTML = (rows.length ? rows.map((s,i) => {
    total += (s.amount || 0);
    pTotal += (s.profit || 0);
    return `<tr data-index="${i}">
      <td>${s.date}</td>
      <td>${escapeHtml(s.type)}</td>
      <td>${escapeHtml(s.product)}</td>
      <td>${s.qty}</td>
      <td>${s.price}</td>
      <td>${s.amount}</td>
      <td class="profit-cell">${s.profit}</td>
      <td>${s.status}</td>
    </tr>`;
  }).join('') : '<tr><td colspan="8">No Sales Yet</td></tr>');
  salesTotalEl.textContent = Math.round(total*100)/100;
  profitTotalEl.textContent = Math.round(pTotal*100)/100;
  applyProfitVisibility(); // ensure profit column respects lock state
}

/* --- Simple escapeHtml for safety --- */
function escapeHtml(str){
  if(!str && str !== 0) return '';
  return String(str).replace(/[&<>'"]/g, function(c){ return {'&':'&amp;','<':'&lt;','>':'&gt;',"'":'&#39;','"':'&quot;'}[c];});
}

/* --- Filter/view by saleDate --- */
document.getElementById('viewSalesBtn')?.addEventListener('click', ()=>{
  const d = saleDate.value || today;
  renderSales(d);
});

/* --- Print displayed sales (current filter) --- */
document.getElementById('printSalesBtn')?.addEventListener('click', ()=>{
  // create printable HTML from current tbody rows
  const rowsHtml = salesTableBody.innerHTML;
  const printHtml = `<html><head><title>Sales Print</title>
    <style>table{width:100%;border-collapse:collapse}th,td{border:1px solid #ccc;padding:6px;text-align:center}</style>
    </head><body><h3>Sales ‚Äî ${saleDate.value || 'All'}</h3><table><thead>${document.querySelector('#salesTable thead').innerHTML}</thead><tbody>${rowsHtml}</tbody></table></body></html>`;
  const w = window.open('', '_blank');
  w.document.write(printHtml);
  w.document.close();
  w.print();
});

/* --- Profit column locking --- */
let profitLocked = false;
function applyProfitVisibility(){
  const colIndex = 6; // 0-based index of Profit column within table head/rows (here it's 6)
  // hide/show header cell
  const ths = document.querySelectorAll('#salesTable thead th');
  if(ths && ths[colIndex]) ths[colIndex].style.display = profitLocked ? 'none' : '';
  // rows cells
  document.querySelectorAll('#salesTable tbody tr').forEach(tr=>{
    const pc = tr.querySelector('.profit-cell');
    if(pc) pc.style.display = profitLocked ? 'none' : '';
  });
  // footer profit total
  profitTotalEl.style.display = profitLocked ? 'none' : '';
}

/* Toggle profit lock ‚Äî require admin pw to unlock if locked */
document.getElementById('toggleProfitBtn')?.addEventListener('click', async ()=>{
  if(!profitLocked){
    // lock ‚Äî just hide
    profitLocked = true;
    applyProfitVisibility();
    alert('Profit column locked (hidden). To unlock use the same button and enter admin password.');
    return;
  }
  // unlock -> ask for admin password
  const pw = prompt('Enter admin password to unlock Profit column:');
  if(!pw) return;
  const stored = localStorage.getItem(ADMIN_KEY) || '';
  if(pw === stored){
    profitLocked = false;
    applyProfitVisibility();
    alert('Profit column unlocked.');
  } else {
    alert('Incorrect password.');
  }
});

/* --- Set/change admin password --- */
document.getElementById('setAdminBtn')?.addEventListener('click', ()=>{
  const cur = localStorage.getItem(ADMIN_KEY) || '';
  if(cur){
    const old = prompt('Enter current admin password (leave blank to cancel):');
    if(!old) return;
    if(old !== cur){ alert('Wrong password'); return; }
  }
  const np = prompt('Enter new admin password (min 4 chars):');
  if(!np || np.length < 4) return alert('Password too short');
  localStorage.setItem(ADMIN_KEY, np);
  alert('Admin password updated.');
});

/* --- Escape-proof: ensure sales array present --- */
if(!Array.isArray(window.sales)) window.sales = sales = JSON.parse(localStorage.getItem(SALES_KEY) || '[]');
else var sales = window.sales;

/* --- Hook Add Sale button --- */
document.getElementById('addSaleBtn')?.addEventListener('click', addSale);

/* --- Escape: ensure selectors are updated on stock change --- */
function initSalesModule(){
  refreshSaleSelectors();
  renderSales(); // all
  // Try to keep selectors updated when stock/types change (if those functions call saveAllLocal, we can listen storage)
  // Also call refreshSaleSelectors periodically / on focus (helps with single-file workflows)
}
window.addEventListener('load', initSalesModule);
window.addEventListener('storage', (e)=>{
  if(e.key === 'stock-data' || e.key === 'item-types') {
    try{ window.stock = JSON.parse(localStorage.getItem('stock-data')||'[]'); window.types = JSON.parse(localStorage.getItem('item-types')||'[]'); }catch(e){}
    refreshSaleSelectors(); renderSales();
  }
});

/* expose for debugging */
window.renderSales = renderSales;
window.addSale = addSale;
window.refreshSaleSelectors = refreshSaleSelectors;

/* ensure profit column starts visible/unlocked */
profitLocked = false;
applyProfitVisibility();
</script>
</body>
</html>
