<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üì¶ KharchaSaathi ‚Äî Business Dashboard (v1.2 Final)</title>
  <meta name="theme-color" content="#ff7a00" />
  <link rel="icon" href="../favicon.png" />
  <link rel="apple-touch-icon" href="../favicon.png" />

  <style>
    :root{
      --orange:#ff7a00; --orange-dark:#cc6300;
      --bg:#f8f9fa; --card:#ffffff; --text:#222;
      --dark-bg:#0f0f0f; --dark-card:#1a1a1a; --dark-text:#f2f2f2; --dark-border:#333;
    }
    *{box-sizing:border-box;transition:background .18s,color .18s}
    html,body{height:100%}
    body{
      margin:0;padding:18px;font-family:Poppins,Arial,sans-serif;
      background:var(--bg);color:var(--text);
    }
    body.dark{background:var(--dark-bg);color:var(--dark-text)}

    /* Topbar */
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:12px}
    h1{margin:0;font-size:20px;color:var(--orange)}
    .theme-btn,.small-btn{background:var(--orange);color:#fff;border:none;padding:8px 10px;border-radius:8px;cursor:pointer}
    .theme-btn:hover,.small-btn:hover{background:var(--orange-dark)}

    /* Tabs */
    .tabs{display:flex;gap:8px;margin:8px 0 16px;justify-content:center;flex-wrap:nowrap;overflow-x:auto}
    .tabs::-webkit-scrollbar{display:none}
    .tab{background:#eee;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600;white-space:nowrap}
    .tab.active{background:var(--orange);color:#fff}
    body.dark .tab{background:#222;color:#ccc}
    body.dark .tab.active{background:var(--orange-dark);color:#fff}

    /* Sections */
    .section{display:none;background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,0.05);margin-bottom:18px}
    .section.active{display:block}
    body.dark .section{background:var(--dark-card);border:1px solid var(--dark-border);color:var(--dark-text)}

    /* Summary + layout */
    .flex-row{display:flex;gap:18px;flex-wrap:wrap;align-items:flex-start}
    #overview-left{flex:1;min-width:280px}
    #overview-right{flex:1;min-width:320px;max-width:620px}

    #summaryCards{display:flex;flex-wrap:wrap;gap:10px;justify-content:flex-start}
    #summaryCards .card{flex:1;min-width:140px;border-radius:12px;padding:12px;text-align:center;background:var(--card);box-shadow:0 6px 14px rgba(0,0,0,0.04)}
    #summaryCards .card small{font-size:13px;opacity:.85}
    body.dark #summaryCards .card{background:var(--dark-card);color:var(--dark-text);border:1px solid var(--dark-border)}

    /* Table */
    table{width:100%;border-collapse:collapse;margin-top:12px;font-size:14px;border-radius:8px;overflow:hidden}
    th,td{padding:8px;border:1px solid #ddd;text-align:center}
    th{background:var(--orange);color:#fff}
    body.dark th{background:var(--orange-dark)}
    tr:nth-child(even){background:#fdfdfd}
    body.dark tr:nth-child(even){background:#1f1f1f}
    tr:hover{background:#fff3e0}

    /* small forms */
    .row-inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .row-inline input[type="text"], .row-inline input[type="number"], .row-inline select, .row-inline input[type="date"]{padding:6px;border-radius:6px;border:1px solid #ddd}

    /* status */
    .ok{color:#43a047;font-weight:600}.low{color:#ffa726;font-weight:600}.out{color:#e53935;font-weight:700}

    /* help modal */
    .help-modal{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.6);display:none;justify-content:center;align-items:center;z-index:1000}
    .help-content{background:var(--card);padding:22px;border-radius:12px;max-width:720px;width:92%}
    body.dark .help-content{background:var(--dark-card);color:var(--dark-text);border:1px solid var(--dark-border)}

    /* small responsive */
    @media (max-width:820px){
      #overview-right{order:2}
      #overview-left{order:1}
      .tab{padding:6px 10px}
    }
    .version-info{font-size:12px;text-align:center;opacity:.7;margin-top:6px}

    /* action buttons inside table */
    .action-btn{padding:6px 8px;border-radius:6px;border:none;background:#eee;cursor:pointer}
    .action-btn:hover{background:#ddd}
  </style>
</head>
<body>
  <div class="topbar">
    <h1>üì¶ KharchaSaathi (Offline)</h1>
    <div style="display:flex;gap:8px;align-items:center">
      <button id="themeBtn" class="theme-btn">üåô</button>
      <a class="small-btn" href="../index.html">üè† Back</a>
    </div>
  </div>

  <div class="tabs" role="tablist">
    <div class="tab active" data-tab="dashboard">üìä Overview</div>
    <div class="tab" data-tab="types">üóÇ Types</div>
    <div class="tab" data-tab="stock">üì¶ Stock</div>
    <div class="tab" data-tab="sales">üìà Sales</div>
    <div class="tab" data-tab="wanting">üõí Wanting</div>
    <div class="tab" data-tab="analytics">üìà Smart Dashboard</div>
  </div>

  <!-- OVERVIEW -->
  <section id="dashboard" class="section active">
    <h3>üìä Business Overview</h3>
    <div class="flex-row" id="overview-row">
      <div id="overview-left">
        <div id="summaryCards" aria-live="polite">
          <div class="card">
            <div style="font-size:20px">üí∞</div>
            <b id="todaySales">‚Çπ0</b><br><small>Today's Sales</small>
          </div>
          <div class="card">
            <div style="font-size:20px">üí≥</div>
            <b id="todayCredit">‚Çπ0</b><br><small>Today's Credit</small>
          </div>
          <div class="card">
            <div style="font-size:20px">üì¶</div>
            <b id="stockRemain">0%</b><br><small>Stock Remaining</small>
          </div>
          <div class="card">
            <div style="font-size:20px">üìà</div>
            <b id="todayProfit">‚Çπ0</b><br><small>Today's Profit</small>
          </div>
        </div>
      </div>

      <div id="overview-right">
        <!-- small analytics preview (non-chart) -->
        <div style="display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap">
          <div style="flex:1;min-width:140px;background:#fff;padding:12px;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,0.05)">
            <div style="font-size:14px;font-weight:600">Quick</div>
            <div id="quickInfo" style="margin-top:6px;opacity:.85">No data yet</div>
          </div>
          <div style="flex:1;min-width:140px;background:#fff;padding:12px;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,0.05)">
            <div style="font-size:14px;font-weight:600">Status</div>
            <div id="quickStatus" style="margin-top:6px;opacity:.85">Idle</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- TYPES -->
  <section id="types" class="section">
    <h3>üóÇ Manage Item Types</h3>
    <div class="row-inline" style="margin-top:8px">
      <input id="typeName" type="text" placeholder="Add new type (e.g. Mobiles)" style="flex:1;min-width:160px">
      <button id="addTypeBtn" class="small-btn">Add</button>
      <button id="clearTypesBtn" class="small-btn">Clear All</button>
    </div>
    <ul id="typeList" style="margin-top:10px;padding-left:18px"></ul>
  </section>

  <!-- STOCK -->
  <section id="stock" class="section">
    <h3>üì¶ Current Stock</h3>

    <div class="row-inline" style="margin-top:6px">
      <label>Low Stock Limit:</label>
      <input id="globalLimit" type="number" placeholder="e.g. 2" style="width:100px">
      <button id="setLimitBtn" class="small-btn">Set</button>
      <button id="clearStockBtn" class="small-btn">Clear All</button>
    </div>

    <div class="row-inline" style="margin-top:12px">
      <input id="pdate" type="date" style="min-width:140px">
      <select id="ptype" style="min-width:140px"></select>
      <input id="pname" type="text" placeholder="Product name" style="min-width:160px">
      <input id="pqty" type="number" placeholder="Qty" style="width:90px">
      <input id="pcost" type="number" placeholder="Cost ‚Çπ" style="width:100px">
      <button id="addStockBtn" class="small-btn">Add</button>
    </div>

    <div style="margin-top:12px">
      <label><b>Filter by Type:</b></label>
      <select id="filterType" style="min-width:160px">
        <option value="all">All Types</option>
      </select>
    </div>

    <table id="stockTable" aria-label="Stock table">
      <thead>
        <tr><th>Date</th><th>Type</th><th>Product</th><th>Qty</th><th>Sold</th><th>Remain</th><th>Alert</th><th>Limit</th><th>Action</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- SALES -->
  <section id="sales" class="section">
    <h3>üí∞ Sales & Profit</h3>

    <div class="row-inline" style="margin-top:8px;margin-bottom:8px">
      <label>Sale Date:</label>
      <input id="saleDate" type="date" style="min-width:150px">
      <label>Type</label>
      <select id="saleType" style="min-width:140px"></select>
      <label>Product</label>
      <select id="saleProduct" style="min-width:180px"></select>
      <input id="saleQty" type="number" placeholder="Qty" style="width:80px">
      <input id="salePrice" type="number" placeholder="Sale ‚Çπ" style="width:100px">
      <select id="saleStatus" style="min-width:100px"><option value="Paid">Paid</option><option value="Credit">Credit</option></select>
      <button id="addSaleBtn" class="small-btn">Add Sale</button>
    </div>

    <div class="row-inline" style="margin-bottom:8px;align-items:center">
      <label>GST?</label>
      <input id="includeGst" type="checkbox"><input id="gstPercent" type="number" placeholder="GST %" style="width:80px" value="0">
      <button id="viewSalesBtn" class="small-btn">View by Date</button>
      <button id="printSalesBtn" class="small-btn">Print</button>

      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <button id="toggleProfitBtn" class="small-btn">üîí Lock/Unlock Profit</button>
        <button id="setAdminBtn" class="small-btn">Set Admin PW</button>
      </div>
    </div>

    <table id="salesTable" aria-label="Sales table">
      <thead><tr><th>Date</th><th>Type</th><th>Product</th><th>Qty</th><th>Price ‚Çπ</th><th>Total ‚Çπ</th><th>Profit ‚Çπ</th><th>Status</th></tr></thead>
      <tbody></tbody>
      <tfoot><tr><td colspan="5" style="text-align:right">Total:</td><td id="salesTotal">0</td><td id="profitTotal">0</td><td></td></tr></tfoot>
    </table>
  </section>

  <!-- WANTING -->
  <section id="wanting" class="section">
    <h3>üõí Wanting</h3>
    <div id="wantingList" style="margin-top:10px">No items</div>
  </section>

  <!-- ANALYTICS / SMART DASHBOARD -->
  <section id="analytics" class="section">
    <h3>üìä Smart Sales Dashboard</h3>
    <div style="display:flex;flex-wrap:wrap;gap:20px;justify-content:flex-end;align-items:center">
      <div style="flex:1;min-width:320px;max-width:520px"><canvas id="salesBar" height="220"></canvas></div>
      <div style="flex:1;min-width:240px;max-width:360px"><canvas id="salesPie" height="220"></canvas></div>
    </div>
    <p style="text-align:center;margin-top:12px;opacity:.75;font-size:13px">üîÑ Auto-updates every 60s</p>
  </section>

  <!-- HELP -->
  <div class="footer-btns" style="margin-top:18px">
    <a href="#" id="helpLink" class="small-btn">üìò Help & Guide</a>
    <div class="version-info">v1.2 ‚Äî optimized single-file</div>
  </div>

  <div id="helpModal" class="help-modal">
    <div class="help-content">
      <h2>üìò Quick Help</h2>
      <ul style="line-height:1.6">
        <li>Types ‚Üí add and manage item categories</li>
        <li>Stock ‚Üí add stock, set low limits, quick actions</li>
        <li>Sales ‚Üí record Paid / Credit sales, print & filter</li>
        <li>Smart Dashboard ‚Üí click tab to view charts</li>
      </ul>
      <div style="text-align:right;margin-top:12px"><button class="small-btn" onclick="toggleHelp()">Close</button></div>
    </div>
  </div>

  <!-- SCRIPTS -->
  <script>
  /* -------------------
     Lightweight Helpers
     ------------------- */
  const qs = sel => document.querySelector(sel);
  const qsa = sel => Array.from(document.querySelectorAll(sel));
  function escapeHtml(s){ if(!s && s !== 0) return ''; return String(s).replace(/[&<>'"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;',"'":'&#39;','"':'&quot;'})[c]); }

  /* -------------------
     Local keys and data
     ------------------- */
  const K_TYPES = 'item-types';
  const K_STOCK = 'stock-data';
  const K_SALES = 'sales-data';
  const K_LIMIT = 'default-limit';
  const K_ADMIN = 'ks-admin-pw';

  window.types = JSON.parse(localStorage.getItem(K_TYPES) || '["Mobiles","Accessories"]');
  window.stock = JSON.parse(localStorage.getItem(K_STOCK) || '[]');
  window.sales = JSON.parse(localStorage.getItem(K_SALES) || '[]');

  /* -------------------
     Save helpers
     ------------------- */
  function saveAll(){
    localStorage.setItem(K_TYPES, JSON.stringify(window.types));
    localStorage.setItem(K_STOCK, JSON.stringify(window.stock));
    // sales saved by saveSales when needed
  }
  function saveSales(){ localStorage.setItem(K_SALES, JSON.stringify(window.sales)); }

  /* -------------------
     THEME
     ------------------- */
  (function initTheme(){
    if(localStorage.getItem('ks-theme')==='dark') document.body.classList.add('dark');
    qs('#themeBtn').addEventListener('click', ()=>{
      document.body.classList.toggle('dark');
      localStorage.setItem('ks-theme', document.body.classList.contains('dark') ? 'dark':'light');
    });
  })();

  /* -------------------
     TABS
     ------------------- */
  const tabs = qsa('.tab'), sections = qsa('.section');
  function activateTab(name){
    tabs.forEach(t=>t.classList.toggle('active', t.dataset.tab===name));
    sections.forEach(s=>s.classList.toggle('active', s.id===name));
    // on-demand actions
    if(name==='dashboard') updateSummaryCards();
    if(name==='types') { renderTypes(); updateDropdowns(); }
    if(name==='stock') { renderStock(); patchStockActions(); }
    if(name==='sales') { initSalesModule(); }
    if(name==='analytics') { ensureChartsLoadedAndRender(); }
  }
  tabs.forEach(t => t.addEventListener('click', ()=> activateTab(t.dataset.tab)));

  /* -------------------
     HELP MODAL
     ------------------- */
  function toggleHelp(){
    const m = qs('#helpModal');
    m.style.display = m.style.display === 'flex' ? 'none' : 'flex';
  }
  qs('#helpLink').addEventListener('click', e=>{ e.preventDefault(); toggleHelp(); });

  /* -------------------
     TYPES
     ------------------- */
  function renderTypes(){
    const ul = qs('#typeList'); if(!ul) return;
    if(!Array.isArray(window.types)) window.types = [];
    ul.innerHTML = window.types.map(t=>`<li>${escapeHtml(t)}</li>`).join('') || '<li>No types</li>';
  }
  function updateDropdowns(){
    ['ptype','filterType','saleType'].forEach(id=>{
      const el = qs('#'+id); if(!el) return;
      const base = id==='filterType' ? '<option value="all">All Types</option>' : '<option value="">Select</option>';
      el.innerHTML = base + (window.types || []).map(t=>`<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join('');
    });
    // update sale product selector too (separate function can refine)
    refreshSaleSelectors();
  }
  qs('#addTypeBtn').addEventListener('click', ()=>{
    const v = qs('#typeName').value.trim(); if(!v) return alert('Enter a type'); if(window.types.includes(v)) return alert('Type exists');
    window.types.push(v); saveAll(); renderTypes(); updateDropdowns(); qs('#typeName').value='';
  });
  qs('#clearTypesBtn').addEventListener('click', ()=>{
    if(confirm('Clear all types?')){ window.types=[]; saveAll(); renderTypes(); updateDropdowns(); }
  });

  /* -------------------
     STOCK
     ------------------- */
  function getLimit(){ const v = parseInt(localStorage.getItem(K_LIMIT)); return isNaN(v)?0:v; }
  qs('#setLimitBtn').addEventListener('click', ()=>{
    const v = parseInt(qs('#globalLimit').value); if(isNaN(v)||v<0) return alert('Invalid'); localStorage.setItem(K_LIMIT, v); alert('Limit set: '+v);
  });

  function renderStock(){
    const f = qs('#filterType') ? qs('#filterType').value : 'all';
    const tbody = qs('#stockTable tbody'); if(!tbody) return;
    const list = (window.stock||[]).filter(s => f==='all' || s.type===f);
    if(!list.length) { tbody.innerHTML = '<tr><td colspan="9">No Data</td></tr>'; return; }
    tbody.innerHTML = list.map((s,i)=>{
      const sold = s.sold||0; const rem = (s.qty||0)-sold; const lim = getLimit();
      let cls='ok', msg='OK'; if(rem<=0){cls='out';msg='OUT'} else if(rem<=lim){cls='low';msg='LOW'}
      return `<tr data-i="${i}">
        <td>${escapeHtml(s.date||'')}</td>
        <td>${escapeHtml(s.type)}</td>
        <td>${escapeHtml(s.name)}</td>
        <td>${s.qty||0}</td>
        <td>${sold}</td>
        <td>${rem}</td>
        <td class="${cls}">${msg}</td>
        <td>${lim}</td>
        <td>
          <button class="action-btn history-btn" data-i="${i}">üìú</button>
          <button class="action-btn sale-btn" data-i="${i}">üí∏</button>
          <button class="action-btn credit-btn" data-i="${i}">üìí</button>
        </td>
      </tr>`;
    }).join('');
  }

  qs('#addStockBtn').addEventListener('click', ()=>{
    const d = qs('#pdate').value, t = qs('#ptype').value, n = qs('#pname').value.trim();
    const q = parseInt(qs('#pqty').value), c = parseFloat(qs('#pcost').value);
    if(!d || !t || !n || !q || !c) return alert('Please fill all fields');
    const ex = (window.stock||[]).find(s => s.type===t && s.name.toLowerCase()===n.toLowerCase());
    if(ex){ ex.qty = (ex.qty||0)+q; ex.date=d; ex.cost=c; ex.history=ex.history||[]; ex.history.push({date:d,qty:q,cost:c}); }
    else { window.stock.push({date:d,type:t,name:n,qty:q,sold:0,cost:c,history:[{date:d,qty:q,cost:c}]}); }
    saveAll(); renderStock(); qs('#pname').value=''; qs('#pqty').value=''; qs('#pcost').value='';
  });

  qs('#clearStockBtn').addEventListener('click', ()=>{
    if(confirm('Clear all stock?')){ window.stock=[]; saveAll(); renderStock(); }
  });

  qs('#filterType')?.addEventListener('change', renderStock);

  /* -------------- Stock actions (history / quick sale / credit) -------------- */
  function patchStockActions(){
    // left intentionally simple: actions are rendered in renderStock's HTML
    // event delegation handles the clicks below
  }

  document.addEventListener('click', (e)=>{
    const t = e.target;
    if(t.classList.contains('history-btn')){ const i = t.dataset.i; viewHistory(i); }
    if(t.classList.contains('sale-btn')){ const i = t.dataset.i; handleSaleOrCredit(i,'Paid'); }
    if(t.classList.contains('credit-btn')){ const i = t.dataset.i; handleSaleOrCredit(i,'Credit'); }
  });

  function viewHistory(i){
    const s = (window.stock||[])[i]; if(!s||!s.history) return alert('No history'); alert(`${s.name} ‚Äî\n` + s.history.map(h=>`${h.date} ‚Äî Qty ${h.qty} @‚Çπ${h.cost}`).join('\n'));
  }

  function handleSaleOrCredit(i, mode){
    const s = (window.stock||[])[i]; if(!s) return alert('Invalid item');
    const remain = (s.qty||0) - (s.sold||0); if(remain<=0) return alert('No stock left');
    const qty = parseInt(prompt(`Enter qty for ${s.name} (remaining ${remain})`)); if(!qty||qty<=0||qty>remain) return;
    const price = parseFloat(prompt('Enter sale price ‚Çπ:')); if(!price||price<=0) return;
    s.sold = (s.sold||0) + qty;
    const d = new Date().toISOString().split('T')[0];
    const cost = parseFloat(s.cost||0); const profit = Math.round((price - cost) * qty * 100)/100;
    const sale = {date:d,type:s.type,product:s.name,qty,price,amount:qty*price,profit,status:mode};
    window.sales.push(sale); saveSales();
    if(s.sold >= s.qty){ // add to wanting
      const w = JSON.parse(localStorage.getItem('wanting-data')||'[]'); w.push({date:d,type:s.type,name:s.name,note:'Auto'}); localStorage.setItem('wanting-data', JSON.stringify(w));
    }
    saveAll(); renderStock(); renderSales(); updateSummaryCards(); alert(`${mode} sale recorded`);
  }

  /* -------------------
     SALES MODULE
     ------------------- */
  const saleDate = qs('#saleDate'), saleType = qs('#saleType'), saleProduct = qs('#saleProduct'),
        saleQty = qs('#saleQty'), salePrice = qs('#salePrice'), saleStatus = qs('#saleStatus'),
        includeGst = qs('#includeGst'), gstPercent = qs('#gstPercent'),
        salesTableBody = qs('#salesTable tbody'), salesTotalEl = qs('#salesTotal'), profitTotalEl = qs('#profitTotal');

  const todayStr = new Date().toISOString().split('T')[0];
  if(saleDate && !saleDate.value) saleDate.value = todayStr;

  function refreshSaleSelectors(){
    const typesList = Array.isArray(window.types) ? window.types : (window.types = JSON.parse(localStorage.getItem(K_TYPES)||'[]'));
    if(saleType) saleType.innerHTML = `<option value="">All Types</option>` + typesList.map(t=>`<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join('');
    // products unique
    const prodOptions = (window.stock||[]).map(s=>({type:s.type,name:s.name})).filter((v,i,a)=> a.findIndex(x=>x.type===v.type && x.name===v.name)===i);
    if(saleProduct) saleProduct.innerHTML = '<option value="">Select</option>' + prodOptions.map(p=>`<option value="${escapeHtml(p.type)}|||${escapeHtml(p.name)}">${escapeHtml(p.type)} ‚Äî ${escapeHtml(p.name)}</option>`).join('');
  }

  saleType?.addEventListener('change', ()=>{
    const t = saleType.value;
    const filtered = (window.stock||[]).filter(s => !t || s.type===t).map(s=>({type:s.type,name:s.name})).filter((v,i,a)=> a.findIndex(x=>x.type===v.type && x.name===v.name)===i);
    if(saleProduct) saleProduct.innerHTML = '<option value="">Select</option>' + filtered.map(p=>`<option value="${escapeHtml(p.type)}|||${escapeHtml(p.name)}">${escapeHtml(p.type)} ‚Äî ${escapeHtml(p.name)}</option>`).join('');
  });

  function getProductCost(type,name){
    const ex = (window.stock||[]).find(s => s.type===type && s.name.toLowerCase()===name.toLowerCase()); if(!ex) return 0;
    if(ex.cost) return parseFloat(ex.cost)||0;
    if(Array.isArray(ex.history) && ex.history.length){
      const tot = ex.history.reduce((a,h)=>a + ((h.qty||0)*(h.cost||0)),0);
      const qtot = ex.history.reduce((a,h)=>a + (h.qty||0),0);
      return qtot? tot/qtot:0;
    }
    return 0;
  }

  function addSale(){
    const d = saleDate.value || todayStr;
    const prodVal = (saleProduct && saleProduct.value) || '';
    const qty = parseInt(saleQty.value,10);
    const price = parseFloat(salePrice.value);
    const status = saleStatus.value || 'Paid';
    if(!prodVal) return alert('Select product'); if(!qty || qty<=0) return alert('Invalid qty'); if(!price || price<=0) return alert('Invalid price');
    const [type,name] = prodVal.split('|||');
    const idx = (window.stock||[]).findIndex(s => s.type===type && s.name.toLowerCase()===name.toLowerCase());
    if(idx>=0){
      const stockItem = window.stock[idx];
      const remain = (stockItem.qty||0) - (stockItem.sold||0);
      if(qty>remain) if(!confirm(`Only ${remain} left. Proceed?`)) return;
      stockItem.sold = (stockItem.sold||0) + qty;
    }
    const cost = getProductCost(type,name)||0;
    let netSalePrice = price;
    if(includeGst && includeGst.checked){ const g=parseFloat(gstPercent.value)||0; if(g>0) netSalePrice = price/(1+(g/100)); }
    const profit = Math.round((netSalePrice - cost) * qty * 100)/100;
    const entry = {date:d,type,product:name,qty,price,amount:price*qty,costPerUnit:cost,profit:Math.round(profit*100)/100,status};
    window.sales.push(entry); saveSales(); renderSales(); renderStock(); updateSummaryCards();
    saleQty.value=''; salePrice.value='';
    alert('Sale recorded');
  }

  qs('#addSaleBtn').addEventListener('click', addSale);

  function renderSales(filterDate){
    const list = window.sales||[];
    const rows = filterDate ? list.filter(s=>s.date===filterDate) : list;
    if(!salesTableBody) return;
    let total=0,pTotal=0;
    salesTableBody.innerHTML = rows.length ? rows.map((s,i)=>{ total += (s.amount||0); pTotal += (s.profit||0);
      return `<tr data-index="${i}"><td>${s.date}</td><td>${escapeHtml(s.type)}</td><td>${escapeHtml(s.product)}</td><td>${s.qty}</td><td>${s.price}</td><td>${s.amount}</td><td class="profit-cell">${s.profit}</td><td>${s.status}</td></tr>`;
    }).join('') : '<tr><td colspan="8">No Sales Yet</td></tr>';
    if(salesTotalEl) salesTotalEl.textContent = Math.round(total*100)/100;
    if(profitTotalEl) profitTotalEl.textContent = Math.round(pTotal*100)/100;
    applyProfitVisibility();
  }

  qs('#viewSalesBtn')?.addEventListener('click', ()=>{ const d = saleDate.value || todayStr; renderSales(d); });

  qs('#printSalesBtn')?.addEventListener('click', ()=>{
    const rowsHtml = salesTableBody.innerHTML;
    const printHtml = `<html><head><title>Sales Print</title><style>table{width:100%;border-collapse:collapse}th,td{border:1px solid #ccc;padding:6px;text-align:center}</style></head><body><h3>Sales ‚Äî ${saleDate.value || 'All'}</h3><table><thead>${qs('#salesTable thead').innerHTML}</thead><tbody>${rowsHtml}</tbody></table></body></html>`;
    const w = window.open('','_blank'); w.document.write(printHtml); w.document.close(); w.print();
  });

  /* profit lock */
  let profitLocked = false;
  function applyProfitVisibility(){
    const colIndex = 6;
    const ths = qsa('#salesTable thead th');
    if(ths && ths[colIndex]) ths[colIndex].style.display = profitLocked ? 'none' : '';
    qsa('#salesTable tbody tr').forEach(tr => { const pc = tr.querySelector('.profit-cell'); if(pc) pc.style.display = profitLocked ? 'none' : ''; });
    if(profitTotalEl) profitTotalEl.style.display = profitLocked ? 'none' : '';
  }
  qs('#toggleProfitBtn')?.addEventListener('click', ()=>{
    if(!profitLocked){ profitLocked=true; applyProfitVisibility(); alert('Profit column hidden (locked)'); return; }
    const pw = prompt('Enter admin password to unlock:'); if(!pw) return;
    const stored = localStorage.getItem(K_ADMIN) || '';
    if(pw===stored){ profitLocked=false; applyProfitVisibility(); alert('Unlocked'); } else alert('Wrong password');
  });
  qs('#setAdminBtn')?.addEventListener('click', ()=>{
    const cur = localStorage.getItem(K_ADMIN) || '';
    if(cur){ const old = prompt('Enter current admin pw (cancel leaves)'); if(!old) return; if(old!==cur){ alert('Wrong'); return; } }
    const np = prompt('Enter new admin pw (min 4 char)'); if(!np || np.length<4) return alert('Too short'); localStorage.setItem(K_ADMIN,np); alert('Updated');
  });

  function initSalesModule(){ refreshSaleSelectors(); renderSales(); applyProfitVisibility(); }

  /* -------------------
     SUMMARY PANEL
     ------------------- */
  function updateSummaryCards(){
    const today = new Date().toISOString().split('T')[0];
    const salesList = JSON.parse(localStorage.getItem(K_SALES)||'[]');
    const stockList = JSON.parse(localStorage.getItem(K_STOCK)||'[]');
    let todaySales=0,todayCredit=0,todayProfit=0;
    salesList.forEach(s=>{ if(s.date===today){ if(s.status==='Paid') todaySales += s.amount||0; if(s.status==='Credit') todayCredit += s.amount||0; todayProfit += s.profit||0; }});
    const totalQty = stockList.reduce((a,b)=>a + (Number(b.qty)||0),0);
    const soldQty = stockList.reduce((a,b)=>a + (Number(b.sold)||0),0);
    const remainPct = totalQty>0 ? Math.round(((totalQty - soldQty)/totalQty) * 100) : 0;
    qs('#todaySales').textContent = '‚Çπ' + (Math.round(todaySales*100)/100).toFixed(2);
    qs('#todayCredit').textContent = '‚Çπ' + (Math.round(todayCredit*100)/100).toFixed(2);
    qs('#todayProfit').textContent = '‚Çπ' + (Math.round(todayProfit*100)/100).toFixed(2);
    qs('#stockRemain').textContent = remainPct + '%';
    // quick info
    qs('#quickInfo').textContent = `Total stock items: ${stockList.length}, Sales entries: ${salesList.length}`;
    qs('#quickStatus').textContent = (salesList.length ? 'Active' : 'Idle');
  }
  window.addEventListener('storage', ()=>{ renderStock(); renderSales(); updateSummaryCards(); });

  /* -------------------
     ANALYTICS (Chart.js) - load on demand
     ------------------- */
  let chartsLoaded = false, salesBarChart = null, salesPieChart = null, analyticsInterval = null;
  function loadChartJsOnce(cb){
    if(window.Chart){ chartsLoaded=true; return cb && cb(); }
    const s = document.createElement('script'); s.src = 'https://cdn.jsdelivr.net/npm/chart.js'; s.onload = ()=>{ chartsLoaded=true; cb && cb(); }; document.head.appendChild(s);
  }

  function getSalesData(){
    const sales = JSON.parse(localStorage.getItem(K_SALES) || '[]');
    const today = new Date(); const todayStr = today.toISOString().split('T')[0];
    const startOfWeek = new Date(today); startOfWeek.setDate(today.getDate() - today.getDay());
    const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
    let todaySales=0, weekSales=0, monthSales=0, creditSales=0, paidSales=0, totalProfit=0;
    sales.forEach(s=>{
      const d = new Date(s.date);
      const amt = s.amount || 0; const prof = s.profit || 0;
      if(s.date===todayStr) todaySales += amt;
      if(d >= startOfWeek) weekSales += amt;
      if(d >= startOfMonth) monthSales += amt;
      if(s.status === 'Credit') creditSales += amt; else paidSales += amt;
      totalProfit += prof;
    });
    return { todaySales, weekSales, monthSales, creditSales, paidSales, totalProfit };
  }

  function renderAnalytics(){
    if(!chartsLoaded) return;
    const { todaySales, weekSales, monthSales, creditSales, paidSales, totalProfit } = getSalesData();
    const ctx1 = qs('#salesBar').getContext('2d'); const ctx2 = qs('#salesPie').getContext('2d');
    if(salesBarChart) salesBarChart.destroy(); if(salesPieChart) salesPieChart.destroy();
    salesBarChart = new Chart(ctx1, { type:'bar', data:{ labels:['Today','This Week','This Month'], datasets:[{ label:'Sales ‚Çπ', data:[todaySales,weekSales,monthSales], backgroundColor:['#ffb74d','#ff9800','#f57c00'], borderRadius:6 }] }, options:{ plugins:{ title:{display:true,text:'Sales Summary'}, legend:{display:false} }, scales:{ y:{ beginAtZero:true } } } });
    salesPieChart = new Chart(ctx2, { type:'pie', data:{ labels:['Paid','Credit'], datasets:[{ data:[paidSales,creditSales], backgroundColor:['#43a047','#42a5f5'] }] }, options:{ plugins:{ legend:{position:'bottom'}, title:{display:true,text:`Total Profit ‚Çπ${(totalProfit||0).toFixed(2)}`} } } });
  }

  function ensureChartsLoadedAndRender(){
    loadChartJsOnce(()=>{
      renderAnalytics();
      // refresh when analytics tab visible every 60s
      if(analyticsInterval) clearInterval(analyticsInterval);
      analyticsInterval = setInterval(()=>{ const active = qs('.tab.active'); if(active && active.dataset.tab==='analytics') renderAnalytics(); }, 60000);
    });
  }

  /* -------------------
     INITIALIZATION (single entry)
     ------------------- */
  function initAll(){
    renderTypes(); updateDropdowns(); renderStock(); renderSales(); updateSummaryCards(); patchStockActions();
    // default inits
    if(!localStorage.getItem(K_ADMIN)) localStorage.setItem(K_ADMIN,'admin123');
    // ensure sale selectors updated after stock/types loaded
    refreshSaleSelectors();
    // safe auto-save on beforeunload
    window.addEventListener('beforeunload', ()=>{ try{ saveAll(); saveSales(); }catch(e){} });
    // update summary periodically
    setInterval(updateSummaryCards, 60000);
    console.log('%cKharchaSaathi Dashboard Loaded Successfully ‚úÖ','color:#ff7a00;font-weight:bold;');
  }

  // run init once DOM ready (defer minimal)
  if(document.readyState === 'loading'){ document.addEventListener('DOMContentLoaded', initAll); }
  else initAll();

  /* expose for debugging */
  window.updateSummaryCards = updateSummaryCards;
  window.renderStock = renderStock;
  window.renderSales = renderSales;
  window.refreshSaleSelectors = refreshSaleSelectors;
  window.ensureChartsLoadedAndRender = ensureChartsLoadedAndRender;
  </script>
</body>
</html>
