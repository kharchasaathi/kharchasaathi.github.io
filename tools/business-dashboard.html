<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üì¶ KharchaSaathi ‚Äî Business Dashboard (v2.0)</title>
  <meta name="theme-color" content="#ff7a00" />
  <link rel="icon" href="/favicon.png" />
  <link rel="apple-touch-icon" href="/favicon.png" />

  <style>
    :root{
      --orange:#ff7a00; 
      --orange-dark:#cc6300;
      --bg:#f8f9fa; 
      --card:#ffffff; 
      --text:#222;
      --dark-bg:#0f0f0f; 
      --dark-card:#1a1a1a; 
      --dark-text:#f2f2f2; 
      --dark-border:#333;
    }

    *{box-sizing:border-box;transition:background .18s,color .18s}
    html,body{height:100%}

    body{
      margin:0;
      padding:18px;
      font-family:Poppins,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    body.dark{
      background:var(--dark-bg);
      color:var(--dark-text);
    }

    /* ---------- TOPBAR ---------- */
    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:12px
    }

    h1{
      margin:0;
      font-size:20px;
      color:var(--orange)
    }

    .theme-btn,.small-btn{
      background:var(--orange);
      color:#fff;
      border:none;
      padding:8px 10px;
      border-radius:8px;
      cursor:pointer
    }
    .theme-btn:hover,.small-btn:hover{
      background:var(--orange-dark)
    }

    #emailTag{
      font-size:13px;
      opacity:.75;
      margin-right:8px;
      background:#eee;
      padding:4px 8px;
      border-radius:6px;
    }
    body.dark #emailTag{
      background:#222;
      color:#ddd;
    }

    /* ---------- TABS ---------- */
    .tabs{
      display:flex;
      gap:8px;
      margin:8px 0 16px;
      justify-content:center;
      flex-wrap:nowrap;
      overflow-x:auto
    }
    .tabs::-webkit-scrollbar{display:none}

    .tab{
      background:#eee;
      padding:8px 12px;
      border-radius:10px;
      cursor:pointer;
      font-weight:600;
      white-space:nowrap
    }

    .tab.active{
      background:var(--orange);
      color:#fff
    }

    body.dark .tab{
      background:#222;
      color:#ccc
    }
    body.dark .tab.active{
      background:var(--orange-dark);
      color:#fff
    }

    /* ---------- SECTIONS ---------- */
    .section{
      display:none;
      background:var(--card);
      padding:14px;
      border-radius:12px;
      box-shadow:0 6px 20px rgba(0,0,0,0.05);
      margin-bottom:18px
    }
    .section.active{display:block}

    body.dark .section{
      background:var(--dark-card);
      border:1px solid var(--dark-border);
      color:var(--dark-text);
    }

    /* ---------- LAYOUT ---------- */
    .flex-row{
      display:flex;
      gap:18px;
      flex-wrap:wrap;
      align-items:flex-start
    }

    /* ---------- TABLE ---------- */
    table{
      width:100%;
      border-collapse:collapse;
      margin-top:12px;
      font-size:14px;
      border-radius:8px;
      overflow:hidden
    }
    th,td{
      padding:8px;
      border:1px solid #ddd;
      text-align:center
    }

    th{
      background:var(--orange);
      color:#fff
    }
    body.dark th{
      background:var(--orange-dark)
    }

    tr:nth-child(even){
      background:#fdfdfd
    }
    body.dark tr:nth-child(even){
      background:#1f1f1f
    }

    tr:hover{
      background:#fff3e0
    }

    /* ---------- FORM INLINE ---------- */
    .row-inline{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap
    }

    .row-inline input[type="text"],
    .row-inline input[type="number"],
    .row-inline select,
    .row-inline input[type="date"]{
      padding:6px;
      border-radius:6px;
      border:1px solid #ddd
    }

    /* ---------- MOBILE FIXES ---------- */
    @media (max-width: 600px) {

      .tabs {
        flex-wrap: wrap;
        justify-content: center;
        gap: 6px;
      }
      .tab {
        padding: 6px 10px;
        font-size: 12px;
      }

      .flex-row {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }

      .flex-row .card {
        width: 100%;
        text-align: center;
      }

      .row-inline {
        flex-direction: column;
        align-items: stretch;
      }

      .row-inline input,
      .row-inline select,
      .row-inline button {
        width: 100% !important;
        min-width: unset !important;
      }

      table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
        font-size: 12px;
      }

      th, td {
        padding: 6px;
      }
    }

  </style>
</head>

<body>

  <!-- üîê TOPBAR -->
  <div class="topbar">
    <h1>üì¶ KharchaSaathi (Offline)</h1>

    <div style="display:flex;gap:10px;align-items:center">
      <span id="emailTag">Loading...</span>
      <button id="themeBtn" class="theme-btn">üåô</button>
      <a class="small-btn" href="/index.html">üè† Back</a>
      <button id="logoutBtn" class="small-btn" style="background:#e53935">üîì Logout</button>
    </div>
  </div>

  <!-- ===== TABS (Profit tab included correctly inside the group) ===== -->
  <div class="tabs" role="tablist">
    <div class="tab active" data-tab="types">üóÇ Types</div>
    <div class="tab" data-tab="stock">üì¶ Stock</div>
    <div class="tab" data-tab="sales">üìà Sales</div>
    <div class="tab" data-tab="wanting">üõí Wanting</div>
    <div class="tab" data-tab="service">üõ† Service</div>
    <div class="tab" data-tab="dashboard">üìä Overview</div>
    <div class="tab" data-tab="analytics">üìà Smart Dashboard</div>
    <div class="tab" data-tab="expenses">üí∏ Expenses</div>
    <div class="tab" data-tab="profit">üí∞ Profit</div>
  </div>

  <!-- NET PROFIT BAR -->
  <div id="tabSummaryBar"
       style="background:#1b1b1b;color:#fff;padding:10px;font-size:18px;
              font-weight:bold;border-radius:6px;margin-bottom:10px;
              text-align:center;">
    Profit: ‚Çπ0
  </div>
  <!-- ===== TYPES ===== -->
  <section id="types" class="section active">
    <h3>üóÇ Manage Item Types</h3>

    <div class="row-inline" style="margin-top:8px">
      <input id="typeName" type="text" placeholder="Add new type" style="flex:1;min-width:160px">
      <button id="addTypeBtn" class="small-btn">Add</button>
      <button id="clearTypesBtn" class="small-btn">Clear All</button>
    </div>

    <ul id="typeList" style="margin-top:10px;padding-left:18px"></ul>
  </section>

  <!-- ===== STOCK ===== -->
  <section id="stock" class="section">
    <h3>üì¶ Current Stock</h3>

    <div class="row-inline" style="margin-top:6px">
      <label>Low Stock:</label>
      <input id="globalLimit" type="number" placeholder="2" style="width:80px">
      <button id="setLimitBtn" class="small-btn">Set</button>
      <button id="clearStockBtn" class="small-btn">Clear All</button>
    </div>

    <div class="row-inline" style="margin-top:12px">
      <input id="pdate" type="date">
      <select id="ptype"></select>
      <input id="pname" type="text" placeholder="Product">
      <input id="pqty" type="number" placeholder="Qty" style="width:80px">
      <input id="pcost" type="number" placeholder="Cost ‚Çπ" style="width:90px">
      <button id="addStockBtn" class="small-btn">Add</button>
    </div>

    <div style="margin-top:12px">
      <b>Filter Type:</b>
      <select id="filterType"><option value="all">All</option></select>
    </div>

    <table id="stockTable">
      <thead>
        <tr>
          <th>Date</th>
          <th>Type</th>
          <th>Product</th>
          <th>Qty</th>
          <th>Sold</th>
          <th>Remain</th>
          <th>Alert</th>
          <th>Limit</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>
  <!-- ===== SALES ===== -->
  <section id="sales" class="section">
    <h3>üí∞ Sales & Profit</h3>

    <div class="row-inline" style="margin:10px 0">
      <label>Date:</label>
      <input id="saleDate" type="date">

      <label style="margin-left:8px">Filter Type:</label>
      <select id="saleType">
        <option value="all">All Types</option>
      </select>

      <button id="filterSalesBtn" class="small-btn" style="margin-left:8px">
        Filter
      </button>

      <button id="clearSalesBtn" class="small-btn" 
        style="background:#c62828;color:#fff;margin-left:10px">
        üóëÔ∏è Clear All
      </button>
    </div>

    <table id="salesTable">
      <thead>
        <tr>
          <th>Date</th>
          <th>Type</th>
          <th>Product</th>
          <th>Qty</th>
          <th>Price</th>
          <th>Total</th>
          <th>Profit</th>
          <th>Status</th>
        </tr>
      </thead>

      <tbody></tbody>

      <tfoot>
        <tr>
          <td colspan="5" style="text-align:right">Total:</td>
          <td id="salesTotal">0</td>
          <td id="profitTotal">0</td>
          <td></td>
        </tr>
      </tfoot>
    </table>
  </section>


  <!-- ===== WANTING ===== -->
  <section id="wanting" class="section">
    <h3>üõí Wanting List</h3>

    <div class="want-form">
      <select id="wantType"></select>
      <input id="wantName" type="text" placeholder="Product">
      <input id="wantNote" type="text" placeholder="Note">
      <button id="addWantBtn" class="small-btn">Add</button>
      <button id="clearWantBtn" class="small-btn">Clear</button>
      <button id="printWantBtn" class="small-btn">Print</button>
    </div>

    <table id="wantingTable">
      <thead>
        <tr>
          <th>Date</th>
          <th>Type</th>
          <th>Product</th>
          <th>Note</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>
  <!-- ===== SERVICE / REPAIR ===== -->
<section id="service" class="section">
  <h3>üõ† Service / Repair Manager</h3>

  <!-- REGISTER NEW JOB -->
  <div class="row-inline" style="margin:10px 0;align-items:center;gap:10px">
    <input id="svcReceivedDate" type="date" placeholder="Received date" style="width:160px">
    <input id="svcCustomer" type="text" placeholder="Customer name" style="min-width:160px">
    <input id="svcPhone" type="text" placeholder="Phone Number" style="width:140px">
    <select id="svcItemType" style="width:120px">
      <option value="Mobile">Mobile</option>
      <option value="Laptop">Laptop</option>
      <option value="Other">Other</option>
    </select>
    <input id="svcModel" type="text" placeholder="Model" style="min-width:130px">
    <input id="svcProblem" type="text" placeholder="Problem / Complaint" style="min-width:220px">
    <input id="svcAdvance" type="number" placeholder="Advance ‚Çπ (0)" style="width:120px">
    <button id="addServiceBtn" class="small-btn">Add Job</button>
  </div>

  <!-- SUMMARY -->
  <div class="flex-row" style="margin:8px 0;">
    <div class="card" style="min-width:140px">
      <small>Pending</small>
      <div id="svcPendingCount">0</div>
    </div>
    <div class="card" style="min-width:140px">
      <small>Completed</small>
      <div id="svcCompletedCount">0</div>
    </div>
    <div class="card" style="min-width:140px">
      <small>Total Repair Profit</small>
      <div id="svcTotalProfit">‚Çπ0</div>
    </div>
  </div>

  <!-- PENDING JOBS TABLE -->
  <h4>Pending / Active Jobs</h4>
  <table id="svcTable">
    <thead>
      <tr>
        <th>Job ID</th>
        <th>Received</th>
        <th>Customer</th>
        <th>Phone</th>
        <th>Item</th>
        <th>Model</th>
        <th>Problem</th>
        <th>Status</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <button id="clearServiceBtn"
    class="small-btn"
    style="background:#b71c1c;color:white;margin:10px 0;">
    üóëÔ∏è Clear All Jobs
  </button>

  <!-- COMPLETED JOBS / HISTORY -->
  <h4 style="margin-top:14px">Completed / History</h4>
  <table id="svcHistoryTable">
    <thead>
      <tr>
        <th>Job ID</th>
        <th>Received</th>
        <th>Completed</th>
        <th>Customer</th>
        <th>Item</th>
        <th>Invest</th>
        <th>Paid</th>
        <th>Profit</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- PIE CHART (Status) -->
  <div style="max-width:520px;margin:14px auto;">
    <canvas id="svcPie" height="150"></canvas>
  </div>

</section>
  <!-- ===== OVERVIEW ===== -->
<section id="dashboard" class="section">
  <h3>üìä Business Overview</h3>

  <div id="summaryCards" class="flex-row" style="margin-top:10px">

    <div class="card">
      <div style="font-size:26px">üí∞</div>
      <b id="todaySales" style="font-size:20px;color:var(--orange)">‚Çπ0</b><br>
      <small>Today's Sales</small>
    </div>

    <div class="card">
      <div style="font-size:26px">üí≥</div>
      <b id="todayCredit" style="font-size:20px;color:var(--orange)">‚Çπ0</b><br>
      <small>Today's Credit</small>
    </div>

    <div class="card">
      <div style="font-size:26px">üßæ</div>
      <b id="todayExpenses" style="font-size:20px;color:var(--orange)">‚Çπ0</b><br>
      <small>Today's Expenses</small>
    </div>

    <div class="card">
      <div style="font-size:26px">üìà</div>
      <b id="todayGross" style="font-size:20px;color:var(--orange)">‚Çπ0</b><br>
      <small>Today's Gross Profit</small>
    </div>

    <div class="card">
      <div style="font-size:26px">üíπ</div>
      <b id="todayNet" style="font-size:20px;color:var(--orange)">‚Çπ0</b><br>
      <small>Today's NET Profit</small>
    </div>

    <div class="card">
      <div style="font-size:26px">üì¶</div>
      <b id="stockRemainValue" style="font-size:20px;color:var(--orange)">0%</b><br>
      <small>Stock Remaining</small>

      <div style="margin-top:6px;height:6px;background:#ddd;border-radius:4px">
        <div id="stockRemainBar"
             style="height:6px;width:0%;background:var(--orange);border-radius:4px">
        </div>
      </div>
    </div>

  </div>
</section>
  <!-- ===== ANALYTICS (SMART DASHBOARD) ===== -->
<section id="analytics" class="section">
  <h3>üìà Smart Dashboard</h3>

  <!-- Summary Cards -->
  <div class="flex-row" style="margin-bottom:18px">

    <div class="card" style="flex:1;min-width:140px">
      <h4>Today Sales</h4>
      <b id="sumToday">‚Çπ0</b>
    </div>

    <div class="card" style="flex:1;min-width:140px">
      <h4>This Week</h4>
      <b id="sumWeek">‚Çπ0</b>
    </div>

    <div class="card" style="flex:1;min-width:140px">
      <h4>This Month</h4>
      <b id="sumMonth">‚Çπ0</b>
    </div>

    <div class="card" style="flex:1;min-width:140px">
      <h4>Gross Profit</h4>
      <b id="sumGross">‚Çπ0</b>
    </div>

    <div class="card" style="flex:1;min-width:140px">
      <h4>Net Profit</h4>
      <b id="sumNet">‚Çπ0</b>
    </div>

  </div>

  <!-- Bar Chart -->
  <div style="max-width:900px;margin:auto">
    <canvas id="salesBar" height="150"></canvas>
  </div>
  <br>

  <!-- Pie Chart -->
  <div style="max-width:600px;margin:auto">
    <canvas id="salesPie" height="150"></canvas>
  </div>

  <!-- ===== COLLECT BUTTONS ROW ===== -->
  <div style="
        margin-top:18px;
        text-align:center;
        display:flex;
        gap:10px;
        flex-wrap:wrap;
        justify-content:center">

    <button id="collectSalesInvBtn" class="small-btn" style="background:#ff9800">
      Collect Stock Investment
    </button>

    <button id="collectSalesProfitBtn" class="small-btn" style="background:#4caf50">
      Collect Sales Profit
    </button>

    <button id="collectSvcInvBtn" class="small-btn" style="background:#03a9f4">
      Collect Service Investment
    </button>

    <button id="collectSvcProfitBtn" class="small-btn" style="background:#01579b">
      Collect Service Profit
    </button>

  </div>

</section>
  
  <!-- ===== EXPENSES ===== -->
<section id="expenses" class="section">
  <h3>üßæ Expenses</h3>

  <div class="row-inline" style="margin-bottom:8px">
    <input id="expDate" type="date" onfocus="if(!this.value)this.value=todayDate()">
    <input id="expCategory" type="text" placeholder="Category" style="min-width:140px">
    <input id="expAmount" type="number" placeholder="Amount" style="width:120px">
    <input id="expNote" type="text" placeholder="Note" style="min-width:200px">
    <button id="addExpBtn" class="small-btn">Add Expense</button>
  </div>

  <table id="expensesTable">
    <thead>
      <tr>
        <th>Date</th>
        <th>Category</th>
        <th>Amount</th>
        <th>Note</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>

    <tfoot>
      <tr>
        <td colspan="2" style="text-align:right">Total:</td>
        <td id="expensesTotal">0</td>
        <td></td><td></td>
      </tr>
    </tfoot>
  </table>
</section>
  <!-- ===== PROFIT (NEW TAB) ===== -->
<section id="profit" class="section">
  <h3>üí∞ Profit Manager</h3>

  <div class="flex-row" style="margin-top:12px">

    <!-- STOCK INVESTMENT -->
    <div class="card" style="flex:1;min-width:180px">
      <h4>üì¶ Stock Investment (After Sale)</h4>
      <b id="pStockInv" style="font-size:22px;color:#ff9800">‚Çπ0</b><br>
      <button id="collectStockInvBtn" class="small-btn" style="margin-top:6px;background:#ff9800">
        Collect
      </button>
    </div>

    <!-- SALES PROFIT -->
    <div class="card" style="flex:1;min-width:180px">
      <h4>üí∞ Sales Profit</h4>
      <b id="pSalesProfit" style="font-size:22px;color:#4caf50">‚Çπ0</b><br>
      <button id="collectSalesProfitBtn2" class="small-btn" style="margin-top:6px;background:#4caf50">
        Collect
      </button>
    </div>

    <!-- SERVICE INVESTMENT -->
    <div class="card" style="flex:1;min-width:180px">
      <h4>üõ† Service Investment</h4>
      <b id="pSvcInv" style="font-size:22px;color:#03a9f4">‚Çπ0</b><br>
      <button id="collectSvcInvBtn2" class="small-btn" style="margin-top:6px;background:#03a9f4">
        Collect
      </button>
    </div>

    <!-- SERVICE PROFIT -->
    <div class="card" style="flex:1;min-width:180px">
      <h4>‚öôÔ∏è Service Profit</h4>
      <b id="pSvcProfit" style="font-size:22px;color:#01579b">‚Çπ0</b><br>
      <button id="collectSvcProfitBtn2" class="small-btn" style="margin-top:6px;background:#01579b">
        Collect
      </button>
    </div>

  </div>
</section>
  <script>
window.renderProfitTab = function () {
  qs("#pStockInv").textContent   = "‚Çπ" + (window.getStockInvestmentCollected?.() || 0);
  qs("#pSalesProfit").textContent = "‚Çπ" + (window.getSalesProfitCollected?.() || 0);
  qs("#pSvcInv").textContent      = "‚Çπ" + (window.getServiceInvestmentCollected?.() || 0);
  qs("#pSvcProfit").textContent   = "‚Çπ" + (window.getServiceProfitCollected?.() || 0);
};

/* ------- BUTTON ACTIONS ------- */

qs("#collectStockInvBtn")?.addEventListener("click", () => {
  if (confirm("Collect Stock Investment?")) {
    localStorage.setItem("collected_stock_inv", Date.now());
    renderProfitTab();
    renderAnalytics?.();
  }
});

qs("#collectSalesProfitBtn2")?.addEventListener("click", () => {
  if (confirm("Collect Sales Profit?")) {
    localStorage.setItem("collected_sales_profit", Date.now());
    renderProfitTab();
    renderAnalytics?.();
  }
});

qs("#collectSvcInvBtn2")?.addEventListener("click", () => {
  if (confirm("Collect Service Investment?")) {
    localStorage.setItem("collected_svc_inv", Date.now());
    renderProfitTab();
    renderAnalytics?.();
  }
});

qs("#collectSvcProfitBtn2")?.addEventListener("click", () => {
  if (confirm("Collect Service Profit?")) {
    localStorage.setItem("collected_svc_profit", Date.now());
    renderProfitTab();
    renderAnalytics?.();
  }
});
</script>
  <!-- ===== ANALYTICS (SMART DASHBOARD - CLEAN 4 ITEMS) ===== -->
<section id="analytics" class="section">
  <h3>üìà Smart Dashboard (Clean)</h3>

  <div class="flex-row" style="margin-bottom:18px">

    <div class="card" style="flex:1;min-width:160px">
      <h4>Total Profit</h4>
      <b id="dashProfit" style="font-size:22px;color:#2e7d32">‚Çπ0</b>
    </div>

    <div class="card" style="flex:1;min-width:160px">
      <h4>Total Expenses</h4>
      <b id="dashExpenses" style="font-size:22px;color:#c62828">‚Çπ0</b>
    </div>

    <div class="card" style="flex:1;min-width:160px">
      <h4>Credit Sales</h4>
      <b id="dashCredit" style="font-size:22px;color:#1565c0">‚Çπ0</b>
    </div>

    <div class="card" style="flex:1;min-width:160px">
      <h4>Total Investment</h4>
      <b id="dashInv" style="font-size:22px;color:#fbc02d">‚Çπ0</b>
    </div>

  </div>

  <div style="max-width:600px;margin:auto">
    <canvas id="cleanPie" height="150"></canvas>
  </div>
</section>
  <script>
let cleanPieChart = null;

window.renderAnalytics = function () {

  // --- Collect totals ---
  const profit  = window.getSalesProfitCollected?.() + window.getServiceProfitCollected?.();
  const expense = (window.expenses || []).reduce((a,b) => a + Number(b.amount||0), 0);
  const credit  = (window.sales || []).filter(s => s.status==="Credit")
                        .reduce((a,b) => a + Number(b.amount||0), 0);

  const inv = 
    window.getSalesInvestmentCollected?.() +
    window.getServiceInvestmentCollected?.();

  // --- Update cards ---
  qs("#dashProfit").textContent   = "‚Çπ" + profit;
  qs("#dashExpenses").textContent = "‚Çπ" + expense;
  qs("#dashCredit").textContent   = "‚Çπ" + credit;
  qs("#dashInv").textContent      = "‚Çπ" + inv;

  // --- PIE CHART DATA ---
  const data = {
    labels: ["Profit", "Expenses", "Credit Sales", "Investment"],
    datasets: [{
      data: [profit, expense, credit, inv],
      backgroundColor: ["#2e7d32", "#c62828", "#1565c0", "#fbc02d"]
    }]
  };

  // --- Destroy old chart ---
  if (cleanPieChart) cleanPieChart.destroy();

  // --- Render new chart ---
  const ctx = document.getElementById("cleanPie").getContext("2d");

  cleanPieChart = new Chart(ctx, {
    type: "pie",
    data,
    options: {
      responsive: true,
      plugins: {
        legend: { position: "bottom" }
      }
    }
  });
};
</script>
  <script>
(function () {
  const COLLECT_KEY = "ks-collected";

  /* -----------------------------
     1) LOAD / SAVE COLLECTED DATA
  ----------------------------- */
  function loadCollected() {
    try {
      const raw = localStorage.getItem(COLLECT_KEY);
      const obj = raw ? JSON.parse(raw) : {};
      window.collected = {
        stockInv:   Number(obj.stockInv   || 0),
        salesProfit:Number(obj.salesProfit|| 0),
        svcInv:     Number(obj.svcInv     || 0),
        svcProfit:  Number(obj.svcProfit  || 0),
      };
    } catch (e) {
      window.collected = { stockInv:0, salesProfit:0, svcInv:0, svcProfit:0 };
    }
  }

  function saveCollected() {
    try {
      localStorage.setItem(COLLECT_KEY, JSON.stringify(window.collected));
    } catch (e) {
      // ignore
    }
  }

  function clamp(v) { return v < 0 ? 0 : v; }

  /* -----------------------------
     2) PENDING (NOT COLLECTED) VALUES
  ----------------------------- */
  window.getPendingStockInvestment = function () {
    // "after sale" = SOLD stock investment
    const total = window.getSalesInvestmentCollected?.() || 0;
    return clamp(total - (window.collected.stockInv || 0));
  };

  window.getPendingSalesProfit = function () {
    const total = window.getSalesProfitCollected?.() || 0;
    return clamp(total - (window.collected.salesProfit || 0));
  };

  window.getPendingServiceInvestment = function () {
    const total = window.getServiceInvestmentCollected?.() || 0;
    return clamp(total - (window.collected.svcInv || 0));
  };

  window.getPendingServiceProfit = function () {
    const total = window.getServiceProfitCollected?.() || 0;
    return clamp(total - (window.collected.svcProfit || 0));
  };

  /* -----------------------------
     3) PROFIT TAB RENDER
  ----------------------------- */
  window.renderProfitTab = function () {
    const elStock = qs("#pStockInv");
    const elSales = qs("#pSalesProfit");
    const elSvcInv = qs("#pSvcInv");
    const elSvcProfit = qs("#pSvcProfit");

    if (elStock)    elStock.textContent    = "‚Çπ" + window.getPendingStockInvestment();
    if (elSales)    elSales.textContent    = "‚Çπ" + window.getPendingSalesProfit();
    if (elSvcInv)   elSvcInv.textContent   = "‚Çπ" + window.getPendingServiceInvestment();
    if (elSvcProfit)elSvcProfit.textContent= "‚Çπ" + window.getPendingServiceProfit();
  };

  /* -----------------------------
     4) COLLECT HELPERS
  ----------------------------- */
  function collectAndRefresh(type) {
    let add = 0;
    let label = "";

    if (type === "stockInv") {
      add = window.getPendingStockInvestment();
      label = "Stock Investment";
    } else if (type === "salesProfit") {
      add = window.getPendingSalesProfit();
      label = "Sales Profit";
    } else if (type === "svcInv") {
      add = window.getPendingServiceInvestment();
      label = "Service Investment";
    } else if (type === "svcProfit") {
      add = window.getPendingServiceProfit();
      label = "Service Profit";
    }

    if (!add) {
      alert("Nothing pending to collect.");
      return;
    }

    if (!confirm(`Collect ‚Çπ${add} from ${label}?`)) return;

    if (type === "stockInv")       window.collected.stockInv   += add;
    else if (type === "salesProfit") window.collected.salesProfit += add;
    else if (type === "svcInv")    window.collected.svcInv     += add;
    else if (type === "svcProfit") window.collected.svcProfit  += add;

    saveCollected();
    window.renderProfitTab?.();
    window.renderAnalytics?.();
  }

  /* -----------------------------
     5) CLEAN SMART DASHBOARD (4 ITEMS)
     (OVERRIDES renderAnalytics)
  ----------------------------- */
  let cleanPieChart = null;

  window.renderAnalytics = function () {
    const profit =
      window.getPendingSalesProfit() +
      window.getPendingServiceProfit();

    const expenses = (window.expenses || [])
      .reduce((a, b) => a + Number(b.amount || 0), 0);

    const credit = (window.sales || [])
      .filter(s => String(s.status || "").toLowerCase() === "credit")
      .reduce((a, b) => a + Number(b.amount || 0), 0);

    const investment =
      window.getPendingStockInvestment() +
      window.getPendingServiceInvestment();

    // Top cards in Smart Dashboard
    qs("#dashProfit")   && (qs("#dashProfit").textContent   = "‚Çπ" + profit);
    qs("#dashExpenses") && (qs("#dashExpenses").textContent = "‚Çπ" + expenses);
    qs("#dashCredit")   && (qs("#dashCredit").textContent   = "‚Çπ" + credit);
    qs("#dashInv")      && (qs("#dashInv").textContent      = "‚Çπ" + investment);

    const canvas = document.getElementById("cleanPie");
    if (!canvas) return;

    const ctx = canvas.getContext("2d");
    if (cleanPieChart) cleanPieChart.destroy();

    cleanPieChart = new Chart(ctx, {
      type: "pie",
      data: {
        labels: ["Profit", "Expenses", "Credit Sales", "Investment"],
        datasets: [{
          data: [profit, expenses, credit, investment],
          backgroundColor: ["#2e7d32", "#c62828", "#1565c0", "#fbc02d"]
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: "bottom" }
        }
      }
    });
  };

  /* -----------------------------
     6) INIT + BUTTON EVENTS
  ----------------------------- */
  window.addEventListener("load", () => {
    loadCollected();

    // Profit tab buttons
    qs("#collectStockInvBtn")?.addEventListener("click", () =>
      collectAndRefresh("stockInv")
    );
    qs("#collectSalesProfitBtn2")?.addEventListener("click", () =>
      collectAndRefresh("salesProfit")
    );
    qs("#collectSvcInvBtn2")?.addEventListener("click", () =>
      collectAndRefresh("svcInv")
    );
    qs("#collectSvcProfitBtn2")?.addEventListener("click", () =>
      collectAndRefresh("svcProfit")
    );

    // First time render
    window.renderProfitTab?.();
    window.renderAnalytics?.();
  });

  // Whenever localStorage changes (stock/sales/service/expenses), update Profit tab
  window.addEventListener("storage", () => {
    window.renderProfitTab?.();
    window.renderAnalytics?.();
  });

})();
</script>
  <!-- üöÄ Collect Buttons Logic (Analytics Tab) -->
  <script>
    window.collected = {
      stockInv: 0,
      salesProfit: 0,
      svcInv: 0,
      svcProfit: 0
    };

    qs("#collectSalesInvBtn")?.addEventListener("click", () => {
      window.collected.stockInv += window.getSalesInvestmentCollected();
      alert("Stock Investment Collected!");
    });

    qs("#collectSalesProfitBtn")?.addEventListener("click", () => {
      window.collected.salesProfit += window.getSalesProfitCollected();
      alert("Sales Profit Collected!");
    });

    qs("#collectSvcInvBtn")?.addEventListener("click", () => {
      window.collected.svcInv += window.getServiceInvestmentCollected();
      alert("Service Investment Collected!");
    });

    qs("#collectSvcProfitBtn")?.addEventListener("click", () => {
      window.collected.svcProfit += window.getServiceProfitCollected();
      alert("Service Profit Collected!");
    });
  </script>

  <!-- üöÄ Profit Tab Logic -->
  <script>
    window.renderProfitTab = function () {
      qs("#pStockInv").textContent  = "‚Çπ" + (window.getStockInvestmentCollected() || 0);
      qs("#pSalesProfit").textContent = "‚Çπ" + (window.getSalesProfitCollected() || 0);
      qs("#pSvcInv").textContent   = "‚Çπ" + (window.getServiceInvestmentCollected() || 0);
      qs("#pSvcProfit").textContent = "‚Çπ" + (window.getServiceProfitCollected() || 0);
    };

    qs("#collectStockInvBtn")?.addEventListener("click", () => {
      if (confirm("Collect Stock Investment?")) {
        alert("Stock Investment Collected!");
        renderProfitTab();
      }
    });

    qs("#collectSalesProfitBtn2")?.addEventListener("click", () => {
      if (confirm("Collect Sales Profit?")) {
        alert("Sales Profit Collected!");
        renderProfitTab();
      }
    });

    qs("#collectSvcInvBtn2")?.addEventListener("click", () => {
      if (confirm("Collect Service Investment?")) {
        alert("Service Investment Collected!");
        renderProfitTab();
      }
    });

    qs("#collectSvcProfitBtn2")?.addEventListener("click", () => {
      if (confirm("Collect Service Profit?")) {
        alert("Service Profit Collected!");
        renderProfitTab();
      }
    });
  </script>
  <script>
  // Shortcuts ‚Äî REQUIRED
  const qs  = (s) => document.querySelector(s);
  const qsa = (s) => Array.from(document.querySelectorAll(s));
</script>

</body>
</html>
  
