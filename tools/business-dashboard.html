<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ğŸ“¦ KharchaSaathi â€” Business Dashboard (v2.2 Clean)</title>
  <meta name="theme-color" content="#ff7a00" />
  <link rel="icon" href="/favicon.png" />
  <link rel="apple-touch-icon" href="/favicon.png" />

  <style>
    :root{
      --orange:#ff7a00;
      --orange-dark:#cc6300;
      --bg:#f8f9fa;
      --card:#ffffff;
      --text:#222;
      --dark-bg:#0f0f0f;
      --dark-card:#1a1a1a;
      --dark-text:#f2f2f2;
      --dark-border:#333;
    }

    *{box-sizing:border-box;transition:background .18s,color .18s}
    body{
      margin:0;
      padding:18px;
      font-family:Poppins,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    body.dark{
      background:var(--dark-bg);
      color:var(--dark-text);
    }

    /* ---------- TOPBAR ---------- */
    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:12px
    }
    h1{
      margin:0;
      font-size:20px;
      color:var(--orange)
    }
    #emailTag{
      font-size:13px;
      opacity:.75;
      background:#eee;
      padding:4px 8px;
      border-radius:6px;
    }
    body.dark #emailTag{
      background:#222;
      color:#ddd;
    }

    /* ---------- CLOCK (12-hour clean) ---------- */
    .simple-clock{
      display:flex;
      flex-direction:column;
      line-height:1.1;
      padding:4px 0;
      min-width:95px;
    }
    .clock-line{
      font-family:monospace;
      font-size:14px;
      font-weight:700;
      color:var(--orange);
    }
    .clock-line.small{
      font-size:11px;
      opacity:0.75;
      color:var(--text);
    }
    body.dark .clock-line.small{
      color:#ddd;
    }

    /* ---------- BUTTONS ---------- */
    .theme-btn,.small-btn{
      background:var(--orange);
      color:#fff;
      border:none;
      padding:8px 10px;
      border-radius:8px;
      cursor:pointer
    }
    .theme-btn:hover,.small-btn:hover{
      background:var(--orange-dark)
    }

    /* ---------- TABS ---------- */
    .tabs{
      display:flex;
      gap:8px;
      margin:8px 0 16px;
      justify-content:center;
      flex-wrap:wrap;
    }
    .tab{
      background:#eee;
      padding:8px 12px;
      border-radius:10px;
      cursor:pointer;
      font-weight:600;
      white-space:nowrap
    }
    .tab.active{
      background:var(--orange);
      color:#fff
    }
    body.dark .tab{
      background:#222;
      color:#ccc
    }
    body.dark .tab.active{
      background:var(--orange-dark);
      color:#fff
    }

    /* ---------- SECTION ---------- */
    .section{
      display:none;
      background:var(--card);
      padding:14px;
      border-radius:12px;
      box-shadow:0 6px 20px rgba(0,0,0,0.05);
      margin-bottom:18px
    }
    .section.active{display:block}
    body.dark .section{
      background:var(--dark-card);
      border:1px solid var(--dark-border);
    }
  </style>
</head>

<body>

  <!-- ğŸ” TOPBAR -->
  <div class="topbar">
    <h1>ğŸ“¦ KharchaSaathi (Offline)</h1>

    <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
      <span id="emailTag">Loading...</span>

      <!-- SIMPLE CLOCK -->
      <div class="simple-clock">
        <span id="clockTime" class="clock-line">--:--:--</span>
        <span id="clockDate" class="clock-line small">--</span>
      </div>

      <button id="themeBtn" class="theme-btn">ğŸŒ™</button>
      <a class="small-btn" href="/index.html">ğŸ  Back</a>
      <button id="logoutBtn" class="small-btn" style="background:#e53935">ğŸ”“ Logout</button>
    </div>
  </div>

  <!-- ===== TABS (NO PROFIT TAB) ===== -->
  <div class="tabs" role="tablist">
    <div class="tab active" data-tab="types">ğŸ—‚ Types</div>
    <div class="tab" data-tab="stock">ğŸ“¦ Stock</div>
    <div class="tab" data-tab="sales">ğŸ“ˆ Sales</div>
    <div class="tab" data-tab="wanting">ğŸ›’ Wanting</div>
    <div class="tab" data-tab="service">ğŸ›  Service</div>
    <div class="tab" data-tab="dashboard">ğŸ“Š Overview</div>
    <div class="tab" data-tab="analytics">ğŸ“ˆ Smart Dashboard</div>
    <div class="tab" data-tab="expenses">ğŸ’¸ Expenses</div>
  </div>
  <!-- ===== TYPES ===== -->
  <section id="types" class="section active">
    <h3>ğŸ—‚ Manage Item Types</h3>

    <div class="row-inline" style="margin-top:8px">
      <input id="typeName" type="text" placeholder="Add new type" style="flex:1;min-width:160px">
      <button id="addTypeBtn" class="small-btn">Add</button>
      <button id="clearTypesBtn" class="small-btn">Clear All</button>
    </div>

    <ul id="typeList" style="margin-top:10px;padding-left:18px"></ul>
  </section>

  <!-- ===== STOCK ===== -->
  <section id="stock" class="section">
    <h3>ğŸ“¦ Current Stock</h3>

    <div class="row-inline" style="margin-top:6px">
      <label>Low Stock:</label>
      <input id="globalLimit" type="number" placeholder="2" style="width:80px">
      <button id="setLimitBtn" class="small-btn">Set</button>
      <button id="clearStockBtn" class="small-btn">Clear All</button>
    </div>

    <div class="row-inline" style="margin-top:12px">
      <input id="pdate" type="date">
      <select id="ptype"></select>
      <input id="pname" type="text" placeholder="Product">
      <input id="pqty" type="number" placeholder="Qty" style="width:80px">
      <input id="pcost" type="number" placeholder="Cost â‚¹" style="width:90px">
      <button id="addStockBtn" class="small-btn">Add</button>
    </div>

    <div style="margin-top:12px; display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
      <b>Filter Type:</b>
      <select id="filterType"><option value="all">All</option></select>

      <input id="productSearch"
             placeholder="Search product..."
             style="padding:6px; margin-left:10px;">
    </div>

    <!-- BEFORE SALE INVESTMENT -->
    <div id="stockInvBox" 
         style="margin-top:10px; padding:10px; background:#fff3e0; border-radius:8px;
                border:1px solid #ffbb66; max-width:260px; margin-left:auto;
                font-weight:600;">
      ğŸ“¦ Stock Investment (Before Sale): 
      <span id="stockInvValue" style="color:#ff6a00;">â‚¹0</span>
    </div>

    <table id="stockTable">
      <thead>
        <tr>
          <th>Date</th>
          <th>Type</th>
          <th>Product</th>
          <th>Qty</th>
          <th>Sold</th>
          <th>Remain</th>
          <th>Alert</th>
          <th>Limit</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- ===== SALES ===== -->
  <section id="sales" class="section">
    <h3>ğŸ’° Sales & Profit</h3>

    <div class="row-inline" style="margin:10px 0">
      <label>Date:</label>
      <input id="saleDate" type="date">

      <label style="margin-left:8px">Filter Type:</label>
      <select id="saleType">
        <option value="all">All Types</option>
      </select>

      <button id="filterSalesBtn" class="small-btn" style="margin-left:8px">Filter</button>

      <button id="clearSalesBtn" class="small-btn" 
        style="background:#c62828;color:#fff;margin-left:10px">ğŸ—‘ï¸ Clear All</button>
    </div>

    <table id="salesTable">
      <thead>
        <tr>
          <th>Date</th>
          <th>Type</th>
          <th>Product</th>
          <th>Qty</th>
          <th>Price</th>
          <th>Total</th>
          <th>Profit</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody></tbody>

      <tfoot>
        <tr>
          <td colspan="5" style="text-align:right">Total:</td>
          <td id="salesTotal">0</td>
          <td id="profitTotal">0</td>
          <td></td>
        </tr>
      </tfoot>
    </table>
  </section>

  <!-- ===== WANTING ===== -->
  <section id="wanting" class="section">
    <h3>ğŸ›’ Wanting List</h3>

    <div class="want-form">
      <select id="wantType"></select>
      <input id="wantName" type="text" placeholder="Product">
      <input id="wantNote" type="text" placeholder="Note">
      <button id="addWantBtn" class="small-btn">Add</button>
      <button id="clearWantBtn" class="small-btn">Clear</button>
      <button id="printWantBtn" class="small-btn">Print</button>
    </div>

    <table id="wantingTable">
      <thead>
        <tr>
          <th>Date</th>
          <th>Type</th>
          <th>Product</th>
          <th>Note</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- ===== SERVICE ===== -->
  <section id="service" class="section">
    <h3>ğŸ›  Service / Repair Manager</h3>

    <div class="row-inline" style="margin:10px 0;align-items:center;gap:10px">
      <input id="svcReceivedDate" type="date" style="width:160px">
      <input id="svcCustomer" type="text" placeholder="Customer name" style="min-width:160px">
      <input id="svcPhone" type="text" placeholder="Phone Number" style="width:140px">
      <select id="svcItemType" style="width:120px">
        <option value="Mobile">Mobile</option>
        <option value="Laptop">Laptop</option>
        <option value="Other">Other</option>
      </select>
      <input id="svcModel" type="text" placeholder="Model" style="min-width:130px">
      <input id="svcProblem" type="text" placeholder="Problem / Complaint" style="min-width:220px">
      <input id="svcAdvance" type="number" placeholder="Advance â‚¹ (0)" style="width:120px">
      <button id="addServiceBtn" class="small-btn">Add Job</button>
    </div>

    <div class="flex-row" style="margin:8px 0;">
      <div class="card"><small>Pending</small><div id="svcPendingCount">0</div></div>
      <div class="card"><small>Completed</small><div id="svcCompletedCount">0</div></div>
      <div class="card"><small>Total Repair Profit</small><div id="svcTotalProfit">â‚¹0</div></div>
    </div>

    <h4>Pending / Active Jobs</h4>
    <table id="svcTable">
      <thead>
        <tr>
          <th>Job ID</th>
          <th>Received</th>
          <th>Customer</th>
          <th>Phone</th>
          <th>Item</th>
          <th>Model</th>
          <th>Problem</th>
          <th>Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <button id="clearServiceBtn"
      class="small-btn"
      style="background:#b71c1c;color:white;margin:10px 0;">ğŸ—‘ï¸ Clear All Jobs</button>

    <h4 style="margin-top:14px">Completed / History</h4>
    <table id="svcHistoryTable">
      <thead>
        <tr>
          <th>Job ID</th>
          <th>Received</th>
          <th>Completed</th>
          <th>Customer</th>
          <th>Item</th>
          <th>Invest</th>
          <th>Paid</th>
          <th>Profit</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div style="max-width:520px;margin:14px auto;">
      <canvas id="svcPie" height="150"></canvas>
    </div>
  </section>

  <!-- ===== OVERVIEW ===== -->
  <section id="dashboard" class="section">
    <h3>ğŸ“Š Business Overview</h3>

    <div id="summaryCards" class="flex-row" style="margin-top:10px">

      <div class="card">
        <div style="font-size:26px">ğŸ’°</div>
        <b id="todaySales" style="font-size:20px;color:var(--orange)">â‚¹0</b><br>
        <small>Today's Sales</small>
      </div>

      <div class="card">
        <div style="font-size:26px">ğŸ’³</div>
        <b id="todayCredit" style="font-size:20px;color:var(--orange)">â‚¹0</b><br>
        <small>Today's Credit</small>
      </div>

      <div class="card">
        <div style="font-size:26px">ğŸ§¾</div>
        <b id="todayExpenses" style="font-size:20px;color:var(--orange)">â‚¹0</b><br>
        <small>Today's Expenses</small>
      </div>

      <div class="card">
        <div style="font-size:26px">ğŸ“ˆ</div>
        <b id="todayGross" style="font-size:20px;color:var(--orange)">â‚¹0</b><br>
        <small>Today's Gross Profit</small>
      </div>

      <div class="card">
        <div style="font-size:26px">ğŸ’¹</div>
        <b id="todayNet" style="font-size:20px;color:var(--orange)">â‚¹0</b><br>
        <small>Today's NET Profit</small>
      </div>

    </div>
  </section>

  <!-- ===== SMART DASHBOARD ===== -->
  <section id="analytics" class="section">
    <h3>ğŸ“ˆ Smart Dashboard</h3>

    <div class="flex-row" style="margin-bottom:18px">
      <div class="card" style="flex:1;min-width:160px">
        <h4>Total Profit</h4>
        <b id="dashProfit" style="font-size:22px;color:#2e7d32">â‚¹0</b>
      </div>

      <div class="card" style="flex:1;min-width:160px">
        <h4>Total Expenses</h4>
        <b id="dashExpenses" style="font-size:22px;color:#c62828">â‚¹0</b>
      </div>

      <div class="card" style="flex:1;min-width:160px">
        <h4>Credit Sales</h4>
        <b id="dashCredit" style="font-size:22px;color:#1565c0">â‚¹0</b>
      </div>

      <div class="card" style="flex:1;min-width:160px">
        <h4>Total Investment</h4>
        <b id="dashInv" style="font-size:22px;color:#fbc02d">â‚¹0</b>
      </div>
    </div>

    <div style="max-width:600px;margin:auto;">
      <canvas id="cleanPie" height="150"></canvas>
    </div>
  </section>

  <!-- ===== EXPENSES ===== -->
  <section id="expenses" class="section">
    <h3>ğŸ§¾ Expenses</h3>

    <div class="row-inline" style="margin-bottom:8px">
      <input id="expDate" type="date" onfocus="if(!this.value)this.value=todayDate()">
      <input id="expCat" type="text" placeholder="Category" style="min-width:140px">
      <input id="expAmount" type="number" placeholder="Amount" style="width:120px">
      <input id="expNote" type="text" placeholder="Note" style="min-width:200px">
      <button id="addExpenseBtn" class="small-btn">Add Expense</button>
    </div>

    <table id="expensesTable">
      <thead>
        <tr>
          <th>Date</th>
          <th>Category</th>
          <th>Amount</th>
          <th>Note</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>

      <tfoot>
        <tr>
          <td colspan="2" style="text-align:right">Total:</td>
          <td id="expTotal">0</td>
          <td></td>
          <td></td>
        </tr>
      </tfoot>
    </table>
  </section>
  <!-- ========== JS LOGIC (BASE) ========== -->
  <script>
    const qs  = s => document.querySelector(s);
    const qsa = s => Array.from(document.querySelectorAll(s));

    /* ---------- HELP MODAL ---------- */
    function toggleHelp(){
      const m = qs('#helpModal');
      if (!m) return;
      m.style.display = (m.style.display==='flex' ? 'none' : 'flex');
    }
    qs('#helpLink')?.addEventListener('click', e=>{
      e.preventDefault();
      toggleHelp();
    });

    /* ---------- DATE HELPERS ---------- */
    window.toDisplay = function(d) {
      if (!d) return "";
      if (d.includes("-")) {
        const [y,m,dd] = d.split("-");
        if (y.length === 4) return `${dd}-${m}-${y}`;
      }
      return d;
    };
    window.toInternal = function(d) {
      if (!d) return "";
      if (d.includes("-")) {
        const p = d.split("-");
        if (p[0].length === 2) {
          const [dd,m,y] = p;
          return `${y}-${m}-${dd}`;
        }
      }
      return d;
    };

    /* ---------- THEME SWITCHER ---------- */
    if (localStorage.getItem('ks-theme') === 'dark') {
      document.body.classList.add('dark');
    }
    qs('#themeBtn')?.addEventListener('click', () => {
      const d = document.body.classList.toggle('dark');
      localStorage.setItem('ks-theme', d ? 'dark' : 'light');
    });

    /* ---------- LIVE CLOCK (12-HOUR FORMAT) ---------- */
    function startLiveClock(){
      const tEl = qs("#clockTime");
      const dEl = qs("#clockDate");
      if (!tEl || !dEl) return;

      function tick(){
        const now = new Date();
        let hh = now.getHours();
        const mm = String(now.getMinutes()).padStart(2,"0");
        const ss = String(now.getSeconds()).padStart(2,"0");

        const ampm = hh >= 12 ? "PM" : "AM";
        hh = hh % 12;
        if (hh === 0) hh = 12;

        tEl.textContent = `${hh}:${mm}:${ss} ${ampm}`;

        const day = String(now.getDate()).padStart(2,"0");
        const month = String(now.getMonth()+1).toString().padStart(2,"0");
        const year = now.getFullYear();
        dEl.textContent = `${day}-${month}-${year}`;
      }

      tick();
      setInterval(tick, 1000);
    }

    /* ---------- TABS ---------- */
    (function () {
      const tabs = qsa('.tab'),
            sections = qsa('.section');

      function activate(name) {
        tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === name));
        sections.forEach(s => s.classList.toggle('active', s.id === name));

        if (name === 'types')     renderTypes?.();
        if (name === 'stock')     { updateTypeDropdowns?.(); renderStock?.(); }
        if (name === 'sales')     { refreshSaleTypeSelector?.(); renderSales?.(); }
        if (name === 'wanting')   renderWanting?.();
        if (name === 'dashboard') updateSummaryCards?.();
        if (name === 'analytics') renderAnalytics?.();
        if (name === 'expenses')  renderExpenses?.();
        if (name === 'service')   renderServiceTables?.();
      }

      tabs.forEach(t =>
        t.addEventListener('click', () => activate(t.dataset.tab))
      );

      window.activateTab = activate;
    })();

    /* ---------- LOGIN / EMAIL ---------- */
    window.addEventListener("load", () => {

      if (typeof isLoggedIn === "function" && !isLoggedIn()) {
        window.location.href = "/login.html";
        return;
      }

      const tag = qs("#emailTag");
      if (tag && typeof getUserEmail === "function") {
        const mail = getUserEmail();
        tag.textContent = "Logged in: " + (mail || "Unknown User");
      }

      qs("#logoutBtn")?.addEventListener("click", () => {
        if (typeof logoutUser === "function") logoutUser();
        window.location.href = "/login.html";
      });
    });

    /* ---------- STOCK FILTER ---------- */
    qs("#filterType")?.addEventListener("change", () => {
      refreshSaleTypeSelector?.();
      renderStock?.();
    });

    /* ---------- SALES LIVE FILTERS ---------- */
    (function attachSalesInputs() {
      if (typeof attachImmediateSalesFilters === "function") {
        try { attachImmediateSalesFilters(); } catch (e) {}
      } else {
        qs("#saleType")?.addEventListener("change", () => renderSales?.());
        qs("#saleDate")?.addEventListener("change", () => renderSales?.());
        qs("#filterSalesBtn")?.addEventListener("click", () => renderSales?.());
      }
    })();

    /* ---------- OVERVIEW SUMMARY ---------- */
    function updateSummaryCards() {
      if (typeof getAnalyticsData !== "function") return;
      const data = getAnalyticsData();

      qs("#todaySales").textContent    = "â‚¹" + data.todaySales;
      qs("#todayCredit").textContent   = "â‚¹" + data.creditSales;
      qs("#todayExpenses").textContent = "â‚¹" + data.todayExpenses;
      qs("#todayGross").textContent    = "â‚¹" + data.grossProfit;
      qs("#todayNet").textContent      = "â‚¹" + data.netProfit;
    }
    window.updateSummaryCards = updateSummaryCards;

    /* ---------- SAFE INITIAL RENDER ---------- */
    function safeInitialRender() {
      try { renderTypes?.(); } catch {}
      try { updateTypeDropdowns?.(); } catch {}
      try { renderStock?.(); } catch {}
      try { refreshSaleTypeSelector?.(); } catch {}
      try { renderSales?.(); } catch {}
      try { renderWanting?.(); } catch {}
      try { renderExpenses?.(); } catch {}
      try { renderServiceTables?.(); } catch {}
      try { renderAnalytics?.(); } catch {}
      try { updateSummaryCards?.(); } catch {}
      try { startLiveClock(); } catch {}
    }

    window.addEventListener("load", () => {
      setTimeout(safeInitialRender, 80);
    });
  </script>

  <!-- LIBRARIES -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.umd.min.js"></script>

  <!-- FIREBASE -->
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore-compat.js"></script>

  <!-- AUTO VERSION LOADER (DO NOT TOUCH) -->
  <script>
  (function(){
    const v = Date.now();
    const js = [
      "/js/core.js",
      "/js/firebase.js",
      "/js/types.js",
      "/js/stock.js",
      "/js/sales.js",
      "/js/wanting.js",
      "/js/expenses.js",
      "/js/analytics.js",
      "/js/service.js",
      "/js/security.js"
    ];
    js.forEach(f => {
      document.write(`<script src="${f}?v=${v}"><\/script>`);
    });
  })();
  </script>
  </body>
</html>
