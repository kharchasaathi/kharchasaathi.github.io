<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ğŸ“¦ KharchaSaathi â€” Business Dashboard (Optimized)</title>

  <!-- Theme color for mobile -->
  <meta name="theme-color" content="#ff7a00">
  <link rel="icon" href="../favicon.png">
  <link rel="apple-touch-icon" href="../favicon.png">

  <!-- ğŸŒˆ MAIN STYLE -->
  <style>
    :root {
      --orange: #ff7a00;
      --orange-dark: #cc6300;
      --bg: #f8f9fa;
      --card: #fff;
      --text: #222;
      --dark-bg: #0f0f0f;
      --dark-card: #1b1b1b;
      --dark-text: #f2f2f2;
      --dark-border: #444;
    }

    /* Base resets */
    * {
      box-sizing: border-box;
      transition: background 0.2s, color 0.2s;
    }

    /* Body */
    body {
      font-family: Poppins, Arial, sans-serif;
      margin: 0;
      padding: 18px;
      background: var(--bg);
      color: var(--text);
    }
    body.dark {
      background: var(--dark-bg);
      color: var(--dark-text);
    }

    /* Headings */
    h1 {
      color: var(--orange);
      margin: 0;
      font-size: 20px;
    }

    /* Topbar */
    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 14px;
    }

    /* Buttons */
    .theme-btn, .small-btn {
      background: var(--orange);
      color: #fff;
      border: none;
      padding: 8px 10px;
      border-radius: 8px;
      cursor: pointer;
      transition: 0.15s;
    }
    .theme-btn:hover, .small-btn:hover {
      background: var(--orange-dark);
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 8px;
      margin: 6px 0 18px;
      justify-content: center;
      flex-wrap: nowrap;
      overflow-x: auto;
      scrollbar-width: none;
    }
    .tabs::-webkit-scrollbar { display: none; }

    .tab {
      background: #eee;
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      white-space: nowrap;
    }
    body.dark .tab {
      background: #222;
      color: #ccc;
    }
    .tab.active {
      background: var(--orange);
      color: #fff;
    }

    /* Section container */
    .section {
      display: none;
      background: var(--card);
      padding: 14px;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.06);
      margin-bottom: 18px;
    }
    .section.active { display: block; }
    body.dark .section {
      background: var(--dark-card);
      border: 1px solid var(--dark-border);
      color: var(--dark-text);
    }

    /* Summary Cards */
    #summaryCards {
      display: flex;
      flex-wrap: wrap;
      justify-content: flex-end; /* right align */
      text-align: right;
      gap: 10px;
    }
    #summaryCards .card {
      text-align: right;
      border-radius: 12px;
      padding: 12px;
    }
    #summaryCards .card small {
      font-size: 13px;
      opacity: 0.8;
    }

    /* Table Styling */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 14px;
      border-radius: 10px;
      overflow: hidden;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px 10px;
      text-align: center;
      font-size: 14px;
    }
    th {
      background: var(--orange);
      color: #fff;
      font-weight: 600;
      letter-spacing: 0.3px;
    }
    body.dark th { background: var(--orange-dark); }
    tr:nth-child(even) { background: #fdfdfd; }
    body.dark tr:nth-child(even) { background: #1f1f1f; }
    tr:hover {
      background: #fff3e0;
      transition: 0.2s;
    }
    body.dark tr:hover { background: #2a2a2a; }

    /* Status Colors */
    .ok { color: #43a047; font-weight: 600; }
    .low { color: #ffa726; font-weight: 600; }
    .out { color: #e53935; font-weight: 700; }

    /* Footer Buttons */
    .footer-btns {
      text-align: center;
      margin-top: 20px;
    }
    .footer-btns a {
      background: var(--orange);
      color: #fff;
      padding: 10px 16px;
      border-radius: 8px;
      text-decoration: none;
      margin: 6px;
      display: inline-block;
    }
    .footer-btns a:hover { background: var(--orange-dark); }

    /* Help Modal */
    .help-modal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      transition: opacity 0.3s ease;
    }
    .help-content {
      background: var(--card);
      padding: 24px;
      max-width: 640px;
      width: 90%;
      border-radius: 14px;
      color: var(--text);
      overflow-y: auto;
      max-height: 85vh;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    }
    body.dark .help-content {
      background: var(--dark-card);
      color: var(--dark-text);
      box-shadow: 0 8px 24px rgba(255,255,255,0.1);
    }
  </style>
</head>

<body>
  <!-- ğŸ” Topbar -->
  <div class="topbar">
    <h1>ğŸ“¦ KharchaSaathi (Offline)</h1>
    <div style="display:flex;gap:8px;align-items:center">
      <button class="theme-btn" id="themeBtn">ğŸŒ™</button>
      <a class="small-btn" href="../index.html">ğŸ  Back</a>
    </div>
  </div>

  <!-- ğŸ§­ Tabs -->
  <div class="tabs" role="tablist">
    <div class="tab active" data-tab="dashboard">ğŸ“Š Overview</div>
    <div class="tab" data-tab="types">ğŸ—‚ Types</div>
    <div class="tab" data-tab="stock">ğŸ“¦ Stock</div>
    <div class="tab" data-tab="sales">ğŸ’° Sales</div>
    <div class="tab" data-tab="wanting">ğŸ›’ Wanting</div>
    <div class="tab" data-tab="analytics">ğŸ“ˆ Smart Dashboard</div>
  </div>
  <!-- ===== ğŸ§© PART 1 : OVERVIEW / DASHBOARD ===== -->
  <section id="dashboard" class="section active">
    <h3>ğŸ“Š Business Overview</h3>

    <div id="summaryCards">
      <div class="card" style="flex:1;min-width:140px;background:#fff3e0;">
        <div>ğŸ’°</div>
        <b id="todaySales">â‚¹0</b><br><small>Today's Sales</small>
      </div>
      <div class="card" style="flex:1;min-width:140px;background:#e3f2fd;">
        <div>ğŸ’³</div>
        <b id="todayCredit">â‚¹0</b><br><small>Today's Credit</small>
      </div>
      <div class="card" style="flex:1;min-width:140px;background:#e8f5e9;">
        <div>ğŸ“¦</div>
        <b id="stockRemain">0%</b><br><small>Stock Remaining</small>
      </div>
      <div class="card" style="flex:1;min-width:140px;background:#fffde7;">
        <div>ğŸ“ˆ</div>
        <b id="todayProfit">â‚¹0</b><br><small>Today's Profit</small>
      </div>
    </div>
  </section>

  <!-- ===== ğŸ—‚ PART 2 : TYPES ===== -->
  <section id="types" class="section">
    <h3>ğŸ—‚ Manage Item Types</h3>
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <input type="text" id="typeName" placeholder="Add new type (e.g. Mobiles, Accessories)" style="flex:1;min-width:200px">
      <button id="addTypeBtn" class="small-btn">Add</button>
      <button id="clearTypesBtn" class="small-btn">Clear All</button>
    </div>
    <ul id="typeList" style="margin-top:10px;padding-left:18px"></ul>
  </section>

  <!-- ===== ğŸ“¦ PART 3 : STOCK ===== -->
  <section id="stock" class="section">
    <h3>ğŸ“¦ Current Stock</h3>

    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <label>Low Stock Limit:</label>
      <input type="number" id="globalLimit" placeholder="e.g. 2" style="width:100px">
      <button id="setLimitBtn" class="small-btn">Set</button>
      <button id="clearStockBtn" class="small-btn">Clear All</button>
    </div>

    <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <input type="date" id="pdate" style="min-width:150px">
      <select id="ptype" style="min-width:140px"></select>
      <input type="text" id="pname" placeholder="Product name" style="min-width:160px">
      <input type="number" id="pqty" placeholder="Qty" style="width:80px">
      <input type="number" id="pcost" placeholder="Cost â‚¹" style="width:100px">
      <button id="addStockBtn" class="small-btn">Add</button>
    </div>

    <div style="margin-top:12px">
      <label><b>Filter by Type:</b></label>
      <select id="filterType" style="min-width:160px">
        <option value="all">All Types</option>
      </select>
    </div>

    <table id="stockTable">
      <thead>
        <tr>
          <th>Date</th><th>Type</th><th>Product</th><th>Qty</th>
          <th>Sold</th><th>Remain</th><th>Alert</th><th>Limit</th><th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>
  <!-- ===== ğŸ’° PART 4 : SALES & PROFIT ===== -->
  <section id="sales" class="section">
    <h3>ğŸ’° Sales & Profit</h3>

    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:10px;">
      <label>Sale Date:</label>
      <input type="date" id="saleDate" style="min-width:150px">
      <label>Type</label>
      <select id="saleType" style="min-width:140px"></select>
      <label>Product</label>
      <select id="saleProduct" style="min-width:180px"></select>
      <input type="number" id="saleQty" placeholder="Qty" style="width:80px">
      <input type="number" id="salePrice" placeholder="Sale â‚¹" style="width:100px">
      <select id="saleStatus" style="min-width:100px">
        <option value="Paid">Paid</option>
        <option value="Credit">Credit</option>
      </select>
      <button id="addSaleBtn" class="small-btn">Add Sale</button>
    </div>

    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:8px;">
      <label>GST?</label>
      <input type="checkbox" id="includeGst">
      <input type="number" id="gstPercent" placeholder="GST %" style="width:80px" value="0">
      <button id="viewSalesBtn" class="small-btn">View by Date</button>
      <button id="printSalesBtn" class="small-btn">Print</button>

      <!-- Admin controls for profit column -->
      <div style="margin-left:auto;display:flex;gap:8px;align-items:center;">
        <button id="toggleProfitBtn" class="small-btn">ğŸ”’ Lock/Unlock Profit</button>
        <button id="setAdminBtn" class="small-btn">Set Admin PW</button>
      </div>
    </div>

    <table id="salesTable" aria-label="Sales table">
      <thead>
        <tr>
          <th>Date</th><th>Type</th><th>Product</th><th>Qty</th>
          <th>Price â‚¹</th><th>Total â‚¹</th><th>Profit â‚¹</th><th>Status</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr>
          <td colspan="5" style="text-align:right">Total:</td>
          <td id="salesTotal">0</td>
          <td id="profitTotal">0</td>
          <td></td>
        </tr>
      </tfoot>
    </table>
  </section>

  <!-- ===== ğŸ§¾ PART 5 : HELP ===== -->
  <div class="footer-btns">
    <a href="#" id="helpLink">ğŸ“˜ Help & Guide</a>
  </div>

  <!-- Help Modal -->
  <div id="helpModal" class="help-modal">
    <div class="help-content">
      <h2>ğŸ“˜ Quick Help</h2>
      <ul style="padding-left:18px;line-height:1.6">
        <li>ğŸ—‚ Manage <b>Item Types</b></li>
        <li>ğŸ“¦ Add & manage <b>Stock</b></li>
        <li>ğŸ’° Record <b>Sales & Profit</b></li>
        <li>ğŸ›’ Auto Wanting when stock ends</li>
        <li>â˜ï¸ Data saved offline in your browser</li>
      </ul>
      <button class="small-btn" onclick="toggleHelp()">Close</button>
    </div>
  </div>

  <!-- ===== âš™ï¸ LOGIC SCRIPTS ===== -->
  <script>
  /* ğŸŒ™ Theme Toggle */
  if (localStorage.getItem('ks-theme') === 'dark') {
    document.body.classList.add('dark');
  }
  document.getElementById('themeBtn').onclick = () => {
    document.body.classList.toggle('dark');
    localStorage.setItem('ks-theme',
      document.body.classList.contains('dark') ? 'dark' : 'light'
    );
  };

  /* ğŸ“˜ Help Modal */
  function toggleHelp() {
    const modal = document.getElementById('helpModal');
    modal.style.display = modal.style.display === 'flex' ? 'none' : 'flex';
  }
  document.getElementById('helpLink').onclick = e => {
    e.preventDefault();
    toggleHelp();
  };

  /* ğŸ§  Tabs Switching */
  const tabs = document.querySelectorAll('.tab');
  const sections = document.querySelectorAll('.section');

  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      tabs.forEach(t => t.classList.remove('active'));
      sections.forEach(s => s.classList.remove('active'));

      tab.classList.add('active');
      const target = document.getElementById(tab.dataset.tab);
      if (target) target.classList.add('active');

      switch (tab.dataset.tab) {
        case 'dashboard':
          if (typeof updateSummaryCards === 'function') updateSummaryCards();
          break;
        case 'types':
          renderTypes();
          updateDropdowns();
          break;
        case 'stock':
          renderStock();
          break;
        case 'analytics':
          if (typeof renderAnalytics === 'function') renderAnalytics();
          break;
      }
    });
  });
  </script>

  <!-- ===== ğŸ”¢ TYPES + STOCK LOGIC ===== -->
  <script>
  const K_TYPES = 'item-types';
  const K_STOCK = 'stock-data';
  const K_LIMIT = 'default-limit';

  window.types = JSON.parse(localStorage.getItem(K_TYPES) || '["Mobiles","Accessories"]');
  window.stock = JSON.parse(localStorage.getItem(K_STOCK) || '[]');

  function saveAll() {
    localStorage.setItem(K_TYPES, JSON.stringify(types));
    localStorage.setItem(K_STOCK, JSON.stringify(stock));
  }

  function renderTypes() {
    const list = document.getElementById('typeList');
    if (!list) return;
    list.innerHTML = types.map(t => `<li>${t}</li>`).join('');
  }

  function updateDropdowns() {
    ['ptype', 'filterType'].forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      const base = id === 'filterType'
        ? '<option value="all">All Types</option>'
        : '<option value="">Select</option>';
      el.innerHTML = base + types.map(t => `<option value="${t}">${t}</option>`).join('');
    });
  }

  function addType() {
    const t = document.getElementById('typeName').value.trim();
    if (!t) return alert('Enter a type name');
    if (types.includes(t)) return alert('Type already exists');
    types.push(t);
    saveAll();
    renderTypes();
    updateDropdowns();
    document.getElementById('typeName').value = '';
  }

  function clearTypes() {
    if (confirm('Clear all types?')) {
      types = [];
      saveAll();
      renderTypes();
      updateDropdowns();
    }
  }

  function setGlobalLimit() {
    const v = parseInt(document.getElementById('globalLimit').value);
    if (isNaN(v) || v < 0) return alert('Invalid number');
    localStorage.setItem(K_LIMIT, v);
    alert('Limit set: ' + v);
  }

  function getLimit() {
    const v = parseInt(localStorage.getItem(K_LIMIT));
    return isNaN(v) ? 0 : v;
  }

  function addStock() {
    const d = document.getElementById('pdate').value;
    const t = document.getElementById('ptype').value;
    const n = document.getElementById('pname').value.trim();
    const q = parseInt(document.getElementById('pqty').value);
    const c = parseFloat(document.getElementById('pcost').value);
    if (!d || !t || !n || !q || !c) return alert('Please fill all fields');

    let ex = stock.find(s => s.type === t && s.name.toLowerCase() === n.toLowerCase());
    if (ex) {
      ex.qty += q;
      ex.date = d;
      ex.cost = c;
      ex.history = ex.history || [];
      ex.history.push({ date: d, qty: q, cost: c });
    } else {
      stock.push({ date: d, type: t, name: n, qty: q, sold: 0, cost: c, history: [{ date: d, qty: q, cost: c }] });
    }
    saveAll();
    renderStock();
    document.getElementById('pname').value = '';
    document.getElementById('pqty').value = '';
    document.getElementById('pcost').value = '';
  }

  function renderStock() {
    const f = document.getElementById('filterType').value;
    const tb = document.querySelector('#stockTable tbody');
    if (!tb) return;
    tb.innerHTML = stock
      .filter(s => f === 'all' || s.type === f)
      .map((s, i) => {
        const sold = s.sold || 0;
        const rem = s.qty - sold;
        const lim = getLimit();
        let cls = 'ok', msg = 'OK';
        if (rem <= 0) { cls = 'out'; msg = 'OUT'; }
        else if (rem <= lim) { cls = 'low'; msg = 'LOW'; }
        return `<tr>
          <td>${s.date}</td><td>${s.type}</td><td>${s.name}</td>
          <td>${s.qty}</td><td>${sold}</td><td>${rem}</td>
          <td class="${cls}">${msg}</td><td>${lim}</td>
          <td><button onclick="viewHistory(${i})">ğŸ“œ</button></td>
        </tr>`;
      })
      .join('') || '<tr><td colspan="9">No Data</td></tr>';
  }

  function viewHistory(i) {
    const s = stock[i];
    if (!s || !s.history) return alert('No history available');
    const list = s.history.map(h => `${h.date} â€” Qty: ${h.qty} @â‚¹${h.cost}`).join('\n');
    alert(`ğŸ“œ ${s.name} History:\n${list}`);
  }

  document.addEventListener('click', e => {
    switch (e.target.id) {
      case 'addTypeBtn': addType(); break;
      case 'clearTypesBtn': clearTypes(); break;
      case 'setLimitBtn': setGlobalLimit(); break;
      case 'clearStockBtn':
        if (confirm('Clear all stock?')) {
          stock = [];
          saveAll();
          renderStock();
        }
        break;
      case 'addStockBtn': addStock(); break;
    }
  });

  document.getElementById('filterType')?.addEventListener('change', renderStock);

  window.addEventListener('load', () => {
    renderTypes();
    updateDropdowns();
    renderStock();
  });
  </script>
  <!-- ===== PART 4 : SMART SALES DASHBOARD (Chart.js) ===== -->
<!-- Include Chart.js CDN (only once) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Analytics Section (should already exist in your HTML as a section with id="analytics")
     If you already have the section HTML, keep it â€” this script will only control rendering. -->
<style>
  /* small safety styles for canvas sizing */
  #analytics .chart-wrap { display:flex; gap:20px; flex-wrap:wrap; justify-content:flex-end; align-items:center; }
  #analytics canvas { width:100% !important; max-width:460px; height:260px !important; }
</style>

<script>
/* ===== Smart Dashboard: Data + Charts ===== */

/* helper: gather numeric sales stats */
function getSalesData() {
  const sales = JSON.parse(localStorage.getItem('sales-data') || '[]');
  const today = new Date();
  const todayStr = today.toISOString().split('T')[0];

  // startOfWeek = Sunday (0) to today
  const startOfWeek = new Date(today);
  startOfWeek.setHours(0,0,0,0);
  startOfWeek.setDate(today.getDate() - today.getDay());

  // startOfMonth
  const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
  startOfMonth.setHours(0,0,0,0);

  let todaySales = 0, weekSales = 0, monthSales = 0;
  let creditSales = 0, paidSales = 0, totalProfit = 0;

  sales.forEach(s => {
    const amt = Number(s.amount || 0);
    const prof = Number(s.profit || 0);
    const d = new Date(s.date);

    if (s.date === todayStr) todaySales += amt;
    if (d >= startOfWeek) weekSales += amt;
    if (d >= startOfMonth) monthSales += amt;

    if (s.status === 'Credit') creditSales += amt; else paidSales += amt;
    totalProfit += prof;
  });

  // round
  return {
    todaySales: Math.round(todaySales*100)/100,
    weekSales: Math.round(weekSales*100)/100,
    monthSales: Math.round(monthSales*100)/100,
    creditSales: Math.round(creditSales*100)/100,
    paidSales: Math.round(paidSales*100)/100,
    totalProfit: Math.round(totalProfit*100)/100
  };
}

/* chart instances stored on window for safe destruction */
window.salesBarChart = window.salesBarChart || null;
window.salesPieChart = window.salesPieChart || null;

/* render analytics charts - id's: salesBar (bar) and salesPie (pie) */
function renderAnalytics() {
  // find canvases
  const barCanvas = document.getElementById('salesBar');
  const pieCanvas = document.getElementById('salesPie');
  if (!barCanvas || !pieCanvas) return;

  const data = getSalesData();

  // destroy previous charts if exist
  try { if (window.salesBarChart) { window.salesBarChart.destroy(); window.salesBarChart = null; } } catch(e){}
  try { if (window.salesPieChart) { window.salesPieChart.destroy(); window.salesPieChart = null; } } catch(e){}

  // BAR: Today / This Week / This Month
  window.salesBarChart = new Chart(barCanvas, {
    type: 'bar',
    data: {
      labels: ['Today', 'This Week', 'This Month'],
      datasets: [{
        label: 'Sales â‚¹',
        data: [data.todaySales, data.weekSales, data.monthSales],
        // Chart.js will use default colors if none specified â€” that's fine
        borderRadius: 6
      }]
    },
    options: {
      plugins: {
        title: { display: true, text: 'Sales Summary' },
        legend: { display: false }
      },
      scales: {
        y: { beginAtZero: true }
      },
      maintainAspectRatio: false
    }
  });

  // PIE: Paid vs Credit
  window.salesPieChart = new Chart(pieCanvas, {
    type: 'pie',
    data: {
      labels: ['Paid Sales', 'Credit Sales'],
      datasets: [{
        data: [data.paidSales, data.creditSales]
      }]
    },
    options: {
      plugins: {
        title: { display: true, text: `Total Profit â‚¹${(data.totalProfit || 0).toFixed(2)}` },
        legend: { position: 'bottom' }
      },
      maintainAspectRatio: false
    }
  });
}

/* Only render charts when "analytics" tab becomes active.
   We already wired tabs to call renderAnalytics() when dataset.tab === 'analytics' in your tab handler.
   But to be safe (in case user navigates directly), render on load if analytics is active. */
window.addEventListener('load', () => {
  // small delay to ensure DOM canvases exist
  setTimeout(() => {
    const analyticsSection = document.getElementById('analytics');
    if (analyticsSection && analyticsSection.classList.contains('active')) {
      renderAnalytics();
    }
  }, 120);

  // also refresh charts when storage changes (another tab / save)
  window.addEventListener('storage', (e) => {
    if (e.key === 'sales-data' || e.key === 'stock-data' || e.key === 'item-types') {
      // refresh only if analytics currently visible
      const analyticsSection = document.getElementById('analytics');
      if (analyticsSection && analyticsSection.classList.contains('active')) {
        renderAnalytics();
      }
    }
  });

  // optional: refresh charts every 60s only when analytics visible
  setInterval(() => {
    const analyticsSection = document.getElementById('analytics');
    if (analyticsSection && analyticsSection.classList.contains('active')) {
      renderAnalytics();
    }
  }, 60000);
});

/* Small helper: updateSummaryCards function (keeps the Overview cards fresh) */
function updateSummaryCards(){
  const today = new Date().toISOString().split('T')[0];
  const sales = JSON.parse(localStorage.getItem('sales-data')||'[]');
  const stock = JSON.parse(localStorage.getItem('stock-data')||'[]');

  let todaySales = 0, todayCredit = 0, todayProfit = 0;
  sales.forEach(s=>{
    if(s.date===today){
      if(s.status==='Paid') todaySales += Number(s.amount || 0);
      if(s.status==='Credit') todayCredit += Number(s.amount || 0);
      todayProfit += Number(s.profit || 0);
    }
  });

  const totalQty = stock.reduce((a,b)=>a+(Number(b.qty||0)),0);
  const soldQty = stock.reduce((a,b)=>a+(Number(b.sold||0)),0);
  const remainPct = totalQty>0?Math.round(((totalQty-soldQty)/totalQty)*100):0;

  const elTodaySales = document.getElementById('todaySales');
  const elTodayCredit = document.getElementById('todayCredit');
  const elTodayProfit = document.getElementById('todayProfit');
  const elStockRemain = document.getElementById('stockRemain');

  if(elTodaySales) elTodaySales.textContent = 'â‚¹'+(Math.round(todaySales*100)/100).toFixed(2);
  if(elTodayCredit) elTodayCredit.textContent = 'â‚¹'+(Math.round(todayCredit*100)/100).toFixed(2);
  if(elTodayProfit) elTodayProfit.textContent = 'â‚¹'+(Math.round(todayProfit*100)/100).toFixed(2);
  if(elStockRemain) elStockRemain.textContent = remainPct+'%';
}

/* call once on load to initialize summary cards */
window.addEventListener('load', () => {
  updateSummaryCards();
});
  <!-- ===== âœ… FINAL APP INITIALIZATION & SAFE EXIT ===== -->
<script>
/* ğŸš€ Final init â€” ensure all summary + charts update once */
window.addEventListener("load", () => {
  try { if (typeof updateSummaryCards === "function") updateSummaryCards(); } catch(e){}
  try { if (typeof renderAnalytics === "function") renderAnalytics(); } catch(e){}
});

/* ğŸ§¹ Optional cleanup: stop intervals when tab hidden (saves battery on mobile) */
let dashInterval = null;
document.addEventListener("visibilitychange", () => {
  if (document.hidden) {
    if (dashInterval) { clearInterval(dashInterval); dashInterval = null; }
  } else {
    if (!dashInterval && typeof renderAnalytics === "function") {
      dashInterval = setInterval(() => {
        const active = document.querySelector(".tab.active");
        if (active && active.dataset.tab === "analytics") renderAnalytics();
      }, 60000);
    }
  }
});

/* ğŸ’¾ Before unload â€” auto-save to localStorage (failsafe) */
window.addEventListener("beforeunload", () => {
  try {
    if (typeof saveAll === "function") saveAll();
    if (typeof saveSales === "function") saveSales();
  } catch (e) { console.warn("Auto-save skipped:", e); }
});

/* ğŸ‰ Console confirmation */
console.log("%cKharchaSaathi Dashboard Loaded Successfully âœ…", "color: #ff7a00; font-weight: bold;");
</script>

</body>
</html>
